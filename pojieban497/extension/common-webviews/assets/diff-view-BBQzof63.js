var mo=Object.defineProperty;var Mn=r=>{throw TypeError(r)};var _o=(r,t,e)=>t in r?mo(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var l=(r,t,e)=>_o(r,typeof t!="symbol"?t+"":t,e),di=(r,t,e)=>t.has(r)||Mn("Cannot "+e);var d=(r,t,e)=>(di(r,t,"read from private field"),e?e.call(r):t.get(r)),V=(r,t,e)=>t.has(r)?Mn("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(r):t.set(r,e),D=(r,t,e,s)=>(di(r,t,"write to private field"),s?s.call(r,e):t.set(r,e),e),A=(r,t,e)=>(di(r,t,"access private method"),e);var Ds=(r,t,e,s)=>({set _(i){D(r,t,i,e)},get _(){return d(r,t,s)}});import{B as zt,C as Gi,A as ht,al as lt,aw as In,ax as wi,S as Pe,i as He,s as ze,ad as de,D as Y,X as Z,E,b as Q,V as Pt,ab as Xe,c as O,d as tt,F as k,a7 as pr,a6 as we,u as $,q as vt,t as C,r as $t,e as N,G as T,a8 as Vi,ah as je,a0 as pt,Z as Je,_ as yo,$ as vo,N as ne,n as J,Y as ue,ai as gr,a2 as Yt,ak as fi,at as rs,T as Gs,ag as $o,ac as Bi,a1 as mr,aj as bo,a4 as _r,ay as Co,U as So}from"./SpinnerAugment-CCR7AGk-.js";import"./design-system-init-B0YNj4mb.js";import{S as xo,W as at,h as gs,D as pi,I as wo,e as Vs,g as Mo}from"./IconButtonAugment-CVWbWfwx.js";import{A as Io}from"./async-messaging-BnYTstSc.js";import{i as Ot,a as Mi,b as Ye,c as ct,d as ms,e as Rs,S as se,f as Le,g as ei,h as Eo,C as ko,E as To,D as Ao,j as Fo,k as Oo,s as gi,l as Ki,m as Bs,n as Ks,o as Qi,p as Qs,q as Zi,r as Zs,A as No,t as Xs,u as mi,v as Lo,w as Do,x as _s,y as yr,U as vr,z as $r,B as br,F as Ro}from"./chat-flags-model-B-EOBEov.js";import{F as Cr,j as En,k as _i,f as qs,l as kn,m as Ii,s as qo,G as Uo,H as Tn,D as yi,b as An,c as Fn}from"./index-DaLJ_QUV.js";import{C as jo}from"./types-CGlLNakm.js";import{C as wt,P as he,a as Ht,E as Po,M as Sr}from"./message-broker-D_dlQCzo.js";import{f as Ho,i as xr}from"./file-paths-BhRi9crS.js";import{K as We,C as zo,F as Wo,a as wr,P as Go}from"./folder-opened-D6WrI8wv.js";import{B as Me}from"./ButtonAugment-JhlUwgSi.js";import{a as Vo,T as Bo}from"./TextTooltipAugment-QVDAcl-O.js";import{A as On,R as Ko,B as Qo,P as Zo,T as Xo,a as Mr,b as Jo,C as Yo,c as ta,G as ea,d as sa,M as Ei,e as Ir,K as ia,f as na}from"./Keybindings-BZOppcAY.js";import{F as Tt}from"./Filespan-Dq3a1CK8.js";import{M as os}from"./MaterialIcon-BiH6zpoH.js";import{a as ra,M as oa,b as aa,C as ca}from"./index-DJGUS2rb.js";import"./index-B60hMJvm.js";import"./CardAugment-Cjl8BxE0.js";import"./BaseTextInput-BomIiYnE.js";import"./CalloutAugment-D1eOn47Z.js";import"./exclamation-triangle-CGK58Qw5.js";import"./pen-to-square-CrZjDplM.js";import"./augment-logo-Bf5bIaNf.js";var Nn=NaN,la="[object Symbol]",ha=/^\s+|\s+$/g,ua=/^[-+]0x[0-9a-f]+$/i,da=/^0b[01]+$/i,fa=/^0o[0-7]+$/i,pa=parseInt,ga=typeof zt=="object"&&zt&&zt.Object===Object&&zt,ma=typeof self=="object"&&self&&self.Object===Object&&self,_a=ga||ma||Function("return this")(),ya=Object.prototype.toString,va=Math.max,$a=Math.min,vi=function(){return _a.Date.now()};function ki(r){var t=typeof r;return!!r&&(t=="object"||t=="function")}function Ln(r){if(typeof r=="number")return r;if(function(s){return typeof s=="symbol"||function(i){return!!i&&typeof i=="object"}(s)&&ya.call(s)==la}(r))return Nn;if(ki(r)){var t=typeof r.valueOf=="function"?r.valueOf():r;r=ki(t)?t+"":t}if(typeof r!="string")return r===0?r:+r;r=r.replace(ha,"");var e=da.test(r);return e||fa.test(r)?pa(r.slice(2),e?2:8):ua.test(r)?Nn:+r}const Ti=Gi(function(r,t,e){var s,i,n,o,a,c,u=0,h=!1,f=!1,p=!0;if(typeof r!="function")throw new TypeError("Expected a function");function _(y){var M=s,F=i;return s=i=void 0,u=y,o=r.apply(F,M)}function b(y){var M=y-c;return c===void 0||M>=t||M<0||f&&y-u>=n}function S(){var y=vi();if(b(y))return x(y);a=setTimeout(S,function(M){var F=t-(M-c);return f?$a(F,n-(M-u)):F}(y))}function x(y){return a=void 0,p&&s?_(y):(s=i=void 0,o)}function m(){var y=vi(),M=b(y);if(s=arguments,i=this,c=y,M){if(a===void 0)return function(F){return u=F,a=setTimeout(S,t),h?_(F):o}(c);if(f)return a=setTimeout(S,t),_(c)}return a===void 0&&(a=setTimeout(S,t)),o}return t=Ln(t)||0,ki(e)&&(h=!!e.leading,n=(f="maxWait"in e)?va(Ln(e.maxWait)||0,t):n,p="trailing"in e?!!e.trailing:p),m.cancel=function(){a!==void 0&&clearTimeout(a),u=0,s=c=i=a=void 0},m.flush=function(){return a===void 0?o:x(vi())},m});var Ai={exports:{}};(function(r,t){var e="__lodash_hash_undefined__",s=1,i=2,n=9007199254740991,o="[object Arguments]",a="[object Array]",c="[object AsyncFunction]",u="[object Boolean]",h="[object Date]",f="[object Error]",p="[object Function]",_="[object GeneratorFunction]",b="[object Map]",S="[object Number]",x="[object Null]",m="[object Object]",y="[object Promise]",M="[object Proxy]",F="[object RegExp]",R="[object Set]",nt="[object String]",H="[object Symbol]",G="[object Undefined]",P="[object WeakMap]",bt="[object ArrayBuffer]",ut="[object DataView]",Mt=/^\[object .+?Constructor\]$/,B=/^(?:0|[1-9]\d*)$/,z={};z["[object Float32Array]"]=z["[object Float64Array]"]=z["[object Int8Array]"]=z["[object Int16Array]"]=z["[object Int32Array]"]=z["[object Uint8Array]"]=z["[object Uint8ClampedArray]"]=z["[object Uint16Array]"]=z["[object Uint32Array]"]=!0,z[o]=z[a]=z[bt]=z[u]=z[ut]=z[h]=z[f]=z[p]=z[b]=z[S]=z[m]=z[F]=z[R]=z[nt]=z[P]=!1;var Ut=typeof zt=="object"&&zt&&zt.Object===Object&&zt,Ee=typeof self=="object"&&self&&self.Object===Object&&self,At=Ut||Ee||Function("return this")(),U=t&&!t.nodeType&&t,ke=U&&r&&!r.nodeType&&r,Ge=ke&&ke.exports===U,as=Ge&&Ut.process,$s=function(){try{return as&&as.binding&&as.binding("util")}catch{}}(),en=$s&&$s.isTypedArray;function Vr(g,v){for(var w=-1,L=g==null?0:g.length;++w<L;)if(v(g[w],w,g))return!0;return!1}function Br(g){var v=-1,w=Array(g.size);return g.forEach(function(L,et){w[++v]=[et,L]}),w}function Kr(g){var v=-1,w=Array(g.size);return g.forEach(function(L){w[++v]=L}),w}var sn,nn,rn,Qr=Array.prototype,Zr=Function.prototype,bs=Object.prototype,si=At["__core-js_shared__"],on=Zr.toString,te=bs.hasOwnProperty,an=(sn=/[^.]+$/.exec(si&&si.keys&&si.keys.IE_PROTO||""))?"Symbol(src)_1."+sn:"",cn=bs.toString,Xr=RegExp("^"+on.call(te).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),ln=Ge?At.Buffer:void 0,Cs=At.Symbol,hn=At.Uint8Array,un=bs.propertyIsEnumerable,Jr=Qr.splice,Te=Cs?Cs.toStringTag:void 0,dn=Object.getOwnPropertySymbols,Yr=ln?ln.isBuffer:void 0,to=(nn=Object.keys,rn=Object,function(g){return nn(rn(g))}),ii=Ve(At,"DataView"),cs=Ve(At,"Map"),ni=Ve(At,"Promise"),ri=Ve(At,"Set"),oi=Ve(At,"WeakMap"),ls=Ve(Object,"create"),eo=Oe(ii),so=Oe(cs),io=Oe(ni),no=Oe(ri),ro=Oe(oi),fn=Cs?Cs.prototype:void 0,ai=fn?fn.valueOf:void 0;function Ae(g){var v=-1,w=g==null?0:g.length;for(this.clear();++v<w;){var L=g[v];this.set(L[0],L[1])}}function re(g){var v=-1,w=g==null?0:g.length;for(this.clear();++v<w;){var L=g[v];this.set(L[0],L[1])}}function Fe(g){var v=-1,w=g==null?0:g.length;for(this.clear();++v<w;){var L=g[v];this.set(L[0],L[1])}}function Ss(g){var v=-1,w=g==null?0:g.length;for(this.__data__=new Fe;++v<w;)this.add(g[v])}function pe(g){var v=this.__data__=new re(g);this.size=v.size}function oo(g,v){var w=Ms(g),L=!w&&uo(g),et=!w&&!L&&ci(g),W=!w&&!L&&!et&&Cn(g),ot=w||L||et||W,dt=ot?function(mt,ee){for(var oe=-1,It=Array(mt);++oe<mt;)It[oe]=ee(oe);return It}(g.length,String):[],Wt=dt.length;for(var gt in g)!te.call(g,gt)||ot&&(gt=="length"||et&&(gt=="offset"||gt=="parent")||W&&(gt=="buffer"||gt=="byteLength"||gt=="byteOffset")||ho(gt,Wt))||dt.push(gt);return dt}function xs(g,v){for(var w=g.length;w--;)if(yn(g[w][0],v))return w;return-1}function hs(g){return g==null?g===void 0?G:x:Te&&Te in Object(g)?function(v){var w=te.call(v,Te),L=v[Te];try{v[Te]=void 0;var et=!0}catch{}var W=cn.call(v);return et&&(w?v[Te]=L:delete v[Te]),W}(g):function(v){return cn.call(v)}(g)}function pn(g){return us(g)&&hs(g)==o}function gn(g,v,w,L,et){return g===v||(g==null||v==null||!us(g)&&!us(v)?g!=g&&v!=v:function(W,ot,dt,Wt,gt,mt){var ee=Ms(W),oe=Ms(ot),It=ee?a:ge(W),ae=oe?a:ge(ot),Be=(It=It==o?m:It)==m,Is=(ae=ae==o?m:ae)==m,Ke=It==ae;if(Ke&&ci(W)){if(!ci(ot))return!1;ee=!0,Be=!1}if(Ke&&!Be)return mt||(mt=new pe),ee||Cn(W)?mn(W,ot,dt,Wt,gt,mt):function(X,K,Es,me,li,jt,ce){switch(Es){case ut:if(X.byteLength!=K.byteLength||X.byteOffset!=K.byteOffset)return!1;X=X.buffer,K=K.buffer;case bt:return!(X.byteLength!=K.byteLength||!jt(new hn(X),new hn(K)));case u:case h:case S:return yn(+X,+K);case f:return X.name==K.name&&X.message==K.message;case F:case nt:return X==K+"";case b:var _e=Br;case R:var fs=me&s;if(_e||(_e=Kr),X.size!=K.size&&!fs)return!1;var ks=ce.get(X);if(ks)return ks==K;me|=i,ce.set(X,K);var hi=mn(_e(X),_e(K),me,li,jt,ce);return ce.delete(X),hi;case H:if(ai)return ai.call(X)==ai.call(K)}return!1}(W,ot,It,dt,Wt,gt,mt);if(!(dt&s)){var ds=Be&&te.call(W,"__wrapped__"),Sn=Is&&te.call(ot,"__wrapped__");if(ds||Sn){var po=ds?W.value():W,go=Sn?ot.value():ot;return mt||(mt=new pe),gt(po,go,dt,Wt,mt)}}return Ke?(mt||(mt=new pe),function(X,K,Es,me,li,jt){var ce=Es&s,_e=_n(X),fs=_e.length,ks=_n(K),hi=ks.length;if(fs!=hi&&!ce)return!1;for(var Ts=fs;Ts--;){var Ne=_e[Ts];if(!(ce?Ne in K:te.call(K,Ne)))return!1}var xn=jt.get(X);if(xn&&jt.get(K))return xn==K;var As=!0;jt.set(X,K),jt.set(K,X);for(var ui=ce;++Ts<fs;){var Fs=X[Ne=_e[Ts]],Os=K[Ne];if(me)var wn=ce?me(Os,Fs,Ne,K,X,jt):me(Fs,Os,Ne,X,K,jt);if(!(wn===void 0?Fs===Os||li(Fs,Os,Es,me,jt):wn)){As=!1;break}ui||(ui=Ne=="constructor")}if(As&&!ui){var Ns=X.constructor,Ls=K.constructor;Ns==Ls||!("constructor"in X)||!("constructor"in K)||typeof Ns=="function"&&Ns instanceof Ns&&typeof Ls=="function"&&Ls instanceof Ls||(As=!1)}return jt.delete(X),jt.delete(K),As}(W,ot,dt,Wt,gt,mt)):!1}(g,v,w,L,gn,et))}function ao(g){return!(!bn(g)||function(v){return!!an&&an in v}(g))&&(vn(g)?Xr:Mt).test(Oe(g))}function co(g){if(w=(v=g)&&v.constructor,L=typeof w=="function"&&w.prototype||bs,v!==L)return to(g);var v,w,L,et=[];for(var W in Object(g))te.call(g,W)&&W!="constructor"&&et.push(W);return et}function mn(g,v,w,L,et,W){var ot=w&s,dt=g.length,Wt=v.length;if(dt!=Wt&&!(ot&&Wt>dt))return!1;var gt=W.get(g);if(gt&&W.get(v))return gt==v;var mt=-1,ee=!0,oe=w&i?new Ss:void 0;for(W.set(g,v),W.set(v,g);++mt<dt;){var It=g[mt],ae=v[mt];if(L)var Be=ot?L(ae,It,mt,v,g,W):L(It,ae,mt,g,v,W);if(Be!==void 0){if(Be)continue;ee=!1;break}if(oe){if(!Vr(v,function(Is,Ke){if(ds=Ke,!oe.has(ds)&&(It===Is||et(It,Is,w,L,W)))return oe.push(Ke);var ds})){ee=!1;break}}else if(It!==ae&&!et(It,ae,w,L,W)){ee=!1;break}}return W.delete(g),W.delete(v),ee}function _n(g){return function(v,w,L){var et=w(v);return Ms(v)?et:function(W,ot){for(var dt=-1,Wt=ot.length,gt=W.length;++dt<Wt;)W[gt+dt]=ot[dt];return W}(et,L(v))}(g,fo,lo)}function ws(g,v){var w,L,et=g.__data__;return((L=typeof(w=v))=="string"||L=="number"||L=="symbol"||L=="boolean"?w!=="__proto__":w===null)?et[typeof v=="string"?"string":"hash"]:et.map}function Ve(g,v){var w=function(L,et){return L==null?void 0:L[et]}(g,v);return ao(w)?w:void 0}Ae.prototype.clear=function(){this.__data__=ls?ls(null):{},this.size=0},Ae.prototype.delete=function(g){var v=this.has(g)&&delete this.__data__[g];return this.size-=v?1:0,v},Ae.prototype.get=function(g){var v=this.__data__;if(ls){var w=v[g];return w===e?void 0:w}return te.call(v,g)?v[g]:void 0},Ae.prototype.has=function(g){var v=this.__data__;return ls?v[g]!==void 0:te.call(v,g)},Ae.prototype.set=function(g,v){var w=this.__data__;return this.size+=this.has(g)?0:1,w[g]=ls&&v===void 0?e:v,this},re.prototype.clear=function(){this.__data__=[],this.size=0},re.prototype.delete=function(g){var v=this.__data__,w=xs(v,g);return!(w<0)&&(w==v.length-1?v.pop():Jr.call(v,w,1),--this.size,!0)},re.prototype.get=function(g){var v=this.__data__,w=xs(v,g);return w<0?void 0:v[w][1]},re.prototype.has=function(g){return xs(this.__data__,g)>-1},re.prototype.set=function(g,v){var w=this.__data__,L=xs(w,g);return L<0?(++this.size,w.push([g,v])):w[L][1]=v,this},Fe.prototype.clear=function(){this.size=0,this.__data__={hash:new Ae,map:new(cs||re),string:new Ae}},Fe.prototype.delete=function(g){var v=ws(this,g).delete(g);return this.size-=v?1:0,v},Fe.prototype.get=function(g){return ws(this,g).get(g)},Fe.prototype.has=function(g){return ws(this,g).has(g)},Fe.prototype.set=function(g,v){var w=ws(this,g),L=w.size;return w.set(g,v),this.size+=w.size==L?0:1,this},Ss.prototype.add=Ss.prototype.push=function(g){return this.__data__.set(g,e),this},Ss.prototype.has=function(g){return this.__data__.has(g)},pe.prototype.clear=function(){this.__data__=new re,this.size=0},pe.prototype.delete=function(g){var v=this.__data__,w=v.delete(g);return this.size=v.size,w},pe.prototype.get=function(g){return this.__data__.get(g)},pe.prototype.has=function(g){return this.__data__.has(g)},pe.prototype.set=function(g,v){var w=this.__data__;if(w instanceof re){var L=w.__data__;if(!cs||L.length<199)return L.push([g,v]),this.size=++w.size,this;w=this.__data__=new Fe(L)}return w.set(g,v),this.size=w.size,this};var lo=dn?function(g){return g==null?[]:(g=Object(g),function(v,w){for(var L=-1,et=v==null?0:v.length,W=0,ot=[];++L<et;){var dt=v[L];w(dt,L,v)&&(ot[W++]=dt)}return ot}(dn(g),function(v){return un.call(g,v)}))}:function(){return[]},ge=hs;function ho(g,v){return!!(v=v??n)&&(typeof g=="number"||B.test(g))&&g>-1&&g%1==0&&g<v}function Oe(g){if(g!=null){try{return on.call(g)}catch{}try{return g+""}catch{}}return""}function yn(g,v){return g===v||g!=g&&v!=v}(ii&&ge(new ii(new ArrayBuffer(1)))!=ut||cs&&ge(new cs)!=b||ni&&ge(ni.resolve())!=y||ri&&ge(new ri)!=R||oi&&ge(new oi)!=P)&&(ge=function(g){var v=hs(g),w=v==m?g.constructor:void 0,L=w?Oe(w):"";if(L)switch(L){case eo:return ut;case so:return b;case io:return y;case no:return R;case ro:return P}return v});var uo=pn(function(){return arguments}())?pn:function(g){return us(g)&&te.call(g,"callee")&&!un.call(g,"callee")},Ms=Array.isArray,ci=Yr||function(){return!1};function vn(g){if(!bn(g))return!1;var v=hs(g);return v==p||v==_||v==c||v==M}function $n(g){return typeof g=="number"&&g>-1&&g%1==0&&g<=n}function bn(g){var v=typeof g;return g!=null&&(v=="object"||v=="function")}function us(g){return g!=null&&typeof g=="object"}var Cn=en?function(g){return function(v){return g(v)}}(en):function(g){return us(g)&&$n(g.length)&&!!z[hs(g)]};function fo(g){return(v=g)!=null&&$n(v.length)&&!vn(v)?oo(g):co(g);var v}r.exports=function(g,v){return gn(g,v)}})(Ai,Ai.exports);const ba=Gi(Ai.exports);function Er(r){return function(t){return"unitOfCodeWork"in t&&!function(e){return e.children.length>0&&"childIds"in e}(t)}(r)?[r]:r.children.flatMap(Er)}function Ca(r,t,e=1e3){let s=null,i=0;const n=ht(t),o=()=>{const a=(()=>{const c=Date.now();if(s!==null&&c-i<e)return s;const u=r();return s=u,i=c,u})();n.set(a)};return{subscribe:n.subscribe,resetCache:()=>{s=null,o()},updateStore:o}}var kr=(r=>(r[r.unset=0]="unset",r[r.positive=1]="positive",r[r.negative=2]="negative",r))(kr||{});function Sa(r=[]){const t=function(e=[]){let s;for(const i of e){if(i.type===wt.TOOL_USE)return i;i.type===wt.TOOL_USE_START&&(s=i)}return s}(r);return t&&t.type===wt.TOOL_USE?r.filter(e=>e.type!==wt.TOOL_USE_START):r}const Ft="__NEW_AGENT__";function ts(r){var t;return((t=r.extraData)==null?void 0:t.isAgentConversation)===!0}var yt=(r=>(r[r.active=0]="active",r[r.inactive=1]="inactive",r))(yt||{});const Dn=r=>Ot(r)&&!!r.request_message,$i="temp-fe";class rt{constructor(t,e,s,i){l(this,"_state");l(this,"_subscribers",new Set);l(this,"_focusModel",new Cr);l(this,"_onSendExchangeListeners",[]);l(this,"_onNewConversationListeners",[]);l(this,"_onHistoryDeleteListeners",[]);l(this,"_onBeforeChangeConversationListeners",[]);l(this,"_totalCharactersCacheThrottleMs",1e3);l(this,"_totalCharactersStore");l(this,"subscribe",t=>(this._subscribers.add(t),t(this),()=>{this._subscribers.delete(t)}));l(this,"setConversation",(t,e=!0,s=!0)=>{const i=t.id!==this._state.id;i&&s&&(t.toolUseStates=Object.fromEntries(Object.entries(t.toolUseStates??{}).map(([o,a])=>{if(a.requestId&&a.toolUseId){const{requestId:c,toolUseId:u}=En(o);return c===a.requestId&&u===a.toolUseId||console.warn("Tool use state key does not match request and tool use IDs. Got key ",o,"but object has ",_i(a)),[o,a]}return[o,{...a,...En(o)}]})),(t=this._notifyBeforeChangeConversation(this._state,t)).lastInteractedAtIso=new Date().toISOString()),e&&i&&this.isValid&&(this.saveDraftActiveContextIds(),this._unloadContextFromConversation(this._state));const n=rt.isEmpty(t);if(i&&n){const o=this._state.draftExchange;o&&(t.draftExchange=o)}return this._state=t,this._focusModel.setItems(this._state.chatHistory.filter(Ot)),this._focusModel.initFocusIdx(-1),this._subscribers.forEach(o=>o(this)),this._saveConversation(this._state),i&&(this._loadContextFromConversation(t),this.loadDraftActiveContextIds(),this._onNewConversationListeners.forEach(o=>o())),!0});l(this,"update",t=>{this.setConversation({...this._state,...t}),this._totalCharactersStore.updateStore()});l(this,"toggleIsPinned",()=>{this.update({isPinned:!this.isPinned})});l(this,"setName",t=>{this.update({name:t})});l(this,"setSelectedModelId",t=>{this.update({selectedModelId:t})});l(this,"updateFeedback",(t,e)=>{this.update({feedbackStates:{...this._state.feedbackStates,[t]:e}})});l(this,"updateToolUseState",t=>{this.update({toolUseStates:{...this._state.toolUseStates,[_i(t)]:t}})});l(this,"getToolUseState",(t,e)=>t===void 0||e===void 0||this.toolUseStates===void 0?{phase:qs.unknown,requestId:t??"",toolUseId:e??""}:this.toolUseStates[_i({requestId:t,toolUseId:e})]||{phase:qs.new});l(this,"getLastToolUseState",()=>{var s;const t=this.lastExchange;if(!t)return{phase:qs.unknown};const e=function(i=[]){let n;for(const o of i){if(o.type===wt.TOOL_USE)return o;o.type===wt.TOOL_USE_START&&(n=o)}return n}(t==null?void 0:t.structured_output_nodes);return e?this.getToolUseState(t.request_id,(s=e.tool_use)==null?void 0:s.tool_use_id):{phase:qs.unknown}});l(this,"addExchange",t=>{const e=[...this._state.chatHistory,t];let s;Ot(t)&&(s=t.request_id?{...this._state.feedbackStates,[t.request_id]:{selectedRating:kr.unset,feedbackNote:""}}:void 0),this.update({chatHistory:e,...s?{feedbackStates:s}:{},lastUrl:void 0})});l(this,"resetShareUrl",()=>{this.update({lastUrl:void 0})});l(this,"updateExchangeById",(t,e,s=!1)=>{var a;const i=this.exchangeWithRequestId(e);if(i===null)return console.warn("No exchange with this request ID found."),!1;s&&t.response_text!==void 0&&(t.response_text=(i.response_text??"")+(t.response_text??"")),s&&(t.structured_output_nodes=Sa([...i.structured_output_nodes??[],...t.structured_output_nodes??[]])),t.stop_reason!==i.stop_reason&&i.stop_reason&&t.stop_reason===jo.REASON_UNSPECIFIED&&(t.stop_reason=i.stop_reason),s&&t.workspace_file_chunks!==void 0&&(t.workspace_file_chunks=[...i.workspace_file_chunks??[],...t.workspace_file_chunks??[]]);const n=(a=(t.structured_output_nodes||[]).find(c=>c.type===wt.MAIN_TEXT_FINISHED))==null?void 0:a.content;n&&n!==t.response_text&&(t.response_text=n);let o=this._state.isShareable||Ye({...i,...t});return this.update({chatHistory:this.chatHistory.map(c=>c.request_id===e?{...c,...t}:c),isShareable:o}),!0});l(this,"clearMessagesFromHistory",t=>{this.update({chatHistory:this.chatHistory.filter(e=>!e.request_id||!t.has(e.request_id))}),this._extensionClient.clearMetadataFor({requestIds:Array.from(t)})});l(this,"clearHistory",()=>{this._extensionClient.clearMetadataFor({requestIds:this.requestIds}),this.update({chatHistory:[]})});l(this,"clearHistoryFrom",async(t,e=!0)=>{const s=this.historyFrom(t,e),i=s.map(n=>n.request_id).filter(n=>n!==void 0);this.update({chatHistory:this.historyTo(t,!e)}),this._extensionClient.clearMetadataFor({requestIds:i}),s.forEach(n=>{this._onHistoryDeleteListeners.forEach(o=>o(n))})});l(this,"clearMessageFromHistory",t=>{this.update({chatHistory:this.chatHistory.filter(e=>e.request_id!==t)}),this._extensionClient.clearMetadataFor({requestIds:[t]})});l(this,"historyTo",(t,e=!1)=>{const s=this.chatHistory.findIndex(i=>i.request_id===t);return s===-1?[]:this.chatHistory.slice(0,e?s+1:s)});l(this,"historyFrom",(t,e=!0)=>{const s=this.chatHistory.findIndex(i=>i.request_id===t);return s===-1?[]:this.chatHistory.slice(e?s:s+1)});l(this,"resendLastExchange",async()=>{const t=this.lastExchange;if(t&&!this.awaitingReply)return this.resendTurn(t)});l(this,"resendTurn",t=>this.awaitingReply?Promise.resolve():(this._removeTurn(t),this.sendExchange({chatItemType:t.chatItemType,request_message:t.request_message,rich_text_json_repr:t.rich_text_json_repr,status:ct.draft,mentioned_items:t.mentioned_items,structured_request_nodes:t.structured_request_nodes,disableSelectedCodeDetails:t.disableSelectedCodeDetails,chatHistory:t.chatHistory,model_id:t.model_id},!1,t.request_id)));l(this,"_removeTurn",t=>{this.update({chatHistory:this.chatHistory.filter(e=>e!==t&&(!t.request_id||e.request_id!==t.request_id))})});l(this,"exchangeWithRequestId",t=>this.chatHistory.find(e=>e.request_id===t)||null);l(this,"resetTotalCharactersCache",()=>{this._totalCharactersStore.resetCache()});l(this,"historySummaryVersion",1);l(this,"markSeen",async t=>{if(!t.request_id||!this.chatHistory.find(s=>s.request_id===t.request_id))return;const e={seen_state:se.seen};this.update({chatHistory:this.chatHistory.map(s=>s.request_id===t.request_id?{...s,...e}:s)})});l(this,"createStructuredRequestNodes",t=>this._jsonToStructuredRequest(t));l(this,"saveDraftMentions",t=>{if(!this.draftExchange)return;const e=t.filter(s=>!s.personality);this.update({draftExchange:{...this.draftExchange,mentioned_items:e}})});l(this,"saveDraftActiveContextIds",()=>{const t=this._specialContextInputModel.recentActiveItems.map(e=>e.id);this.update({draftActiveContextIds:t})});l(this,"loadDraftActiveContextIds",()=>{const t=new Set(this.draftActiveContextIds??[]),e=this._specialContextInputModel.recentItems.filter(i=>t.has(i.id)||i.recentFile||i.selection||i.sourceFolder),s=this._specialContextInputModel.recentItems.filter(i=>!(t.has(i.id)||i.recentFile||i.selection||i.sourceFolder));this._specialContextInputModel.markItemsActive(e.reverse()),this._specialContextInputModel.markItemsInactive(s.reverse())});l(this,"saveDraftExchange",(t,e)=>{var o,a,c;const s=t!==((o=this.draftExchange)==null?void 0:o.request_message),i=e!==((a=this.draftExchange)==null?void 0:a.rich_text_json_repr);if(!s&&!i)return;const n=(c=this.draftExchange)==null?void 0:c.mentioned_items;this.update({draftExchange:{request_message:t,rich_text_json_repr:e,mentioned_items:n,status:ct.draft}})});l(this,"clearDraftExchange",()=>{const t=this.draftExchange;return this.update({draftExchange:void 0}),t});l(this,"sendDraftExchange",()=>{if(this._extensionClient.triggerUsedChatMetric(),!this.canSendDraft||!this.draftExchange)return!1;const t=this.clearDraftExchange();if(!t)return!1;const e=this._chatFlagModel.enableChatMultimodal&&t.rich_text_json_repr?this._jsonToStructuredRequest(t.rich_text_json_repr):void 0;return this.sendExchange({...t,structured_request_nodes:e,model_id:this.selectedModelId??void 0}).then(()=>{var o,a;const s=!this.name&&this.chatHistory.length===1&&((o=this.firstExchange)==null?void 0:o.request_id)===this.chatHistory[0].request_id,i=ts(this)&&((a=this._state.extraData)==null?void 0:a.hasAgentOnboarded)&&(n=this.chatHistory,n.filter(c=>Dn(c))).length===2;var n;this._chatFlagModel.summaryTitles&&(s||i)&&this.updateConversationTitle()}).finally(()=>{var s;ts(this)&&this._extensionClient.reportAgentRequestEvent({eventName:kn.sentUserMessage,conversationId:this.id,requestId:((s=this.lastExchange)==null?void 0:s.request_id)??"UNKNOWN_REQUEST_ID",chatHistoryLength:this.chatHistory.length})}),this.focusModel.setFocusIdx(void 0),!0});l(this,"cancelMessage",async()=>{var t;this.canCancelMessage&&((t=this.lastExchange)!=null&&t.request_id)&&(this.updateExchangeById({status:ct.cancelled},this.lastExchange.request_id),await this._extensionClient.cancelChatStream(this.lastExchange.request_id))});l(this,"sendInstructionExchange",async(t,e)=>{let s=`${$i}-${crypto.randomUUID()}`;const i={status:ct.sent,request_id:s,request_message:t,model_id:this.selectedModelId??void 0,structured_output_nodes:[],seen_state:se.unseen,timestamp:new Date().toISOString()};this.addExchange(i);for await(const n of this._extensionClient.sendInstructionMessage(i,e)){if(!this.updateExchangeById(n,s,!0))return;s=n.request_id||s}});l(this,"updateConversationTitle",async()=>{const{responseText:t}=await this.sendSummaryExchange();this.update({name:t})});l(this,"sendSummaryExchange",()=>{const t={status:ct.sent,request_message:"Please provide a clear and concise summary of our conversation so far. The summary must be less than 6 words long. The summary must contain the key points of the conversation. The summary must be in the form of a title which will represent the conversation. The response should not include any additional formatting such as wrapping the response with quotation marks.",model_id:this.selectedModelId??void 0,chatItemType:Le.summaryTitle,disableRetrieval:!0,disableSelectedCodeDetails:!0};return this.sendSilentExchange(t)});l(this,"generateCommitMessage",async()=>{let t=`${$i}-${crypto.randomUUID()}`;const e={status:ct.sent,request_id:t,request_message:"Please generate a commit message based on the diff of my staged and unstaged changes.",model_id:this.selectedModelId??void 0,mentioned_items:[],seen_state:se.unseen,chatItemType:Le.generateCommitMessage,disableSelectedCodeDetails:!0,chatHistory:[],timestamp:new Date().toISOString()};this.addExchange(e);for await(const s of this._extensionClient.generateCommitMessage()){if(!this.updateExchangeById(s,t,!0))return;t=s.request_id||t}});l(this,"sendExchange",async(t,e=!1,s)=>{var a;this.updateLastInteraction();let i=`${$i}-${crypto.randomUUID()}`,n=this._chatFlagModel.isModelIdValid(t.model_id)?t.model_id:void 0;if(this._chatFlagModel.doUseNewDraftFunctionality&&rt.isNew(this._state)){const c=crypto.randomUUID(),u=this._state.id;try{await this._extensionClient.migrateConversationId(u,c)}catch(h){console.error("Failed to migrate conversation checkpoints:",h)}this._state={...this._state,id:c},this._saveConversation(this._state,!0),this._extensionClient.setCurrentConversation(c),this._subscribers.forEach(h=>h(this))}t=qn(t);let o={status:ct.sent,request_id:i,request_message:t.request_message,rich_text_json_repr:t.rich_text_json_repr,model_id:n,mentioned_items:t.mentioned_items,structured_output_nodes:t.structured_output_nodes,seen_state:se.unseen,chatItemType:t.chatItemType,disableSelectedCodeDetails:t.disableSelectedCodeDetails,chatHistory:t.chatHistory,structured_request_nodes:t.structured_request_nodes,timestamp:new Date().toISOString()};this.addExchange(o),this._loadContextFromExchange(o),this._onSendExchangeListeners.forEach(c=>c(o)),this._chatFlagModel.useHistorySummary&&await this.maybeAddHistorySummaryNode()&&this._clearStaleHistorySummaryNodes(),o=await this._addIdeStateNode(o),this.updateExchangeById({structured_request_nodes:o.structured_request_nodes},i,!1);for await(const c of this.sendUserMessage(i,o,e,s)){if(((a=this.exchangeWithRequestId(i))==null?void 0:a.status)!==ct.sent||!this.updateExchangeById(c,i,!0))return;i=c.request_id||i}});l(this,"sendSuggestedQuestion",t=>{this.sendExchange({request_message:t,status:ct.draft}),this._extensionClient.triggerUsedChatMetric(),this._extensionClient.reportWebviewClientEvent(Ii.chatUseSuggestedQuestion)});l(this,"recoverAllExchanges",async()=>{await Promise.all(this.recoverableExchanges.map(this.recoverExchange))});l(this,"recoverExchange",async t=>{var i;if(!t.request_id||t.status!==ct.sent)return;let e=t.request_id;const s=(i=t.structured_output_nodes)==null?void 0:i.filter(n=>n.type===wt.AGENT_MEMORY);this.updateExchangeById({...t,response_text:"",structured_output_nodes:s??[]},e);for await(const n of this.getChatStream(t)){if(!this.updateExchangeById(n,e,!0))return;e=n.request_id||e}});l(this,"_loadContextFromConversation",t=>{t.chatHistory.forEach(e=>{Ot(e)&&this._loadContextFromExchange(e)})});l(this,"_loadContextFromExchange",t=>{t.mentioned_items&&(this._specialContextInputModel.updateItems(t.mentioned_items,[]),this._specialContextInputModel.markItemsActive(t.mentioned_items))});l(this,"_unloadContextFromConversation",t=>{t.chatHistory.forEach(e=>{Ot(e)&&this._unloadContextFromExchange(e)})});l(this,"_unloadContextFromExchange",t=>{t.mentioned_items&&this._specialContextInputModel.updateItems([],t.mentioned_items)});l(this,"updateLastInteraction",()=>{this.update({lastInteractedAtIso:new Date().toISOString()})});l(this,"_jsonToStructuredRequest",t=>{const e=[],s=n=>{var a;const o=e.at(-1);if((o==null?void 0:o.type)===Ht.TEXT){const c=((a=o.text_node)==null?void 0:a.content)??"",u={...o,text_node:{content:c+n}};e[e.length-1]=u}else e.push({id:e.length,type:Ht.TEXT,text_node:{content:n}})},i=n=>{var o,a,c,u;if(n.type==="doc"||n.type==="paragraph")for(const h of n.content??[])i(h);else if(n.type==="hardBreak")s(`
`);else if(n.type==="text")s(n.text??"");else if(n.type==="file"){if(typeof((o=n.attrs)==null?void 0:o.src)!="string")return void console.error("File source is not a string: ",(a=n.attrs)==null?void 0:a.src);if(n.attrs.isLoading)return;const h=(c=n.attrs)==null?void 0:c.title,f=Ho(h);xr(h)?e.push({id:e.length,type:Ht.IMAGE_ID,image_id_node:{image_id:n.attrs.src,format:f}}):e.push({id:e.length,type:Ht.FILE_ID,file_id_node:{file_id:n.attrs.src,file_name:h}})}else if(n.type==="mention"){const h=(u=n.attrs)==null?void 0:u.data;h&&ei(h)?e.push({id:e.length,type:Ht.TEXT,text_node:{content:Eo(this._chatFlagModel,h.personality.type)}}):s(`@\`${(h==null?void 0:h.name)??(h==null?void 0:h.id)}\``)}};return i(t),e});this._extensionClient=t,this._chatFlagModel=e,this._specialContextInputModel=s,this._saveConversation=i,this._state={...rt.create()},this._totalCharactersStore=this._createTotalCharactersStore()}_createTotalCharactersStore(){return Ca(()=>{let t=0;const e=this._state.chatHistory;return this._convertHistoryToExchanges(e).forEach(s=>{t+=JSON.stringify(s).length}),this._state.draftExchange&&(t+=JSON.stringify(this._state.draftExchange).length),t},0,this._totalCharactersCacheThrottleMs)}async decidePersonaType(){var t;try{return(((t=(await this._extensionClient.getWorkspaceInfo()).trackedFileCount)==null?void 0:t.reduce((s,i)=>s+i,0))||0)<=4?he.PROTOTYPER:he.DEFAULT}catch(e){return console.error("Error determining persona type:",e),he.DEFAULT}}static create(t={}){const e=new Date().toISOString();return{id:t.id||crypto.randomUUID(),name:void 0,createdAtIso:e,lastInteractedAtIso:e,chatHistory:[],feedbackStates:{},toolUseStates:{},draftExchange:void 0,draftActiveContextIds:void 0,selectedModelId:void 0,requestIds:[],isPinned:!1,lastUrl:void 0,isShareable:!1,extraData:{},personaType:he.DEFAULT,...t}}static toSentenceCase(t){return t.charAt(0).toUpperCase()+t.slice(1)}static getDisplayName(t){if(t.name)return t.name;const e=t.chatHistory.find(Ot);return e&&e.request_message?rt.toSentenceCase(e.request_message):ts(t)?"New Agent":"New Chat"}static isNew(t){return t.id===Ft}static isEmpty(t){var i;const e=t.chatHistory.filter(n=>Ot(n)),s=t.chatHistory.filter(n=>Mi(n));return e.length===0&&s.length===0&&!((i=t.draftExchange)!=null&&i.request_message)}static isNamed(t){return t.name!==void 0&&t.name!==""}static getTime(t,e){return e==="lastMessageTimestamp"?rt.lastMessageTimestamp(t):e==="lastInteractedAt"?rt.lastInteractedAt(t):rt.createdAt(t)}static createdAt(t){return new Date(t.createdAtIso)}static lastInteractedAt(t){return new Date(t.lastInteractedAtIso)}static lastMessageTimestamp(t){var s;const e=(s=t.chatHistory.findLast(Ot))==null?void 0:s.timestamp;return e?new Date(e):this.createdAt(t)}static isValid(t){return t.id!==void 0&&(!rt.isEmpty(t)||rt.isNamed(t))}onBeforeChangeConversation(t){return this._onBeforeChangeConversationListeners.push(t),()=>{this._onBeforeChangeConversationListeners=this._onBeforeChangeConversationListeners.filter(e=>e!==t)}}_notifyBeforeChangeConversation(t,e){let s=e;for(const i of this._onBeforeChangeConversationListeners){const n=i(t,s);n!==void 0&&(s=n)}return s}get extraData(){return this._state.extraData}set extraData(t){this.update({extraData:t})}get focusModel(){return this._focusModel}get isValid(){return rt.isValid(this._state)}get id(){return this._state.id}get name(){return this._state.name}get personaType(){return this._state.personaType??he.DEFAULT}get rootTaskUuid(){return this._state.rootTaskUuid}set rootTaskUuid(t){this.update({rootTaskUuid:t})}get displayName(){return rt.getDisplayName(this._state)}get createdAtIso(){return this._state.createdAtIso}get createdAt(){return rt.createdAt(this._state)}get chatHistory(){return this._state.chatHistory}get feedbackStates(){return this._state.feedbackStates}get toolUseStates(){return this._state.toolUseStates}get draftExchange(){return this._state.draftExchange}get selectedModelId(){return this._state.selectedModelId}get isPinned(){return!!this._state.isPinned}get extensionClient(){return this._extensionClient}addChatItem(t){this.addExchange(t)}get requestIds(){return this._state.chatHistory.map(t=>t.request_id).filter(t=>t!==void 0)}get hasDraft(){var s;const t=(((s=this.draftExchange)==null?void 0:s.request_message)??"").trim()!=="",e=this.hasImagesInDraft();return t||e}hasImagesInDraft(){var s;const t=(s=this.draftExchange)==null?void 0:s.rich_text_json_repr;if(!t)return!1;const e=i=>Array.isArray(i)?i.some(e):!!i&&(i.type==="file"||!(!i.content||!Array.isArray(i.content))&&i.content.some(e));return e(t)}get canSendDraft(){return this.hasDraft&&!this.awaitingReply}get canCancelMessage(){return this.awaitingReply}get firstExchange(){return this.chatHistory.find(Ot)??null}get lastExchange(){return this.chatHistory.findLast(Ot)??null}get canClearHistory(){return this._state.chatHistory.length!==0&&!this.awaitingReply}get recoverableExchanges(){return this._state.chatHistory.filter(t=>Ot(t)&&t.status===ct.sent)}get successfulMessages(){return this._state.chatHistory.filter(t=>Ye(t)||ms(t)||Rs(t))}get totalCharactersStore(){return this._totalCharactersStore}_convertHistoryToExchanges(t){if(t.length===0)return[];const e=t.findLastIndex(i=>Rs(i)&&i.summaryVersion===this.historySummaryVersion);this._chatFlagModel.useHistorySummary&&e>0&&(console.info("Using history summary node found at index %d",e),t=t.slice(e));const s=[];for(const i of t)if(Ye(i))s.push(Rn(i));else if(ms(i)&&i.fromTimestamp!==void 0&&i.toTimestamp!==void 0){if(i.revertTarget){const n=xa(i,1),o={request_message:"",response_text:"",request_id:i.request_id||crypto.randomUUID(),request_nodes:[n],response_nodes:[]};s.push(o)}}else this._chatFlagModel.useHistorySummary&&Rs(i)&&i.summaryVersion===this.historySummaryVersion&&s.push(Rn(i));return s}get awaitingReply(){return this.lastExchange!==null&&this.lastExchange.status===ct.sent}get lastInteractedAtIso(){return this._state.lastInteractedAtIso}get draftActiveContextIds(){return this._state.draftActiveContextIds}async sendSilentExchange(t){const e=crypto.randomUUID();let s,i="";const n=await this._addIdeStateNode(qn({...t,request_id:e,status:ct.sent,timestamp:new Date().toISOString()}));for await(const o of this.sendUserMessage(e,n,!0))o.response_text&&(i+=o.response_text),o.request_id&&(s=o.request_id);return{responseText:i,requestId:s}}async*getChatStream(t){t.request_id&&(yield*this._extensionClient.getExistingChatStream(t,{flags:this._chatFlagModel}))}_createStreamStateHandlers(t,e,s){return[]}async*sendUserMessage(t,e,s,i){var f;const n=this._specialContextInputModel.chatActiveContext;let o;if(e.chatHistory!==void 0)o=e.chatHistory;else{let p=this.successfulMessages;if(e.chatItemType===Le.summaryTitle){const _=p.findIndex(b=>b.chatItemType!==Le.agentOnboarding&&Dn(b));_!==-1&&(p=p.slice(_))}o=this._convertHistoryToExchanges(p)}let a=this.personaType;if(e.structured_request_nodes){const p=e.structured_request_nodes.find(_=>_.type===Ht.CHANGE_PERSONALITY);p&&p.change_personality_node&&(a=p.change_personality_node.personality_type)}const c={text:e.request_message,chatHistory:o,silent:s,modelId:e.model_id,context:n,userSpecifiedFiles:n.userSpecifiedFiles,externalSourceIds:(f=n.externalSources)==null?void 0:f.map(p=>p.id),disableRetrieval:e.disableRetrieval??!1,disableSelectedCodeDetails:e.disableSelectedCodeDetails??!1,nodes:e.structured_request_nodes,memoriesInfo:e.memoriesInfo,personaType:a,conversationId:this.id,createdTimestamp:Date.now(),requestIdOverride:i},u=this._createStreamStateHandlers(t,c,{flags:this._chatFlagModel}),h=this._extensionClient.startChatStreamWithRetry(t,c,{flags:this._chatFlagModel});for await(const p of h){let _=p;for(const b of u)_=b.handleChunk(_)??_;yield _}for(const p of u)yield*p.handleComplete()}onSendExchange(t){return this._onSendExchangeListeners.push(t),()=>{this._onSendExchangeListeners=this._onSendExchangeListeners.filter(e=>e!==t)}}onNewConversation(t){return this._onNewConversationListeners.push(t),()=>{this._onNewConversationListeners=this._onNewConversationListeners.filter(e=>e!==t)}}onHistoryDelete(t){return this._onHistoryDeleteListeners.push(t),()=>{this._onHistoryDeleteListeners=this._onHistoryDeleteListeners.filter(e=>e!==t)}}updateChatItem(t,e){return this.chatHistory.find(s=>s.request_id===t)===null?(console.warn("No exchange with this request ID found."),!1):(this.update({chatHistory:this.chatHistory.map(s=>s.request_id===t?{...s,...e}:s)}),!0)}async _addIdeStateNode(t){let e,s=(t.structured_request_nodes??[]).filter(i=>i.type!==Ht.IDE_STATE);try{e=await this._extensionClient.getChatRequestIdeState()}catch(i){console.error("Failed to add IDE state to exchange:",i)}return e?(s=[...s,{id:Tr(s)+1,type:Ht.IDE_STATE,ide_state_node:e}],{...t,structured_request_nodes:s}):t}async maybeAddHistorySummaryNode(){var y,M,F;const t=this._chatFlagModel.historySummaryPrompt;if(!t||t.trim()==="")return!1;const e=this._convertHistoryToExchanges(this.chatHistory),[s,i]=qo(e,this._chatFlagModel.historySummaryLowerChars,this._chatFlagModel.historySummaryMaxChars);if(s.length===0)return!1;const n=JSON.stringify(e).length,o=JSON.stringify(s).length,a=JSON.stringify(i).length,c={totalHistoryCharCount:n,totalHistoryExchangeCount:e.length,headCharCount:o,headExchangeCount:s.length,headLastRequestId:((y=s.at(-1))==null?void 0:y.request_id)??"",tailCharCount:a,tailExchangeCount:i.length,tailLastRequestId:((M=i.at(-1))==null?void 0:M.request_id)??"",summaryCharCount:0,summarizationDurationMs:0};let u=((F=s.at(-1))==null?void 0:F.response_nodes)??[],h=u.filter(R=>R.type===wt.TOOL_USE);h.length>0&&(s.at(-1).response_nodes=u.filter(R=>R.type!==wt.TOOL_USE)),console.info("Summarizing %d turns of conversation history.",s.length);const f=Date.now(),{responseText:p,requestId:_}=await this.sendSilentExchange({request_message:t,disableRetrieval:!0,disableSelectedCodeDetails:!0,chatHistory:s}),b=Date.now();c.summaryCharCount=p.length,c.summarizationDurationMs=b-f,this._extensionClient.reportAgentRequestEvent({eventName:kn.chatHistorySummarization,conversationId:this.id,requestId:_??"UNKNOWN_REQUEST_ID",chatHistoryLength:this.chatHistory.length,eventData:{chatHistorySummarizationData:c}});const S={chatItemType:Le.historySummary,summaryVersion:this.historySummaryVersion,request_id:_,request_message:t,response_text:p,structured_output_nodes:[{id:h.map(R=>R.id).reduce((R,nt)=>Math.max(R,nt),-1)+1,type:wt.RAW_RESPONSE,content:p},...h],status:ct.success,seen_state:se.seen,timestamp:new Date().toISOString()},x=this.chatHistory.findLastIndex(R=>R.request_id===s.at(-1).request_id)+1;console.info("Adding a history summary node at index %d",x);const m=[...this._state.chatHistory];return m.splice(x,0,S),this.update({chatHistory:m}),!0}_clearStaleHistorySummaryNodes(){this.update({chatHistory:this.chatHistory.filter(t=>!Rs(t)||t.summaryVersion===this.historySummaryVersion)})}}function xa(r,t){const e=(ms(r),r.fromTimestamp),s=(ms(r),r.toTimestamp),i=ms(r)&&r.revertTarget!==void 0;return{id:t,type:Ht.CHECKPOINT_REF,checkpoint_ref_node:{request_id:r.request_id||"",from_timestamp:e,to_timestamp:s,source:i?Po.CHECKPOINT_REVERT:void 0}}}function Rn(r){const t=(r.structured_output_nodes??[]).filter(e=>e.type===wt.RAW_RESPONSE||e.type===wt.TOOL_USE||e.type===wt.TOOL_USE_START).map(e=>e.type===wt.TOOL_USE_START?{...e,tool_use:{...e.tool_use,input_json:"{}"},type:wt.TOOL_USE}:e);return{request_message:r.request_message,response_text:r.response_text??"",request_id:r.request_id||"",request_nodes:r.structured_request_nodes??[],response_nodes:t}}function Tr(r){return r.length>0?Math.max(...r.map(t=>t.id)):0}function qn(r){var t;if(r.request_message.length>0&&!((t=r.structured_request_nodes)!=null&&t.some(e=>e.type===Ht.TEXT))){let e=r.structured_request_nodes??[];return e=[...e,{id:Tr(e)+1,type:Ht.TEXT,text_node:{content:r.request_message}}],{...r,structured_request_nodes:e}}return r}class wa{constructor(t=!0,e=setTimeout){l(this,"_notify",new Set);l(this,"_clearTimeout",t=>{t.timeoutId&&clearTimeout(t.timeoutId)});l(this,"_schedule",t=>{if(!this._started||t.date&&(t.timeout=t.date.getTime()-Date.now(),t.timeout<0))return;const e=this._setTimeout;t.timeoutId=e(this._handle,t.timeout,t)});l(this,"_handle",t=>{t.notify(),t.date?this._notify.delete(t):t.once||this._schedule(t)});l(this,"dispose",()=>{this._notify.forEach(this._clearTimeout),this._notify.clear()});this._started=t,this._setTimeout=e}start(){return this._started||(this._started=!0,this._notify.forEach(this._schedule)),this}stop(){return this._started=!1,this._notify.forEach(this._clearTimeout),this}get isStarted(){return this._started}set isStarted(t){t?this.start():this.stop()}once(t,e){return this._register(t,e,!0)}interval(t,e){return this._register(t,e,!1)}at(t,e){return this._register(0,e,!1,typeof t=="number"?new Date(Date.now()+t):t)}reschedule(){this._notify.forEach(t=>{this._clearTimeout(t),this._schedule(t)})}_register(t,e,s,i){if(!t&&!i)return()=>{};const n={timeout:t,notify:e,once:s,date:i};return this._notify.add(n),this._schedule(n),()=>{this._clearTimeout(n),this._notify.delete(n)}}}class Ma{constructor(t=0,e=0,s=new wa,i=ht("busy"),n=ht(!1)){l(this,"unsubNotify");l(this,"unsubMessage");l(this,"activity",()=>{this.idleStatus.set("busy"),this.idleScheduler.reschedule()});l(this,"focus",t=>{this.focusAfterIdle.set(t)});this._idleNotifyTimeout=t,this._idleMessageTimeout=e,this.idleScheduler=s,this.idleStatus=i,this.focusAfterIdle=n,this.idleNotifyTimeout=t,this.idleMessageTimeout=e}set idleMessageTimeout(t){var e;this._idleMessageTimeout!==t&&(this._idleMessageTimeout=t,(e=this.unsubMessage)==null||e.call(this),this.unsubMessage=this.idleScheduler.once(t,()=>{this.idleStatus.set("idle-message")}))}set idleNotifyTimeout(t){var e;this._idleNotifyTimeout!==t&&(this._idleNotifyTimeout=t,(e=this.unsubNotify)==null||e.call(this),this.unsubNotify=this.idleScheduler.once(t,()=>{this.idleStatus.set("idle-notify")}))}get idleMessageTimeout(){return this._idleMessageTimeout}get idleNotifyTimeout(){return this._idleNotifyTimeout}get notifyEnabled(){return this._idleNotifyTimeout>0}get messageEnabled(){return this._idleMessageTimeout>0}dispose(){var t,e;(t=this.unsubNotify)==null||t.call(this),(e=this.unsubMessage)==null||e.call(this),this.idleScheduler.dispose(),this.idleStatus.set("busy"),this.focusAfterIdle.set(!1)}}var Ps=(r=>(r.send="send",r.addTask="addTask",r))(Ps||{});class Ia{constructor(){l(this,"_mode",ht(Ps.send));l(this,"_currentMode",Ps.send);this._mode.subscribe(t=>{this._currentMode=t})}get mode(){return this._mode}setMode(t){this._mode.set(t)}getCurrentMode(){return this._currentMode}initializeFromState(t){t&&Object.values(Ps).includes(t)&&this._mode.set(t)}}const Us=ht("idle");class Xi{constructor(t,e,s,i={}){l(this,"_state",{currentConversationId:void 0,conversations:{},agentExecutionMode:"manual",isPanelCollapsed:!0,displayedAnnouncements:[]});l(this,"extensionClient");l(this,"_chatFlagsModel");l(this,"_currConversationModel");l(this,"_chatModeModel");l(this,"_sendModeModel");l(this,"_currentChatMode");l(this,"_flagsLoaded",ht(!1));l(this,"subscribers",new Set);l(this,"idleMessageModel",new Ma);l(this,"isPanelCollapsed");l(this,"agentExecutionMode");l(this,"sortConversationsBy");l(this,"displayedAnnouncements");l(this,"onLoaded",async()=>{var s,i;const t=await this.extensionClient.getChatInitData(),e=!this._chatFlagsModel.doUseNewDraftFunctionality&&(t.enableBackgroundAgents||t.enableNewThreadsList);this._chatFlagsModel.update({enableEditableHistory:t.enableEditableHistory??!1,enablePreferenceCollection:t.enablePreferenceCollection??!1,enableRetrievalDataCollection:t.enableRetrievalDataCollection??!1,enableDebugFeatures:t.enableDebugFeatures??!1,enableRichTextHistory:t.useRichTextHistory??!0,modelDisplayNameToId:t.modelDisplayNameToId??{},fullFeatured:t.fullFeatured??!0,smallSyncThreshold:t.smallSyncThreshold??Ao,bigSyncThreshold:t.bigSyncThreshold??Fo,enableExternalSourcesInChat:t.enableExternalSourcesInChat??!1,enableSmartPaste:t.enableSmartPaste??!1,enableDirectApply:t.enableDirectApply??!1,summaryTitles:t.summaryTitles??!1,suggestedEditsAvailable:t.suggestedEditsAvailable??!1,enableShareService:t.enableShareService??!1,maxTrackableFileCount:t.maxTrackableFileCount??Oo,enableDesignSystemRichTextEditor:t.enableDesignSystemRichTextEditor??!1,enableSources:t.enableSources??!1,enableChatMermaidDiagrams:t.enableChatMermaidDiagrams??!1,smartPastePrecomputeMode:t.smartPastePrecomputeMode??xo.visibleHover,useNewThreadsMenu:t.useNewThreadsMenu??!1,enableChatMermaidDiagramsMinVersion:t.enableChatMermaidDiagramsMinVersion??!1,idleNewSessionMessageTimeoutMs:t.idleNewSessionMessageTimeoutMs,idleNewSessionNotificationTimeoutMs:t.idleNewSessionNotificationTimeoutMs,enableChatMultimodal:t.enableChatMultimodal??!1,enableAgentMode:t.enableAgentMode??!1,agentMemoriesFilePathName:t.agentMemoriesFilePathName,enableRichCheckpointInfo:t.enableRichCheckpointInfo??!1,userTier:t.userTier??"unknown",truncateChatHistory:t.truncateChatHistory??!1,enableBackgroundAgents:t.enableBackgroundAgents??!1,enableNewThreadsList:t.enableNewThreadsList??!1,enableVirtualizedMessageList:t.enableVirtualizedMessageList??!1,customPersonalityPrompts:t.customPersonalityPrompts??{},enablePersonalities:t.enablePersonalities??!1,enableRules:t.enableRules??!1,memoryClassificationOnFirstToken:t.memoryClassificationOnFirstToken??!1,enableGenerateCommitMessage:t.enableGenerateCommitMessage??!1,doUseNewDraftFunctionality:(t.enableBackgroundAgents??!1)||(t.enableNewThreadsList??!1),enablePromptEnhancer:t.enablePromptEnhancer??!1,modelRegistry:t.modelRegistry??{},enableModelRegistry:t.enableModelRegistry??!1,enableTaskList:t.enableTaskList??!1,enableAgentAutoMode:t.enableAgentAutoMode??!1,enableExchangeStorage:t.enableExchangeStorage??!1,enableToolUseStateStorage:t.enableToolUseStateStorage??!1,clientAnnouncement:t.clientAnnouncement??"",useHistorySummary:t.useHistorySummary??!1,historySummaryMaxChars:t.historySummaryMaxChars??0,historySummaryLowerChars:t.historySummaryLowerChars??0,historySummaryPrompt:t.historySummaryPrompt??"",conversationHistorySizeThresholdBytes:t.conversationHistorySizeThresholdBytes??0,retryChatStreamTimeouts:t.retryChatStreamTimeouts??!1}),this._chatFlagsModel.enableAgentAutoMode||this.agentExecutionMode.set("manual"),this._currentChatMode=t.currentChatMode,e&&this.onDoUseNewDraftFunctionalityChanged(),this._flagsLoaded.set(!0),(i=(s=this.options).onLoaded)==null||i.call(s),this.notifySubscribers()});l(this,"subscribe",t=>(this.subscribers.add(t),t(this),()=>{this.subscribers.delete(t)}));l(this,"initialize",t=>{this._state={...this._state,...this._host.getState()},this._chatFlagsModel.fullFeatured&&((t==null?void 0:t.id)!==gi&&this.currentConversationId!==gi||(delete this._state.conversations[gi],this.setCurrentConversationToWelcome())),this._chatFlagsModel.subscribe(e=>{this.idleMessageModel.idleNotifyTimeout=e.idleNewSessionNotificationTimeoutMs,this.idleMessageModel.idleMessageTimeout=e.idleNewSessionMessageTimeoutMs}),this._state.conversations=Object.fromEntries(Object.entries(this._state.conversations).filter(([e,s])=>e===Ft||rt.isValid(s))),this.initializeIsShareableState(),t?this.setCurrentConversation(t.id):this.setCurrentConversation(this.currentConversationId),this.subscribe(()=>this.idleMessageModel.activity()),this.setState(this._state)});l(this,"initializeIsShareableState",()=>{const t={...this._state.conversations};for(const[e,s]of Object.entries(t)){if(s.isShareable)continue;const i=s.chatHistory.some(n=>Ye(n));t[e]={...s,isShareable:i}}this._state.conversations=t});l(this,"updateChatState",t=>{this._state={...this._state,...t};const e=this._state.conversations,s=new Set;for(const[i,n]of Object.entries(e))n.isPinned&&s.add(i);this.setState(this._state),this.notifySubscribers()});l(this,"saveImmediate",()=>{this._setStateWithDehydration(this._state)});l(this,"setState",Ti(t=>{this._setStateWithDehydration(t)},1e3,{maxWait:15e3}));l(this,"notifySubscribers",()=>{this.subscribers.forEach(t=>t(this))});l(this,"withWebviewClientEvent",(t,e)=>(...s)=>(this.extensionClient.reportWebviewClientEvent(t),e(...s)));l(this,"onDoUseNewDraftFunctionalityChanged",()=>{const t=!!this._state.conversations[Ft];if(this.currentConversationId&&this.currentConversationId!==Ft&&this._state.conversations[this.currentConversationId]&&rt.isEmpty(this._state.conversations[this.currentConversationId])&&!t){const e={...this._state.conversations[this.currentConversationId],id:Ft};this._state.conversations[Ft]=e,this.deleteConversationIds(new Set([this.currentConversationId])),this._state.currentConversationId=Ft,this._currConversationModel.setConversation(e)}});l(this,"setCurrentConversationToWelcome",()=>{this.setCurrentConversation(),this._currConversationModel.setName("Welcome to Augment"),this._currConversationModel.addChatItem({chatItemType:Le.educateFeatures,request_id:crypto.randomUUID(),seen_state:se.seen})});l(this,"popCurrentConversation",async()=>{var e,s;const t=this.currentConversationId;t&&await this.deleteConversation(t,((e=this.nextConversation)==null?void 0:e.id)??((s=this.previousConversation)==null?void 0:s.id))});l(this,"setCurrentConversation",async(t,e=!0,s)=>{if(t===this.currentConversationId&&(s!=null&&s.noopIfSameConversation))return;let i;if(this.flags.doUseNewDraftFunctionality){t===void 0&&(t=Ft);const o=this._state.conversations[t];i=o?await this._hydrateConversation(o):rt.create({personaType:await this._currConversationModel.decidePersonaType(),rootTaskUuid:s==null?void 0:s.newTaskUuid}),t===Ft&&(i.id=Ft),s!=null&&s.newTaskUuid&&(i.rootTaskUuid=s.newTaskUuid)}else if(t===void 0)this.deleteInvalidConversations(ts(this._currConversationModel)?"agent":"chat"),i=rt.create({personaType:await this._currConversationModel.decidePersonaType()});else{const o=this._state.conversations[t];i=o?await this._hydrateConversation(o):rt.create({personaType:await this._currConversationModel.decidePersonaType(),rootTaskUuid:s==null?void 0:s.newTaskUuid})}const n=this.conversations[this._currConversationModel.id]===void 0;this._currConversationModel.setConversation(i,!n,e),this._currConversationModel.recoverAllExchanges(),this._currConversationModel.resetTotalCharactersCache()});l(this,"saveConversation",(t,e)=>{this.updateChatState({conversations:{...this._state.conversations,[t.id]:t},currentConversationId:t.id}),e&&delete this._state.conversations[Ft]});l(this,"isConversationShareable",t=>{var e;return((e=this._state.conversations[t])==null?void 0:e.isShareable)??!0});l(this,"setSortConversationsBy",t=>{this.sortConversationsBy.set(t),this.updateChatState({})});l(this,"getConversationUrl",async t=>{const e=this._state.conversations[t];if(e.lastUrl)return e.lastUrl;Us.set("copying");const s=e==null?void 0:e.chatHistory,i=s.reduce((a,c)=>(Ye(c)&&a.push({request_id:c.request_id||"",request_message:c.request_message,response_text:c.response_text||""}),a),[]);if(i.length===0)throw new Error("No chat history to share");const n=rt.getDisplayName(e),o=await this.extensionClient.saveChat(t,i,n);if(o.data){let a=o.data.url;return this.updateChatState({conversations:{...this._state.conversations,[t]:{...e,lastUrl:a}}}),a}throw new Error("Failed to create URL")});l(this,"shareConversation",async t=>{if(t!==void 0)try{const e=await this.getConversationUrl(t);if(!e)return void Us.set("idle");navigator.clipboard.writeText(e),Us.set("copied")}catch{Us.set("failed")}});l(this,"deleteConversations",async(t,e=void 0,s=[],i)=>{const n=t.length+s.length;if(await this.extensionClient.openConfirmationModal({title:"Delete Conversation",message:`Are you sure you want to delete ${n>1?"these conversations":"this conversation"}?`,confirmButtonText:"Delete",cancelButtonText:"Cancel"})){if(t.length>0){const o=new Set(t);this.deleteConversationIds(o)}if(s.length>0&&i)for(const o of s)try{await i.deleteAgent(o,!0)}catch(a){console.error(`Failed to delete remote agent ${o}:`,a)}this.currentConversationId&&t.includes(this.currentConversationId)&&this.setCurrentConversation(e)}});l(this,"deleteConversation",async(t,e=void 0)=>{await this.deleteConversations([t],e)});l(this,"deleteConversationIds",async t=>{var s;const e=[];for(const i of t){const n=((s=this._state.conversations[i])==null?void 0:s.requestIds)??[];e.push(...n)}for(const i of Object.values(this._state.conversations))if(t.has(i.id)){for(const o of i.chatHistory)Ot(o)&&this.deleteImagesInExchange(o);const n=i.draftExchange;n&&this.deleteImagesInExchange(n)}for(const i of t){try{await this.extensionClient.deleteConversationExchanges(i)}catch(n){console.error(`Failed to delete exchanges for conversation ${i}:`,n)}if(this.flags.enableToolUseStateStorage)try{await this.extensionClient.deleteConversationToolUseStates(i)}catch(n){console.error(`Failed to delete tool use states for conversation ${i}:`,n)}}this.updateChatState({conversations:Object.fromEntries(Object.entries(this._state.conversations).filter(([i])=>!t.has(i)))}),this.extensionClient.clearMetadataFor({requestIds:e,conversationIds:Array.from(t)})});l(this,"deleteImagesInExchange",t=>{const e=new Set([...t.rich_text_json_repr?this.findImagesInJson(t.rich_text_json_repr):[],...t.structured_request_nodes?this.findImagesInStructuredRequest(t.structured_request_nodes):[]]);for(const s of e)this.deleteImage(s)});l(this,"findImagesInJson",t=>{const e=[],s=i=>{var n,o;if(i.type==="file"&&((n=i.attrs)!=null&&n.src)){const a=(o=i.attrs)==null?void 0:o.src;xr(a)&&e.push(i.attrs.src)}else if((i.type==="doc"||i.type==="paragraph")&&i.content)for(const a of i.content)s(a)};return s(t),e});l(this,"findImagesInStructuredRequest",t=>t.reduce((e,s)=>(s.type===Ht.IMAGE_ID&&s.image_id_node&&e.push(s.image_id_node.image_id),e),[]));l(this,"toggleConversationPinned",t=>{const e=this._state.conversations[t],s={...e,isPinned:!e.isPinned};this.updateChatState({conversations:{...this._state.conversations,[t]:s}}),t===this.currentConversationId&&this._currConversationModel.toggleIsPinned()});l(this,"renameConversation",(t,e)=>{const s={...this._state.conversations[t],name:e};this.updateChatState({conversations:{...this._state.conversations,[t]:s}}),t===this.currentConversationId&&this._currConversationModel.setName(e)});l(this,"smartPaste",(t,e,s,i)=>{const n=this._currConversationModel.historyTo(t,!0).filter(o=>Ye(o)).map(o=>({request_message:o.request_message,response_text:o.response_text||"",request_id:o.request_id||""}));this.extensionClient.smartPaste({generatedCode:e,chatHistory:n,targetFile:s??void 0,options:i})});l(this,"saveImage",async t=>await this.extensionClient.saveImage(t));l(this,"saveAttachment",async t=>await this.extensionClient.saveAttachment(t));l(this,"deleteImage",async t=>await this.extensionClient.deleteImage(t));l(this,"renderImage",async t=>await this.extensionClient.loadImage(t));this._asyncMsgSender=t,this._host=e,this._specialContextInputModel=s,this.options=i,this._chatFlagsModel=new ko(i.initialFlags),this.extensionClient=new To(this._host,this._asyncMsgSender,this._chatFlagsModel),this._currConversationModel=new rt(this.extensionClient,this._chatFlagsModel,this._specialContextInputModel,this.saveConversation),this._sendModeModel=new Ia,this.initialize(i.initialConversation);const n=this._state.isPanelCollapsed??this._state.isAgentEditsCollapsed??this._state.isTaskListCollapsed??!0;this.isPanelCollapsed=ht(n),this.agentExecutionMode=ht(this._state.agentExecutionMode??"manual"),this.sortConversationsBy=ht(this._state.sortConversationsBy??"lastMessageTimestamp"),this.displayedAnnouncements=ht(this._state.displayedAnnouncements??[]),this._sendModeModel.initializeFromState(this._state.sendMode),this.onLoaded()}setChatModeModel(t){this._chatModeModel=t}get currentChatMode(){return this._currentChatMode}setCurrentChatMode(t){this._currentChatMode=t,this.extensionClient.setLastUsedChatMode(t)}get flagsLoaded(){return this._flagsLoaded}async _setStateWithDehydration(t){const e={};if(t.conversations)for(const[s,i]of Object.entries(t.conversations))try{e[s]=await this._dehydrateConversation(i)}catch(n){console.warn(`Failed to dehydrate conversation ${s}:`,n),e[s]=i}this._host.setState({...t,conversations:e,isPanelCollapsed:lt(this.isPanelCollapsed),agentExecutionMode:lt(this.agentExecutionMode),sortConversationsBy:lt(this.sortConversationsBy),displayedAnnouncements:lt(this.displayedAnnouncements),sendMode:this._sendModeModel.getCurrentMode()})}get flags(){return this._chatFlagsModel}get specialContextInputModel(){return this._specialContextInputModel}get currentConversationId(){return this._state.currentConversationId}get currentConversationModel(){return this._currConversationModel}get conversations(){return this._state.conversations}get sendModeModel(){return this._sendModeModel}get chatModeModel(){return this._chatModeModel}orderedConversations(t,e="desc",s){const i=t||this._state.sortConversationsBy||"lastMessageTimestamp";let n=Object.values(this._state.conversations);return s&&(n=n.filter(s)),n.sort((o,a)=>{const c=rt.getTime(o,i).getTime(),u=rt.getTime(a,i).getTime();return e==="asc"?c-u:u-c})}get nextConversation(){if(!this.currentConversationId)return;const t=this.orderedConversations(),e=t.findIndex(s=>s.id===this.currentConversationId);return t.length>e+1?t[e+1]:void 0}get previousConversation(){if(!this.currentConversationId)return;const t=this.orderedConversations(),e=t.findIndex(s=>s.id===this.currentConversationId);return e>0?t[e-1]:void 0}get host(){return this._host}deleteInvalidConversations(t="all"){const e=Object.keys(this.conversations).filter(s=>{if(s===Ft)return!1;const i=!rt.isValid(this.conversations[s]),n=ts(this.conversations[s]);return i&&(t==="agent"&&n||t==="chat"&&!n||t==="all")});e.length&&this.deleteConversationIds(new Set(e))}get lastMessageTimestamp(){const t=this.currentConversationModel.lastExchange;return t==null?void 0:t.timestamp}handleMessageFromExtension(t){const e=t.data;if(e.type===at.newThread){if("data"in e&&e.data){const s=e.data.mode;(async()=>(await this.setCurrentConversation(),s&&this._chatModeModel?s.toLowerCase()==="agent"?await this._chatModeModel.setToAgent("manual"):s.toLowerCase()==="chat"?this._chatModeModel.setToChat():console.warn("Unknown chat mode:",s):s&&console.warn("ChatModeModel not available, cannot set mode:",s)))()}else this.setCurrentConversation();return!0}return!1}async _dehydrateConversation(t){let e=t;return this.flags.enableExchangeStorage&&(e=await this._dehydrateExchanges(e)),this.flags.enableToolUseStateStorage&&(e=await this._dehydrateToolUseStates(e)),e}async _dehydrateExchanges(t){const e=[],s=[];for(const i of t.chatHistory)if(Ot(i)){const n=i,o=n.request_id||crypto.randomUUID(),a={request_message:n.request_message,response_text:n.response_text||"",request_id:o,request_nodes:n.structured_request_nodes,response_nodes:n.structured_output_nodes,uuid:o,conversationId:t.id,status:n.status===ct.success?"success":n.status===ct.failed?"failed":"sent",timestamp:n.timestamp||new Date().toISOString(),seen_state:n.seen_state===se.seen?"seen":"unseen"};e.push(a);const c={chatItemType:Le.exchangePointer,exchangeUuid:o,timestamp:n.timestamp,request_message:n.request_message,status:n.status,hasResponse:!!n.response_text,isStreaming:n.status===ct.sent,seen_state:n.seen_state};s.push(c)}else s.push(i);if(e.length>0)try{await this.extensionClient.saveExchanges(t.id,e)}catch{return t}return{...t,chatHistory:s}}async _dehydrateToolUseStates(t){if(!this.flags.enableToolUseStateStorage||!t.toolUseStates||Object.keys(t.toolUseStates).length===0)return t;try{return await this.extensionClient.saveToolUseStates(t.id,t.toolUseStates),{...t,toolUseStates:{}}}catch(e){return console.warn(`Failed to store tool use states for conversation ${t.id}:`,e),t}}async _hydrateConversation(t){let e=t;return this.flags.enableExchangeStorage&&(e=await this._hydrateExchanges(e)),this.flags.enableToolUseStateStorage&&(e=await this._hydrateToolUseStates(e)),e}async _hydrateExchanges(t){const e=[];for(const n of t.chatHistory)Mi(n)&&e.push(n.exchangeUuid);let s=new Map;if(e.length>0)try{s=new Map((await this.extensionClient.loadExchanges(t.id,e)).map(n=>[n.uuid,n]))}catch(n){console.warn(`Failed to load exchanges for conversation ${t.id}:`,n)}const i=t.chatHistory.map(n=>{if(Mi(n)){const o=s.get(n.exchangeUuid);return o?{chatItemType:void 0,timestamp:o.timestamp,request_message:o.request_message,response_text:o.response_text||"",status:o.status==="success"?ct.success:o.status==="failed"?ct.failed:ct.sent,seen_state:o.seen_state==="seen"?se.seen:se.unseen,request_id:o.request_id,structured_request_nodes:o.request_nodes,structured_output_nodes:o.response_nodes}:{chatItemType:void 0,timestamp:n.timestamp,request_message:n.request_message||"",response_text:"",status:n.status||ct.sent,seen_state:n.seen_state||se.unseen,request_id:n.request_id}}return n});return{...t,chatHistory:i}}async _hydrateToolUseStates(t){if(!this.flags.enableToolUseStateStorage)return t;try{const e=await this.extensionClient.loadConversationToolUseStates(t.id);return{...t,toolUseStates:e}}catch(e){return console.warn(`Failed to load tool use states for conversation ${t.id}:`,e),t}}}l(Xi,"NEW_AGENT_KEY",Ft);function Un(r,t){let e,s,i=t;const n=()=>i.editor.getModifiedEditor(),o=()=>{const{afterLineNumber:a}=i,c=n();if(a===void 0)return void c.changeViewZones(h=>{e&&c&&s&&h.removeZone(s)});const u={...i,afterLineNumber:a,domNode:r,suppressMouseDown:!0};c==null||c.changeViewZones(h=>{e&&s&&h.removeZone(s),s=h.addZone(u),e=u})};return o(),{update:a=>{i=a,o()},destroy:()=>{const a=n();a.changeViewZones(c=>{if(e&&a&&s)try{c.removeZone(s)}catch(u){if(u instanceof Error){if(u.message.includes("Cannot read properties of null (reading 'removeChild')"))return}else console.warn(`Failed to remove view zone: ${u}`)}})}}}var Ie=(r=>(r.edit="edit",r.instruction="instruction",r))(Ie||{}),Fi=(r=>(r[r.instructionDrawer=0]="instructionDrawer",r[r.chunkActionPanel=1]="chunkActionPanel",r))(Fi||{});const Qe=typeof performance=="object"&&performance&&typeof performance.now=="function"?performance:Date,jn=new Set,Oi=typeof process=="object"&&process?process:{},Ar=(r,t,e,s)=>{typeof Oi.emitWarning=="function"?Oi.emitWarning(r,t,e,s):console.error(`[${e}] ${t}: ${r}`)};let Js=globalThis.AbortController,Pn=globalThis.AbortSignal;var ur;if(Js===void 0){Pn=class{constructor(){l(this,"onabort");l(this,"_onabort",[]);l(this,"reason");l(this,"aborted",!1)}addEventListener(e,s){this._onabort.push(s)}},Js=class{constructor(){l(this,"signal",new Pn);t()}abort(e){var s,i;if(!this.signal.aborted){this.signal.reason=e,this.signal.aborted=!0;for(const n of this.signal._onabort)n(e);(i=(s=this.signal).onabort)==null||i.call(s,e)}}};let r=((ur=Oi.env)==null?void 0:ur.LRU_CACHE_IGNORE_AC_WARNING)!=="1";const t=()=>{r&&(r=!1,Ar("AbortController is not defined. If using lru-cache in node 14, load an AbortController polyfill from the `node-abort-controller` package. A minimal polyfill is provided for use by LRUCache.fetch(), but it should not be relied upon in other contexts (eg, passing it to other APIs that use AbortController/AbortSignal might have undesirable effects). You may disable this with LRU_CACHE_IGNORE_AC_WARNING=1 in the env.","NO_ABORT_CONTROLLER","ENOTSUP",t))}}const ye=r=>r&&r===Math.floor(r)&&r>0&&isFinite(r),Fr=r=>ye(r)?r<=Math.pow(2,8)?Uint8Array:r<=Math.pow(2,16)?Uint16Array:r<=Math.pow(2,32)?Uint32Array:r<=Number.MAX_SAFE_INTEGER?Hs:null:null;class Hs extends Array{constructor(t){super(t),this.fill(0)}}var es;const Re=class Re{constructor(t,e){l(this,"heap");l(this,"length");if(!d(Re,es))throw new TypeError("instantiate Stack using Stack.create(n)");this.heap=new e(t),this.length=0}static create(t){const e=Fr(t);if(!e)return[];D(Re,es,!0);const s=new Re(t,e);return D(Re,es,!1),s}push(t){this.heap[this.length++]=t}pop(){return this.heap[--this.length]}};es=new WeakMap,V(Re,es,!1);let Ni=Re;var dr,fr,Gt,Nt,Vt,Bt,ss,is,_t,Kt,ft,it,j,Et,Lt,xt,Ct,Qt,St,Zt,Xt,Dt,Jt,xe,kt,I,Di,qe,le,ys,Rt,Or,Ue,ns,vs,ve,$e,Ri,zs,Ws,st,qi,ps,be,Ui;const tn=class tn{constructor(t){V(this,I);V(this,Gt);V(this,Nt);V(this,Vt);V(this,Bt);V(this,ss);V(this,is);l(this,"ttl");l(this,"ttlResolution");l(this,"ttlAutopurge");l(this,"updateAgeOnGet");l(this,"updateAgeOnHas");l(this,"allowStale");l(this,"noDisposeOnSet");l(this,"noUpdateTTL");l(this,"maxEntrySize");l(this,"sizeCalculation");l(this,"noDeleteOnFetchRejection");l(this,"noDeleteOnStaleGet");l(this,"allowStaleOnFetchAbort");l(this,"allowStaleOnFetchRejection");l(this,"ignoreFetchAbort");V(this,_t);V(this,Kt);V(this,ft);V(this,it);V(this,j);V(this,Et);V(this,Lt);V(this,xt);V(this,Ct);V(this,Qt);V(this,St);V(this,Zt);V(this,Xt);V(this,Dt);V(this,Jt);V(this,xe);V(this,kt);V(this,qe,()=>{});V(this,le,()=>{});V(this,ys,()=>{});V(this,Rt,()=>!1);V(this,Ue,t=>{});V(this,ns,(t,e,s)=>{});V(this,vs,(t,e,s,i)=>{if(s||i)throw new TypeError("cannot set size without setting maxSize or maxEntrySize on cache");return 0});l(this,dr,"LRUCache");const{max:e=0,ttl:s,ttlResolution:i=1,ttlAutopurge:n,updateAgeOnGet:o,updateAgeOnHas:a,allowStale:c,dispose:u,disposeAfter:h,noDisposeOnSet:f,noUpdateTTL:p,maxSize:_=0,maxEntrySize:b=0,sizeCalculation:S,fetchMethod:x,memoMethod:m,noDeleteOnFetchRejection:y,noDeleteOnStaleGet:M,allowStaleOnFetchRejection:F,allowStaleOnFetchAbort:R,ignoreFetchAbort:nt}=t;if(e!==0&&!ye(e))throw new TypeError("max option must be a nonnegative integer");const H=e?Fr(e):Array;if(!H)throw new Error("invalid max value: "+e);if(D(this,Gt,e),D(this,Nt,_),this.maxEntrySize=b||d(this,Nt),this.sizeCalculation=S,this.sizeCalculation){if(!d(this,Nt)&&!this.maxEntrySize)throw new TypeError("cannot set sizeCalculation without setting maxSize or maxEntrySize");if(typeof this.sizeCalculation!="function")throw new TypeError("sizeCalculation set to non-function")}if(m!==void 0&&typeof m!="function")throw new TypeError("memoMethod must be a function if defined");if(D(this,is,m),x!==void 0&&typeof x!="function")throw new TypeError("fetchMethod must be a function if specified");if(D(this,ss,x),D(this,xe,!!x),D(this,ft,new Map),D(this,it,new Array(e).fill(void 0)),D(this,j,new Array(e).fill(void 0)),D(this,Et,new H(e)),D(this,Lt,new H(e)),D(this,xt,0),D(this,Ct,0),D(this,Qt,Ni.create(e)),D(this,_t,0),D(this,Kt,0),typeof u=="function"&&D(this,Vt,u),typeof h=="function"?(D(this,Bt,h),D(this,St,[])):(D(this,Bt,void 0),D(this,St,void 0)),D(this,Jt,!!d(this,Vt)),D(this,kt,!!d(this,Bt)),this.noDisposeOnSet=!!f,this.noUpdateTTL=!!p,this.noDeleteOnFetchRejection=!!y,this.allowStaleOnFetchRejection=!!F,this.allowStaleOnFetchAbort=!!R,this.ignoreFetchAbort=!!nt,this.maxEntrySize!==0){if(d(this,Nt)!==0&&!ye(d(this,Nt)))throw new TypeError("maxSize must be a positive integer if specified");if(!ye(this.maxEntrySize))throw new TypeError("maxEntrySize must be a positive integer if specified");A(this,I,Or).call(this)}if(this.allowStale=!!c,this.noDeleteOnStaleGet=!!M,this.updateAgeOnGet=!!o,this.updateAgeOnHas=!!a,this.ttlResolution=ye(i)||i===0?i:1,this.ttlAutopurge=!!n,this.ttl=s||0,this.ttl){if(!ye(this.ttl))throw new TypeError("ttl must be a positive integer if specified");A(this,I,Di).call(this)}if(d(this,Gt)===0&&this.ttl===0&&d(this,Nt)===0)throw new TypeError("At least one of max, maxSize, or ttl is required");if(!this.ttlAutopurge&&!d(this,Gt)&&!d(this,Nt)){const G="LRU_CACHE_UNBOUNDED";(P=>!jn.has(P))(G)&&(jn.add(G),Ar("TTL caching without ttlAutopurge, max, or maxSize can result in unbounded memory consumption.","UnboundedCacheWarning",G,tn))}}static unsafeExposeInternals(t){return{starts:d(t,Xt),ttls:d(t,Dt),sizes:d(t,Zt),keyMap:d(t,ft),keyList:d(t,it),valList:d(t,j),next:d(t,Et),prev:d(t,Lt),get head(){return d(t,xt)},get tail(){return d(t,Ct)},free:d(t,Qt),isBackgroundFetch:e=>{var s;return A(s=t,I,st).call(s,e)},backgroundFetch:(e,s,i,n)=>{var o;return A(o=t,I,Ws).call(o,e,s,i,n)},moveToTail:e=>{var s;return A(s=t,I,ps).call(s,e)},indexes:e=>{var s;return A(s=t,I,ve).call(s,e)},rindexes:e=>{var s;return A(s=t,I,$e).call(s,e)},isStale:e=>{var s;return d(s=t,Rt).call(s,e)}}}get max(){return d(this,Gt)}get maxSize(){return d(this,Nt)}get calculatedSize(){return d(this,Kt)}get size(){return d(this,_t)}get fetchMethod(){return d(this,ss)}get memoMethod(){return d(this,is)}get dispose(){return d(this,Vt)}get disposeAfter(){return d(this,Bt)}getRemainingTTL(t){return d(this,ft).has(t)?1/0:0}*entries(){for(const t of A(this,I,ve).call(this))d(this,j)[t]===void 0||d(this,it)[t]===void 0||A(this,I,st).call(this,d(this,j)[t])||(yield[d(this,it)[t],d(this,j)[t]])}*rentries(){for(const t of A(this,I,$e).call(this))d(this,j)[t]===void 0||d(this,it)[t]===void 0||A(this,I,st).call(this,d(this,j)[t])||(yield[d(this,it)[t],d(this,j)[t]])}*keys(){for(const t of A(this,I,ve).call(this)){const e=d(this,it)[t];e===void 0||A(this,I,st).call(this,d(this,j)[t])||(yield e)}}*rkeys(){for(const t of A(this,I,$e).call(this)){const e=d(this,it)[t];e===void 0||A(this,I,st).call(this,d(this,j)[t])||(yield e)}}*values(){for(const t of A(this,I,ve).call(this))d(this,j)[t]===void 0||A(this,I,st).call(this,d(this,j)[t])||(yield d(this,j)[t])}*rvalues(){for(const t of A(this,I,$e).call(this))d(this,j)[t]===void 0||A(this,I,st).call(this,d(this,j)[t])||(yield d(this,j)[t])}[(fr=Symbol.iterator,dr=Symbol.toStringTag,fr)](){return this.entries()}find(t,e={}){for(const s of A(this,I,ve).call(this)){const i=d(this,j)[s],n=A(this,I,st).call(this,i)?i.__staleWhileFetching:i;if(n!==void 0&&t(n,d(this,it)[s],this))return this.get(d(this,it)[s],e)}}forEach(t,e=this){for(const s of A(this,I,ve).call(this)){const i=d(this,j)[s],n=A(this,I,st).call(this,i)?i.__staleWhileFetching:i;n!==void 0&&t.call(e,n,d(this,it)[s],this)}}rforEach(t,e=this){for(const s of A(this,I,$e).call(this)){const i=d(this,j)[s],n=A(this,I,st).call(this,i)?i.__staleWhileFetching:i;n!==void 0&&t.call(e,n,d(this,it)[s],this)}}purgeStale(){let t=!1;for(const e of A(this,I,$e).call(this,{allowStale:!0}))d(this,Rt).call(this,e)&&(A(this,I,be).call(this,d(this,it)[e],"expire"),t=!0);return t}info(t){const e=d(this,ft).get(t);if(e===void 0)return;const s=d(this,j)[e],i=A(this,I,st).call(this,s)?s.__staleWhileFetching:s;if(i===void 0)return;const n={value:i};if(d(this,Dt)&&d(this,Xt)){const o=d(this,Dt)[e],a=d(this,Xt)[e];if(o&&a){const c=o-(Qe.now()-a);n.ttl=c,n.start=Date.now()}}return d(this,Zt)&&(n.size=d(this,Zt)[e]),n}dump(){const t=[];for(const e of A(this,I,ve).call(this,{allowStale:!0})){const s=d(this,it)[e],i=d(this,j)[e],n=A(this,I,st).call(this,i)?i.__staleWhileFetching:i;if(n===void 0||s===void 0)continue;const o={value:n};if(d(this,Dt)&&d(this,Xt)){o.ttl=d(this,Dt)[e];const a=Qe.now()-d(this,Xt)[e];o.start=Math.floor(Date.now()-a)}d(this,Zt)&&(o.size=d(this,Zt)[e]),t.unshift([s,o])}return t}load(t){this.clear();for(const[e,s]of t){if(s.start){const i=Date.now()-s.start;s.start=Qe.now()-i}this.set(e,s.value,s)}}set(t,e,s={}){var p,_,b,S,x;if(e===void 0)return this.delete(t),this;const{ttl:i=this.ttl,start:n,noDisposeOnSet:o=this.noDisposeOnSet,sizeCalculation:a=this.sizeCalculation,status:c}=s;let{noUpdateTTL:u=this.noUpdateTTL}=s;const h=d(this,vs).call(this,t,e,s.size||0,a);if(this.maxEntrySize&&h>this.maxEntrySize)return c&&(c.set="miss",c.maxEntrySizeExceeded=!0),A(this,I,be).call(this,t,"set"),this;let f=d(this,_t)===0?void 0:d(this,ft).get(t);if(f===void 0)f=d(this,_t)===0?d(this,Ct):d(this,Qt).length!==0?d(this,Qt).pop():d(this,_t)===d(this,Gt)?A(this,I,zs).call(this,!1):d(this,_t),d(this,it)[f]=t,d(this,j)[f]=e,d(this,ft).set(t,f),d(this,Et)[d(this,Ct)]=f,d(this,Lt)[f]=d(this,Ct),D(this,Ct,f),Ds(this,_t)._++,d(this,ns).call(this,f,h,c),c&&(c.set="add"),u=!1;else{A(this,I,ps).call(this,f);const m=d(this,j)[f];if(e!==m){if(d(this,xe)&&A(this,I,st).call(this,m)){m.__abortController.abort(new Error("replaced"));const{__staleWhileFetching:y}=m;y===void 0||o||(d(this,Jt)&&((p=d(this,Vt))==null||p.call(this,y,t,"set")),d(this,kt)&&((_=d(this,St))==null||_.push([y,t,"set"])))}else o||(d(this,Jt)&&((b=d(this,Vt))==null||b.call(this,m,t,"set")),d(this,kt)&&((S=d(this,St))==null||S.push([m,t,"set"])));if(d(this,Ue).call(this,f),d(this,ns).call(this,f,h,c),d(this,j)[f]=e,c){c.set="replace";const y=m&&A(this,I,st).call(this,m)?m.__staleWhileFetching:m;y!==void 0&&(c.oldValue=y)}}else c&&(c.set="update")}if(i===0||d(this,Dt)||A(this,I,Di).call(this),d(this,Dt)&&(u||d(this,ys).call(this,f,i,n),c&&d(this,le).call(this,c,f)),!o&&d(this,kt)&&d(this,St)){const m=d(this,St);let y;for(;y=m==null?void 0:m.shift();)(x=d(this,Bt))==null||x.call(this,...y)}return this}pop(){var t;try{for(;d(this,_t);){const e=d(this,j)[d(this,xt)];if(A(this,I,zs).call(this,!0),A(this,I,st).call(this,e)){if(e.__staleWhileFetching)return e.__staleWhileFetching}else if(e!==void 0)return e}}finally{if(d(this,kt)&&d(this,St)){const e=d(this,St);let s;for(;s=e==null?void 0:e.shift();)(t=d(this,Bt))==null||t.call(this,...s)}}}has(t,e={}){const{updateAgeOnHas:s=this.updateAgeOnHas,status:i}=e,n=d(this,ft).get(t);if(n!==void 0){const o=d(this,j)[n];if(A(this,I,st).call(this,o)&&o.__staleWhileFetching===void 0)return!1;if(!d(this,Rt).call(this,n))return s&&d(this,qe).call(this,n),i&&(i.has="hit",d(this,le).call(this,i,n)),!0;i&&(i.has="stale",d(this,le).call(this,i,n))}else i&&(i.has="miss");return!1}peek(t,e={}){const{allowStale:s=this.allowStale}=e,i=d(this,ft).get(t);if(i===void 0||!s&&d(this,Rt).call(this,i))return;const n=d(this,j)[i];return A(this,I,st).call(this,n)?n.__staleWhileFetching:n}async fetch(t,e={}){const{allowStale:s=this.allowStale,updateAgeOnGet:i=this.updateAgeOnGet,noDeleteOnStaleGet:n=this.noDeleteOnStaleGet,ttl:o=this.ttl,noDisposeOnSet:a=this.noDisposeOnSet,size:c=0,sizeCalculation:u=this.sizeCalculation,noUpdateTTL:h=this.noUpdateTTL,noDeleteOnFetchRejection:f=this.noDeleteOnFetchRejection,allowStaleOnFetchRejection:p=this.allowStaleOnFetchRejection,ignoreFetchAbort:_=this.ignoreFetchAbort,allowStaleOnFetchAbort:b=this.allowStaleOnFetchAbort,context:S,forceRefresh:x=!1,status:m,signal:y}=e;if(!d(this,xe))return m&&(m.fetch="get"),this.get(t,{allowStale:s,updateAgeOnGet:i,noDeleteOnStaleGet:n,status:m});const M={allowStale:s,updateAgeOnGet:i,noDeleteOnStaleGet:n,ttl:o,noDisposeOnSet:a,size:c,sizeCalculation:u,noUpdateTTL:h,noDeleteOnFetchRejection:f,allowStaleOnFetchRejection:p,allowStaleOnFetchAbort:b,ignoreFetchAbort:_,status:m,signal:y};let F=d(this,ft).get(t);if(F===void 0){m&&(m.fetch="miss");const R=A(this,I,Ws).call(this,t,F,M,S);return R.__returned=R}{const R=d(this,j)[F];if(A(this,I,st).call(this,R)){const P=s&&R.__staleWhileFetching!==void 0;return m&&(m.fetch="inflight",P&&(m.returnedStale=!0)),P?R.__staleWhileFetching:R.__returned=R}const nt=d(this,Rt).call(this,F);if(!x&&!nt)return m&&(m.fetch="hit"),A(this,I,ps).call(this,F),i&&d(this,qe).call(this,F),m&&d(this,le).call(this,m,F),R;const H=A(this,I,Ws).call(this,t,F,M,S),G=H.__staleWhileFetching!==void 0&&s;return m&&(m.fetch=nt?"stale":"refresh",G&&nt&&(m.returnedStale=!0)),G?H.__staleWhileFetching:H.__returned=H}}async forceFetch(t,e={}){const s=await this.fetch(t,e);if(s===void 0)throw new Error("fetch() returned undefined");return s}memo(t,e={}){const s=d(this,is);if(!s)throw new Error("no memoMethod provided to constructor");const{context:i,forceRefresh:n,...o}=e,a=this.get(t,o);if(!n&&a!==void 0)return a;const c=s(t,a,{options:o,context:i});return this.set(t,c,o),c}get(t,e={}){const{allowStale:s=this.allowStale,updateAgeOnGet:i=this.updateAgeOnGet,noDeleteOnStaleGet:n=this.noDeleteOnStaleGet,status:o}=e,a=d(this,ft).get(t);if(a!==void 0){const c=d(this,j)[a],u=A(this,I,st).call(this,c);return o&&d(this,le).call(this,o,a),d(this,Rt).call(this,a)?(o&&(o.get="stale"),u?(o&&s&&c.__staleWhileFetching!==void 0&&(o.returnedStale=!0),s?c.__staleWhileFetching:void 0):(n||A(this,I,be).call(this,t,"expire"),o&&s&&(o.returnedStale=!0),s?c:void 0)):(o&&(o.get="hit"),u?c.__staleWhileFetching:(A(this,I,ps).call(this,a),i&&d(this,qe).call(this,a),c))}o&&(o.get="miss")}delete(t){return A(this,I,be).call(this,t,"delete")}clear(){return A(this,I,Ui).call(this,"delete")}};Gt=new WeakMap,Nt=new WeakMap,Vt=new WeakMap,Bt=new WeakMap,ss=new WeakMap,is=new WeakMap,_t=new WeakMap,Kt=new WeakMap,ft=new WeakMap,it=new WeakMap,j=new WeakMap,Et=new WeakMap,Lt=new WeakMap,xt=new WeakMap,Ct=new WeakMap,Qt=new WeakMap,St=new WeakMap,Zt=new WeakMap,Xt=new WeakMap,Dt=new WeakMap,Jt=new WeakMap,xe=new WeakMap,kt=new WeakMap,I=new WeakSet,Di=function(){const t=new Hs(d(this,Gt)),e=new Hs(d(this,Gt));D(this,Dt,t),D(this,Xt,e),D(this,ys,(n,o,a=Qe.now())=>{if(e[n]=o!==0?a:0,t[n]=o,o!==0&&this.ttlAutopurge){const c=setTimeout(()=>{d(this,Rt).call(this,n)&&A(this,I,be).call(this,d(this,it)[n],"expire")},o+1);c.unref&&c.unref()}}),D(this,qe,n=>{e[n]=t[n]!==0?Qe.now():0}),D(this,le,(n,o)=>{if(t[o]){const a=t[o],c=e[o];if(!a||!c)return;n.ttl=a,n.start=c,n.now=s||i();const u=n.now-c;n.remainingTTL=a-u}});let s=0;const i=()=>{const n=Qe.now();if(this.ttlResolution>0){s=n;const o=setTimeout(()=>s=0,this.ttlResolution);o.unref&&o.unref()}return n};this.getRemainingTTL=n=>{const o=d(this,ft).get(n);if(o===void 0)return 0;const a=t[o],c=e[o];return!a||!c?1/0:a-((s||i())-c)},D(this,Rt,n=>{const o=e[n],a=t[n];return!!a&&!!o&&(s||i())-o>a})},qe=new WeakMap,le=new WeakMap,ys=new WeakMap,Rt=new WeakMap,Or=function(){const t=new Hs(d(this,Gt));D(this,Kt,0),D(this,Zt,t),D(this,Ue,e=>{D(this,Kt,d(this,Kt)-t[e]),t[e]=0}),D(this,vs,(e,s,i,n)=>{if(A(this,I,st).call(this,s))return 0;if(!ye(i)){if(!n)throw new TypeError("invalid size value (must be positive integer). When maxSize or maxEntrySize is used, sizeCalculation or size must be set.");if(typeof n!="function")throw new TypeError("sizeCalculation must be a function");if(i=n(s,e),!ye(i))throw new TypeError("sizeCalculation return invalid (expect positive integer)")}return i}),D(this,ns,(e,s,i)=>{if(t[e]=s,d(this,Nt)){const n=d(this,Nt)-t[e];for(;d(this,Kt)>n;)A(this,I,zs).call(this,!0)}D(this,Kt,d(this,Kt)+t[e]),i&&(i.entrySize=s,i.totalCalculatedSize=d(this,Kt))})},Ue=new WeakMap,ns=new WeakMap,vs=new WeakMap,ve=function*({allowStale:t=this.allowStale}={}){if(d(this,_t))for(let e=d(this,Ct);A(this,I,Ri).call(this,e)&&(!t&&d(this,Rt).call(this,e)||(yield e),e!==d(this,xt));)e=d(this,Lt)[e]},$e=function*({allowStale:t=this.allowStale}={}){if(d(this,_t))for(let e=d(this,xt);A(this,I,Ri).call(this,e)&&(!t&&d(this,Rt).call(this,e)||(yield e),e!==d(this,Ct));)e=d(this,Et)[e]},Ri=function(t){return t!==void 0&&d(this,ft).get(d(this,it)[t])===t},zs=function(t){var n,o;const e=d(this,xt),s=d(this,it)[e],i=d(this,j)[e];return d(this,xe)&&A(this,I,st).call(this,i)?i.__abortController.abort(new Error("evicted")):(d(this,Jt)||d(this,kt))&&(d(this,Jt)&&((n=d(this,Vt))==null||n.call(this,i,s,"evict")),d(this,kt)&&((o=d(this,St))==null||o.push([i,s,"evict"]))),d(this,Ue).call(this,e),t&&(d(this,it)[e]=void 0,d(this,j)[e]=void 0,d(this,Qt).push(e)),d(this,_t)===1?(D(this,xt,D(this,Ct,0)),d(this,Qt).length=0):D(this,xt,d(this,Et)[e]),d(this,ft).delete(s),Ds(this,_t)._--,e},Ws=function(t,e,s,i){const n=e===void 0?void 0:d(this,j)[e];if(A(this,I,st).call(this,n))return n;const o=new Js,{signal:a}=s;a==null||a.addEventListener("abort",()=>o.abort(a.reason),{signal:o.signal});const c={signal:o.signal,options:s,context:i},u=(_,b=!1)=>{const{aborted:S}=o.signal,x=s.ignoreFetchAbort&&_!==void 0;if(s.status&&(S&&!b?(s.status.fetchAborted=!0,s.status.fetchError=o.signal.reason,x&&(s.status.fetchAbortIgnored=!0)):s.status.fetchResolved=!0),S&&!x&&!b)return h(o.signal.reason);const m=f;return d(this,j)[e]===f&&(_===void 0?m.__staleWhileFetching?d(this,j)[e]=m.__staleWhileFetching:A(this,I,be).call(this,t,"fetch"):(s.status&&(s.status.fetchUpdated=!0),this.set(t,_,c.options))),_},h=_=>{const{aborted:b}=o.signal,S=b&&s.allowStaleOnFetchAbort,x=S||s.allowStaleOnFetchRejection,m=x||s.noDeleteOnFetchRejection,y=f;if(d(this,j)[e]===f&&(!m||y.__staleWhileFetching===void 0?A(this,I,be).call(this,t,"fetch"):S||(d(this,j)[e]=y.__staleWhileFetching)),x)return s.status&&y.__staleWhileFetching!==void 0&&(s.status.returnedStale=!0),y.__staleWhileFetching;if(y.__returned===y)throw _};s.status&&(s.status.fetchDispatched=!0);const f=new Promise((_,b)=>{var x;const S=(x=d(this,ss))==null?void 0:x.call(this,t,n,c);S&&S instanceof Promise&&S.then(m=>_(m===void 0?void 0:m),b),o.signal.addEventListener("abort",()=>{s.ignoreFetchAbort&&!s.allowStaleOnFetchAbort||(_(void 0),s.allowStaleOnFetchAbort&&(_=m=>u(m,!0)))})}).then(u,_=>(s.status&&(s.status.fetchRejected=!0,s.status.fetchError=_),h(_))),p=Object.assign(f,{__abortController:o,__staleWhileFetching:n,__returned:void 0});return e===void 0?(this.set(t,p,{...c.options,status:void 0}),e=d(this,ft).get(t)):d(this,j)[e]=p,p},st=function(t){if(!d(this,xe))return!1;const e=t;return!!e&&e instanceof Promise&&e.hasOwnProperty("__staleWhileFetching")&&e.__abortController instanceof Js},qi=function(t,e){d(this,Lt)[e]=t,d(this,Et)[t]=e},ps=function(t){t!==d(this,Ct)&&(t===d(this,xt)?D(this,xt,d(this,Et)[t]):A(this,I,qi).call(this,d(this,Lt)[t],d(this,Et)[t]),A(this,I,qi).call(this,d(this,Ct),t),D(this,Ct,t))},be=function(t,e){var i,n,o,a;let s=!1;if(d(this,_t)!==0){const c=d(this,ft).get(t);if(c!==void 0)if(s=!0,d(this,_t)===1)A(this,I,Ui).call(this,e);else{d(this,Ue).call(this,c);const u=d(this,j)[c];if(A(this,I,st).call(this,u)?u.__abortController.abort(new Error("deleted")):(d(this,Jt)||d(this,kt))&&(d(this,Jt)&&((i=d(this,Vt))==null||i.call(this,u,t,e)),d(this,kt)&&((n=d(this,St))==null||n.push([u,t,e]))),d(this,ft).delete(t),d(this,it)[c]=void 0,d(this,j)[c]=void 0,c===d(this,Ct))D(this,Ct,d(this,Lt)[c]);else if(c===d(this,xt))D(this,xt,d(this,Et)[c]);else{const h=d(this,Lt)[c];d(this,Et)[h]=d(this,Et)[c];const f=d(this,Et)[c];d(this,Lt)[f]=d(this,Lt)[c]}Ds(this,_t)._--,d(this,Qt).push(c)}}if(d(this,kt)&&((o=d(this,St))!=null&&o.length)){const c=d(this,St);let u;for(;u=c==null?void 0:c.shift();)(a=d(this,Bt))==null||a.call(this,...u)}return s},Ui=function(t){var e,s,i;for(const n of A(this,I,$e).call(this,{allowStale:!0})){const o=d(this,j)[n];if(A(this,I,st).call(this,o))o.__abortController.abort(new Error("deleted"));else{const a=d(this,it)[n];d(this,Jt)&&((e=d(this,Vt))==null||e.call(this,o,a,t)),d(this,kt)&&((s=d(this,St))==null||s.push([o,a,t]))}}if(d(this,ft).clear(),d(this,j).fill(void 0),d(this,it).fill(void 0),d(this,Dt)&&d(this,Xt)&&(d(this,Dt).fill(0),d(this,Xt).fill(0)),d(this,Zt)&&d(this,Zt).fill(0),D(this,xt,0),D(this,Ct,0),d(this,Qt).length=0,D(this,Kt,0),D(this,_t,0),d(this,kt)&&d(this,St)){const n=d(this,St);let o;for(;o=n==null?void 0:n.shift();)(i=d(this,Bt))==null||i.call(this,...o)}};let Li=tn;class Nr{constructor(){l(this,"_syncStatus",{status:Uo.done,foldersProgress:[]});l(this,"_syncEnabledState",Tn.initializing);l(this,"_workspaceGuidelines",[]);l(this,"_openUserGuidelinesInput",!1);l(this,"_userGuidelines");l(this,"_contextStore",new Ea);l(this,"_prevOpenFiles",[]);l(this,"_disableContext",!1);l(this,"_enableAgentMemories",!1);l(this,"subscribers",new Set);l(this,"subscribe",t=>(this.subscribers.add(t),t(this),()=>{this.subscribers.delete(t)}));l(this,"handleMessageFromExtension",t=>{const e=t.data;switch(e.type){case at.sourceFoldersUpdated:this.onSourceFoldersUpdated(e.data.sourceFolders);break;case at.sourceFoldersSyncStatus:this.onSyncStatusUpdated(e.data);break;case at.fileRangesSelected:this.updateSelections(e.data);break;case at.currentlyOpenFiles:this.setCurrentlyOpenFiles(e.data);break;case at.syncEnabledState:this.onSyncEnabledStateUpdate(e.data);break;case at.updateGuidelinesState:this.onGuidelinesStateUpdate(e.data);break;default:return!1}return!0});l(this,"onSourceFoldersUpdated",t=>{const e=this.sourceFolders;t=this.updateSourceFoldersWithGuidelines(t),this._contextStore.update(t.map(s=>({sourceFolder:s,status:yt.active,label:s.folderRoot,showWarning:s.guidelinesOverLimit,id:s.folderRoot+String(s.guidelinesOverLimit)})),e,s=>s.id),this.notifySubscribers()});l(this,"onSyncStatusUpdated",t=>{this._syncStatus=t,this.notifySubscribers()});l(this,"disableContext",()=>{this._disableContext=!0,this.notifySubscribers()});l(this,"enableContext",()=>{this._disableContext=!1,this.notifySubscribers()});l(this,"addFile",t=>{this.addFiles([t])});l(this,"addFiles",t=>{this.updateFiles(t,[])});l(this,"removeFile",t=>{this.removeFiles([t])});l(this,"removeFiles",t=>{this.updateFiles([],t)});l(this,"updateItems",(t,e)=>{this.updateItemsInplace(t,e),this.notifySubscribers()});l(this,"updateItemsInplace",(t,e)=>{this._contextStore.update(t,e,s=>s.id)});l(this,"updateFiles",(t,e)=>{const s=o=>({file:o,...mi(o)}),i=t.map(s),n=e.map(s);this._contextStore.update(i,n,o=>o.id),this.notifySubscribers()});l(this,"updateRules",(t,e)=>{const s=o=>({rule:o,...Lo(o)}),i=t.map(s),n=e.map(s);this._contextStore.update(i,n,o=>o.id),this.notifySubscribers()});l(this,"enableAgentMemories",()=>{this._enableAgentMemories=!0,this.notifySubscribers()});l(this,"disableAgentMemories",()=>{this._enableAgentMemories=!1,this.notifySubscribers()});l(this,"setCurrentlyOpenFiles",t=>{const e=t.map(i=>({recentFile:i,...mi(i)})),s=this._prevOpenFiles;this._prevOpenFiles=e,this._contextStore.update(e,s,i=>i.id),s.forEach(i=>{const n=this._contextStore.peekKey(i.id);n!=null&&n.recentFile&&(n.file=n.recentFile,delete n.recentFile)}),e.forEach(i=>{const n=this._contextStore.peekKey(i.id);n!=null&&n.file&&(n.recentFile=n.file,delete n.file)}),this.notifySubscribers()});l(this,"onSyncEnabledStateUpdate",t=>{this._syncEnabledState=t,this.notifySubscribers()});l(this,"updateUserGuidelines",(t,e)=>{const s=this.userGuidelines,i=t.overLimit||((e==null?void 0:e.overLimit)??!1),n={userGuidelines:t,label:"User Guidelines",id:"userGuidelines",status:yt.active,referenceCount:1,showWarning:i,rulesAndGuidelinesState:e};this._contextStore.update([n],s,o=>{var a;return o.id+String((a=o.userGuidelines)==null?void 0:a.overLimit)}),this.notifySubscribers()});l(this,"onGuidelinesStateUpdate",t=>{var i;this._userGuidelines=t.userGuidelines,this._workspaceGuidelines=t.workspaceGuidelines??[];const e=t.userGuidelines,s=this.userGuidelines;if(e||t.rulesAndGuidelines||s.length>0){const n=e||{overLimit:!1,contents:"",lengthLimit:((i=t.rulesAndGuidelines)==null?void 0:i.lengthLimit)??2e3};this.updateUserGuidelines(n,t.rulesAndGuidelines)}this.onSourceFoldersUpdated(this.sourceFolders.map(n=>n.sourceFolder))});l(this,"updateSourceFoldersWithGuidelines",t=>t.map(e=>{const s=this._workspaceGuidelines.find(i=>i.workspaceFolder===e.folderRoot);return{...e,guidelinesOverLimit:(s==null?void 0:s.overLimit)??!1,guidelinesLengthLimit:(s==null?void 0:s.lengthLimit)??2e3}}));l(this,"toggleStatus",t=>{this._contextStore.toggleStatus(t.id),this.notifySubscribers()});l(this,"updateExternalSources",(t,e)=>{this._contextStore.update(t,e,s=>s.id),this.notifySubscribers()});l(this,"clearFiles",()=>{this._contextStore.update([],this.files,t=>t.id),this.notifySubscribers()});l(this,"updateSelections",t=>{const e=this._contextStore.values.filter(Ks),s=t.map(i=>({selection:i,...mi(i)}));this._contextStore.update([],e,i=>i.id),this._contextStore.update(s,[],i=>i.id),this.notifySubscribers()});l(this,"maybeHandleDelete",({editor:t})=>{if(t.state.selection.empty&&t.state.selection.$anchor.pos===1&&this.recentActiveItems.length>0){const e=this.recentActiveItems[0];return this.markInactive(e),!0}return!1});l(this,"markInactive",t=>{this.markItemsInactive([t])});l(this,"markItemsInactive",t=>{t.forEach(e=>{this._contextStore.setStatus(e.id,yt.inactive)}),this.notifySubscribers()});l(this,"markAllInactive",()=>{this.markItemsInactive(this.recentActiveItems)});l(this,"markActive",t=>{this.markItemsActive([t])});l(this,"markItemsActive",t=>{t.forEach(e=>{this._contextStore.setStatus(e.id,yt.active)}),this.notifySubscribers()});l(this,"markAllActive",()=>{this.markItemsActive(this.recentInactiveItems)});l(this,"unpin",t=>{this._contextStore.unpin(t.id),this.notifySubscribers()});l(this,"togglePinned",t=>{this._contextStore.togglePinned(t.id),this.notifySubscribers()});l(this,"notifySubscribers",()=>{this.subscribers.forEach(t=>t(this))});this.clearFiles()}get files(){return this._disableContext?[]:this._contextStore.values.filter(t=>Ki(t)&&!Bs(t))}get recentFiles(){return this._disableContext?[]:this._contextStore.values.filter(Bs)}get userGuidelinesText(){var t;return((t=this._userGuidelines)==null?void 0:t.contents)??""}get selections(){return this._disableContext?[]:this._contextStore.values.filter(Ks)}get folders(){return this._disableContext?[]:this._contextStore.values.filter(Qi)}get sourceFolders(){return this._disableContext?[]:this._contextStore.values.filter(Qs)}get externalSources(){return this._disableContext?[]:this._contextStore.values.filter(Zi)}get userGuidelines(){return this._contextStore.values.filter(Zs)}get agentMemories(){return[{...No,status:this._enableAgentMemories?yt.active:yt.inactive,referenceCount:1}]}get rules(){return this._contextStore.values.filter(t=>Xs(t))}get activeFiles(){return this._disableContext?[]:this.files.filter(t=>t.status===yt.active)}get activeRecentFiles(){return this._disableContext?[]:this.recentFiles.filter(t=>t.status===yt.active)}get activeExternalSources(){return this._disableContext?[]:this.externalSources.filter(t=>t.status===yt.active)}get activeSelections(){return this._disableContext?[]:this.selections.filter(t=>t.status===yt.active)}get activeSourceFolders(){return this._disableContext?[]:this.sourceFolders.filter(t=>t.status===yt.active)}get activeRules(){return this._disableContext?[]:this.rules.filter(t=>t.status===yt.active)}get syncStatus(){return this._syncStatus.status}get syncEnabledState(){return this._syncEnabledState}get syncProgress(){var c;if(this.syncEnabledState===Tn.disabled||!this._syncStatus.foldersProgress)return;const t=this._syncStatus.foldersProgress.filter(u=>u.progress!==void 0);if(t.length===0)return;const e=t.reduce((u,h)=>{var f;return u+(((f=h==null?void 0:h.progress)==null?void 0:f.trackedFiles)??0)},0),s=t.reduce((u,h)=>{var f;return u+(((f=h==null?void 0:h.progress)==null?void 0:f.backlogSize)??0)},0),i=Math.max(e,0),n=Math.min(Math.max(s,0),i),o=i-n,a=[];for(const u of t)(c=u==null?void 0:u.progress)!=null&&c.newlyTracked&&a.push(u.folderRoot);return{status:this._syncStatus.status,totalFiles:i,syncedCount:o,backlogSize:n,newlyTrackedFolders:a}}get contextCounts(){return this._contextStore.values.length??0}get chatActiveContext(){return{userSpecifiedFiles:[...this.activeFiles.map(t=>({rootPath:t.file.repoRoot,relPath:t.file.pathName}))],ruleFiles:this.activeRules.map(t=>t.rule),recentFiles:this.activeRecentFiles.map(t=>({rootPath:t.recentFile.repoRoot,relPath:t.recentFile.pathName})),externalSources:this.activeExternalSources.map(t=>t.externalSource),selections:this.activeSelections.map(t=>t.selection),sourceFolders:this.activeSourceFolders.map(t=>({rootPath:t.sourceFolder.folderRoot,relPath:""}))}}get recentItems(){return this._disableContext?this.userGuidelines:[...this._contextStore.values.filter(t=>!(Qs(t)||Zs(t)||ei(t)||Xs(t))),...this.sourceFolders,...this.rules,...this.userGuidelines,...this.agentMemories]}get recentActiveItems(){return this.recentItems.filter(t=>t.status===yt.active)}get recentInactiveItems(){return this.recentItems.filter(t=>t.status===yt.inactive)}get isContextDisabled(){return this._disableContext}}class Ea{constructor(){l(this,"_cache",new Li({max:1e3}));l(this,"peekKey",t=>this._cache.get(t,{updateAgeOnGet:!1}));l(this,"clear",()=>{this._cache.clear()});l(this,"update",(t,e,s)=>{t.forEach(i=>this.addInPlace(i,s)),e.forEach(i=>this.removeInPlace(i,s))});l(this,"removeFromStore",(t,e)=>{const s=e(t);this._cache.delete(s)});l(this,"addInPlace",(t,e)=>{const s=e(t),i=t.referenceCount??1,n=this._cache.get(s),o=t.status??(n==null?void 0:n.status)??yt.active;n?(n.referenceCount+=i,n.status=o,n.pinned=t.pinned??n.pinned,n.showWarning=t.showWarning??n.showWarning,"userGuidelines"in t&&t.userGuidelines&&"userGuidelines"in n&&(n.userGuidelines=t.userGuidelines),"rulesAndGuidelinesState"in t&&t.rulesAndGuidelinesState&&"rulesAndGuidelinesState"in n&&(n.rulesAndGuidelinesState=t.rulesAndGuidelinesState)):this._cache.set(s,{...t,pinned:void 0,referenceCount:i,status:o})});l(this,"removeInPlace",(t,e)=>{const s=e(t),i=this._cache.get(s);i&&(i.referenceCount-=1,i.referenceCount===0&&this._cache.delete(s))});l(this,"setStatus",(t,e)=>{const s=this._cache.get(t);s&&(s.status=e)});l(this,"togglePinned",t=>{const e=this._cache.peek(t);e&&(e.pinned?this.unpin(t):this.pin(t))});l(this,"pin",t=>{const e=this._cache.peek(t);e&&!e.pinned&&(e.pinned=!0,e.referenceCount+=1)});l(this,"unpin",t=>{const e=this._cache.peek(t);e&&e.pinned&&(e.pinned=!1,e.referenceCount-=1,e.referenceCount===0&&this._cache.delete(t))});l(this,"toggleStatus",t=>{const e=this._cache.get(t);e&&(e.status=e.status===yt.active?yt.inactive:yt.active)})}get store(){return Object.fromEntries(this._cache.entries())}get values(){return[...this._cache.values()]}}class ka{constructor(t,e,s){l(this,"_originalModel");l(this,"_modifiedModel");l(this,"_fullEdits",[]);l(this,"_currEdit");l(this,"_currOriginalEdit");l(this,"swapBaseModel",t=>{this._originalModel.setValue(t),this._modifiedModel.setValue(t),this._fullEdits.forEach(e=>{this._modifiedModel.applyEdits([e])}),this._currEdit&&this._modifiedModel.applyEdits([this._currEdit]),this._currOriginalEdit&&this._originalModel.applyEdits([this._currOriginalEdit])});l(this,"finish",()=>this._completeCurrEdit());l(this,"onReceiveChunk",t=>t.data.newChunkStart?this._startNewEdit(t.data.newChunkStart):t.data.chunkContinue&&this._currEdit?this._continueEdit(t.data.chunkContinue):t.data.chunkEnd&&this._currEdit?this._completeCurrEdit(t.data.chunkEnd):void 0);l(this,"_completeCurrEdit",t=>{const e={resetOriginal:[],original:[],modified:[]};if(!t)return e;if(this._currEdit){this._currEdit.range=new this._monaco.Range(t.stagedStartLine,0,t.stagedEndLine,0);const s=this._nextModifiedInsertPosition(),i=t.stagedEndLine-t.stagedStartLine,n={range:new this._monaco.Range(s.lineNumber,0,s.lineNumber+i,0),text:""};e.modified.push(n),this._modifiedModel.applyEdits([n]),this._fullEdits.push(this._currEdit),this._currEdit=void 0}return e});l(this,"_startNewEdit",t=>{const e={resetOriginal:[],original:[],modified:[]};return this._currOriginalEdit=void 0,this._currEdit={range:new this._monaco.Range(t.stagedStartLine,0,t.stagedStartLine,0),text:""},e.modified.push(this._currEdit),this._modifiedModel.applyEdits([this._currEdit]),e});l(this,"_continueEdit",t=>{if(!this._currEdit)throw new Error("No current edit");const e=this._nextModifiedInsertPosition(),s={...this._currEdit,text:t.newText,range:new this._monaco.Range(e.lineNumber,e.column,e.lineNumber,e.column)};return this._modifiedModel.applyEdits([s]),this._currEdit.text+=t.newText,{resetOriginal:[],original:[],modified:t.newText.length>0?[s]:[]}});l(this,"_nextModifiedInsertPosition",()=>{var e;if(!this._currEdit)throw new Error("No current edit");const t=this._modifiedModel.getOffsetAt({lineNumber:this._currEdit.range.startLineNumber,column:this._currEdit.range.startColumn})+(((e=this._currEdit.text)==null?void 0:e.length)??0);return this._modifiedModel.getPositionAt(t)});this.id=t,this.originalCode=e,this._monaco=s,this._originalModel=this._monaco.editor.createModel(e),this._modifiedModel=this._monaco.editor.createModel(e)}get hasReceivedFirstChunk(){return this._currEdit!==void 0||this._fullEdits.length>0}get originalValue(){return this._originalModel.getValue()}get modifiedValue(){return this._modifiedModel.getValue()}get currEdit(){return this._currEdit}}class Ta{constructor(t,e,s){l(this,"_asyncMsgSender");l(this,"_editor");l(this,"_chatModel");l(this,"_focusModel",new Cr);l(this,"_hasScrolledOnInit",!1);l(this,"_markHasScrolledOnInit",Ti(()=>{this._hasScrolledOnInit=!0},200));l(this,"_resetScrollOnInit",()=>{this._markHasScrolledOnInit.cancel(),this._hasScrolledOnInit=!1});l(this,"_subscribers",new Set);l(this,"_disposables",[]);l(this,"_rootChunk");l(this,"_keybindings",ht({}));l(this,"_requestId",ht(void 0));l(this,"requestId",this._requestId);l(this,"_disableResolution",ht(!1));l(this,"disableResolution",In(this._disableResolution));l(this,"_disableApply",ht(!1));l(this,"disableApply",In(this._disableApply));l(this,"_currStream");l(this,"_isLoadingDiffChunks",ht(!1));l(this,"_selectionLines",ht(void 0));l(this,"_mode",ht(Ie.edit));l(this,"initializeEditor",t=>{var e,s,i,n,o,a,c,u,h,f,p,_;this._editor=this._monaco.editor.createDiffEditor(this._editorContainer,{automaticLayout:!0,theme:t,readOnly:!0,contextmenu:!1,renderSideBySide:!1,renderIndicators:!0,renderMarginRevertIcon:!1,originalEditable:!1,diffCodeLens:!1,renderOverviewRuler:!1,ignoreTrimWhitespace:!1,scrollBeyondLastLine:!0,maxComputationTime:0,minimap:{enabled:!1},padding:{top:16}}),this._editor.getOriginalEditor().updateOptions({lineNumbers:"off"}),this._chatModel=new Xi(new Sr(gs),gs,new Nr),(s=(e=this._monaco.editor).registerCommand)==null||s.call(e,"acceptFocusedChunk",this.acceptFocusedChunk),(n=(i=this._monaco.editor).registerCommand)==null||n.call(i,"rejectFocusedChunk",this.rejectFocusedChunk),(a=(o=this._monaco.editor).registerCommand)==null||a.call(o,"acceptAllChunks",this.acceptAllChunks),(u=(c=this._monaco.editor).registerCommand)==null||u.call(c,"rejectAllChunks",this.rejectAllChunks),(f=(h=this._monaco.editor).registerCommand)==null||f.call(h,"focusNextChunk",this.focusNextChunk),(_=(p=this._monaco.editor).registerCommand)==null||_.call(p,"focusPrevChunk",this.focusPrevChunk),this._disposables.push(this._editor,this._editor.onDidUpdateDiff(this.onDidUpdateDiff),this._editor.getModifiedEditor().onMouseMove(this.onMouseMoveModified),{dispose:this._focusModel.subscribe(b=>this.notifySubscribers())}),this.initialize()});l(this,"subscribe",t=>(this._subscribers.add(t),t(this),()=>{this._subscribers.delete(t)}));l(this,"dispose",()=>{this._editor.dispose(),this._subscribers.clear(),this._disposables.forEach(t=>t.dispose())});l(this,"notifySubscribers",()=>{this._subscribers.forEach(t=>t(this))});l(this,"onDidUpdateDiff",()=>{var t;if(this.updateCodeChunk(),!this._hasScrolledOnInit&&((t=this.leaves)==null?void 0:t.length)){this._markHasScrolledOnInit();const e=this.leaves[0];this.revealChunk(e)}this.notifyDiffViewUpdated(),this.notifySubscribers()});l(this,"onMouseMoveModified",t=>{var i,n,o,a,c,u;if(((i=t.target.position)==null?void 0:i.lineNumber)===void 0||this.leaves===void 0)return;const e=this.editorOffset,s=(n=t.target.position)==null?void 0:n.lineNumber;for(let h=0;h<this.leaves.length;h++){const f=this.leaves[h],p=(o=f.unitOfCodeWork.lineChanges)==null?void 0:o.lineChanges[0].modifiedStart,_=(a=f.unitOfCodeWork.lineChanges)==null?void 0:a.lineChanges[0].modifiedEnd,b=(c=f.unitOfCodeWork.lineChanges)==null?void 0:c.lineChanges[0].originalStart,S=(u=f.unitOfCodeWork.lineChanges)==null?void 0:u.lineChanges[0].originalEnd;if(p!==void 0&&_!==void 0&&b!==void 0&&S!==void 0){if(p!==_||s!==p){if(p<=s&&s<_){this.setCurrFocusedChunkIdx(h,!1);break}}else if(t.target.type===this._monaco.editor.MouseTargetType.CONTENT_VIEW_ZONE){const x=this._editor.getOriginalEditor(),m=x.getOption(this._monaco.editor.EditorOption.lineHeight),y=x.getScrolledVisiblePosition({lineNumber:b,column:0}),M=x.getScrolledVisiblePosition({lineNumber:S+1,column:0});if(y===null||M===null)continue;const F=y.top-m/2+e,R=M.top-m/2+e;if(t.event.posy>=F&&t.event.posy<=R){this.setCurrFocusedChunkIdx(h,!1);break}break}}}});l(this,"updateIsWebviewFocused",async t=>{await this._asyncMsgSender.send({type:at.diffViewWindowFocusChange,data:t})});l(this,"setCurrFocusedChunkIdx",(t,e=!0)=>{this._focusModel.focusedItemIdx!==t&&(this._focusModel.setFocusIdx(t),e&&this.revealCurrFocusedChunk(),this.notifySubscribers())});l(this,"revealCurrFocusedChunk",()=>{const t=this._focusModel.focusedItem;t&&this.revealChunk(t)});l(this,"revealChunk",t=>{var i;const e=(i=t.unitOfCodeWork.lineChanges)==null?void 0:i.lineChanges[0],s=e==null?void 0:e.modifiedStart;s!==void 0&&this._editor.revealLineNearTop(s-1)});l(this,"renderCentralOverlayWidget",t=>{const e=()=>({editor:this._editor,id:"central-overlay-widget"}),s=function(i,n,o){let a,c=n;const u=()=>c.editor.getModifiedEditor(),h=()=>{const f=u();if(!f)return;const p={getDomNode:()=>i,getId:()=>c.id,getPosition:()=>({preference:o.monaco.editor.OverlayWidgetPositionPreference.TOP_CENTER})};a&&f.removeOverlayWidget(a),f.addOverlayWidget(p),a=p};return h(),{update:f=>{c=f,h()},destroy:()=>{const f=u();f&&a&&f.removeOverlayWidget(a)}}}(t,e(),{monaco:this._monaco});return{update:()=>{s.update(e())},destroy:s.destroy}});l(this,"renderInstructionsDrawerViewZone",(t,e)=>{let s=!1,i=e;const n=e.autoFocus??!0,o=h=>{n&&!s&&(this._editor.revealLineNearTop(h),s=!0)},a=h=>({...h,ordinal:Fi.instructionDrawer,editor:this._editor,afterLineNumber:h.line}),c=Un(t,a(e)),u=[];return n&&u.push(this._editor.onDidUpdateDiff(()=>{o(i.line)})),{update:h=>{const f={...i,...h};ba(f,i)||(c.update(a(f)),i=f,o(f.line))},destroy:()=>{c.destroy(),u.forEach(h=>h.dispose())}}});l(this,"renderActionsViewZone",(t,e)=>{const s=n=>{var a;let o;return o=n.chunk?(a=n.chunk.unitOfCodeWork.lineChanges)==null?void 0:a.lineChanges[0].modifiedStart:1,{...n,ordinal:Fi.chunkActionPanel,editor:this._editor,afterLineNumber:o?o-1:void 0}},i=Un(t,s(e));return{update:n=>{i.update(s(n))},destroy:i.destroy}});l(this,"acceptAllChunks",()=>{this.leaves&&this.acceptChunks(this.leaves,!0)});l(this,"rejectAllChunks",()=>{this.leaves&&this.rejectChunks(this.leaves,!0)});l(this,"acceptFocusedChunk",()=>{const t=this._focusModel.focusedItem;t&&this.acceptChunk(t)});l(this,"rejectFocusedChunk",()=>{const t=this._focusModel.focusedItem;t&&this.rejectChunk(t)});l(this,"focusNextChunk",()=>{this._focusModel.focusNext(),this.revealCurrFocusedChunk()});l(this,"focusPrevChunk",()=>{this._focusModel.focusPrev(),this.revealCurrFocusedChunk()});l(this,"initialize",async()=>{var c;const t=await this._asyncMsgSender.send({type:at.diffViewLoaded},2e3);this._resetScrollOnInit();const{file:e,instruction:s,keybindings:i,editable:n}=t.data;this._editor.updateOptions({readOnly:!n});const o=lt(this._keybindings);this._keybindings.set(i??o);const a=s==null?void 0:s.selection;a&&(a.start.line===a.end.line&&a.start.character===a.end.character&&this._mode.set(Ie.instruction),lt(this.selectionLines)===void 0&&this._selectionLines.set({start:a.start.line,end:a.end.line})),this.updateModels(e.originalCode??"",e.modifiedCode??"",{rootPath:e.repoRoot,relPath:e.pathName}),(c=this._currStream)==null||c.finish(),this._currStream=void 0,this._disableResolution.set(!!t.data.disableResolution),this._disableApply.set(!!t.data.disableApply),await this._tryFetchStream(),this._syncStreamToModels()});l(this,"disposeDiffViewPanel",async()=>{await this._asyncMsgSender.send({type:at.disposeDiffView})});l(this,"_tryFetchStream",async()=>{var e,s,i;const t=this._asyncMsgSender.stream({type:at.diffViewFetchPendingStream},15e3,6e4);for await(const n of t)switch(n.type){case at.diffViewDiffStreamStarted:{this.setLoading(!0),this._requestId.set(n.data.requestId);const o=this._editor.getOriginalEditor().getValue();this._currStream=new ka(n.data.streamId,o,this._monaco),this._syncStreamToModels();break}case at.diffViewDiffStreamEnded:if(((e=this._currStream)==null?void 0:e.id)!==n.data.streamId)return;this.setLoading(!1),this._cleanupStream();break;case at.diffViewDiffStreamChunk:{if(((s=this._currStream)==null?void 0:s.id)!==n.data.streamId)return;const o=this._editor.getOriginalEditor().getModel();if(!this._editor.getModifiedEditor().getModel()||!o)return this.setLoading(!1),void this._cleanupStream();const a=(i=this._currStream)==null?void 0:i.onReceiveChunk(n);a&&(this._applyDeltaDiff(a),lt(this._selectionLines)!=null&&this._selectionLines.set(null));break}}});l(this,"handleMessageFromExtension",async t=>{switch(t.data.type){case at.diffViewNotifyReinit:this.setLoading(!1),this._cleanupStream(),this.initialize();break;case at.diffViewAcceptAllChunks:this.acceptAllChunks();break;case at.diffViewAcceptFocusedChunk:this.acceptFocusedChunk();break;case at.diffViewRejectFocusedChunk:this.rejectFocusedChunk();break;case at.diffViewFocusPrevChunk:this.focusPrevChunk();break;case at.diffViewFocusNextChunk:this.focusNextChunk()}});l(this,"_applyDeltaDiff",t=>{const e=this._editor.getOriginalEditor().getModel(),s=this._editor.getModifiedEditor().getModel();e&&s&&(e.pushEditOperations([],t.resetOriginal,()=>[]),t.original.forEach(i=>{e.pushEditOperations([],[i],()=>[])}),t.modified.forEach(i=>{s.pushEditOperations([],[i],()=>[])}))});l(this,"_cleanupStream",()=>{var t;if(this._currStream){const e=(t=this._currStream)==null?void 0:t.finish();this._applyDeltaDiff(e),this._currStream=void 0,this._resetScrollOnInit()}});l(this,"_syncStreamToModels",()=>{var s,i;const t=(s=this._currStream)==null?void 0:s.originalValue,e=(i=this._currStream)==null?void 0:i.modifiedValue;t&&t!==this._editor.getOriginalEditor().getValue()&&this._editor.getOriginalEditor().setValue(t),e&&e!==this._editor.getModifiedEditor().getValue()&&this._editor.getModifiedEditor().setValue(e)});l(this,"acceptChunk",async t=>{lt(this._disableApply)||this.acceptChunks([t])});l(this,"acceptChunks",async(t,e=!1)=>{lt(this._disableApply)||(this.executeDiffChunks(t,!0),this.notifyResolvedChunks(t,pi.accept,e),await wi(),this.areModelsEqual()&&!lt(this.isLoading)&&this.disposeDiffViewPanel())});l(this,"areModelsEqual",()=>{var s,i;const t=(s=this._editor.getModel())==null?void 0:s.original,e=(i=this._editor.getModel())==null?void 0:i.modified;return(t==null?void 0:t.getValue())===(e==null?void 0:e.getValue())});l(this,"rejectChunk",async t=>{this.rejectChunks([t])});l(this,"rejectChunks",async(t,e=!1)=>{this.executeDiffChunks(t,!1),this.notifyResolvedChunks(t,pi.reject,e),await wi(),this.areModelsEqual()&&!lt(this.isLoading)&&this.disposeDiffViewPanel()});l(this,"notifyDiffViewUpdated",Ti(()=>{this.notifyResolvedChunks([],pi.accept)},1e3));l(this,"notifyResolvedChunks",async(t,e,s=!1)=>{var n;const i=(n=this._editor.getModel())==null?void 0:n.original.uri.path;i&&await this._asyncMsgSender.send({type:at.diffViewResolveChunk,data:{file:{repoRoot:"",pathName:i,originalCode:this._originalCode,modifiedCode:this._modifiedCode},changes:t.map(o=>o.unitOfCodeWork),resolveType:e,shouldApplyToAll:s}},2e3)});l(this,"executeDiffChunks",(t,e)=>{var h,f,p;if(lt(this._disableResolution)||e&&lt(this._disableApply))return;const s=(h=this._editor.getModel())==null?void 0:h.original,i=(f=this._editor.getModel())==null?void 0:f.modified;if(!s||!i||this._currStream!==void 0)return;const n=[],o=[];for(const _ of t){const b=(p=_.unitOfCodeWork.lineChanges)==null?void 0:p.lineChanges[0];if(!b||_.unitOfCodeWork.originalCode===void 0||_.unitOfCodeWork.modifiedCode===void 0)continue;let S={startLineNumber:b.originalStart,startColumn:1,endLineNumber:b.originalEnd,endColumn:1},x={startLineNumber:b.modifiedStart,startColumn:1,endLineNumber:b.modifiedEnd,endColumn:1};const m=e?_.unitOfCodeWork.modifiedCode:_.unitOfCodeWork.originalCode;m!==void 0&&(n.push({range:S,text:m}),o.push({range:x,text:m}))}s.pushEditOperations([],n,()=>[]),i.pushEditOperations([],o,()=>[]);const a=this._focusModel.nextIdx({nowrap:!0});if(a===void 0)return;const c=a===this._focusModel.focusedItemIdx?a-1:a,u=this._focusModel.items[c];u&&this.revealChunk(u)});l(this,"updateCodeChunk",()=>{this._rootChunk=this.computeCodeChunk(),this._focusModel.setItems(this.leaves??[]),this._focusModel.initFocusIdx(0),this.notifySubscribers()});l(this,"handleInstructionSubmit",t=>{const e=this._editor.getModifiedEditor(),s=this.getSelectedCodeDetails(e);if(!s)throw Error("No selected code details found");this._chatModel.currentConversationModel.sendInstructionExchange(t,s)});l(this,"updateModels",(t,e,s)=>{var o,a;const i=(a=(o=this._editor.getModel())==null?void 0:o.original)==null?void 0:a.uri,n=(s&&this._monaco.Uri.file(s.relPath))??i;if(n)if((i==null?void 0:i.fsPath)!==n.fsPath||(i==null?void 0:i.authority)!==n.authority){const c=n.with({fragment:crypto.randomUUID()}),u=n.with({fragment:crypto.randomUUID()});this._editor.setModel({original:this._monaco.editor.createModel(t,void 0,c),modified:this._monaco.editor.createModel(e??"",void 0,u)})}else this._originalCode!==t&&this.getOriginalEditor().setValue(t),this._modifiedCode!==e&&this.getModifiedEditor().setValue(e??"");else console.warn("No URI found for diff view. Not updating models.")});l(this,"updateTheme",t=>{this._monaco.editor.setTheme(t)});this._editorContainer=t,this._monaco=s,this._asyncMsgSender=new Io(i=>gs.postMessage(i)),this.initializeEditor(e)}get editorOffset(){return this._editorContainer.getBoundingClientRect().top}get currFocusedChunkIdx(){return this._focusModel.focusedItemIdx}get selectionLines(){return this._selectionLines}get mode(){return this._mode}get keybindings(){return this._keybindings}getOriginalEditor(){return this._editor.getOriginalEditor()}getModifiedEditor(){return this._editor.getModifiedEditor()}get isLoading(){return{subscribe:this._isLoadingDiffChunks.subscribe}}setLoading(t){this._isLoadingDiffChunks.set(t)}get _originalCode(){var t;return((t=this._currStream)==null?void 0:t.originalCode)??this._editor.getOriginalEditor().getValue()}get _modifiedCode(){return this._editor.getModifiedEditor().getValue()}get leaves(){const t=this.codeChunk;if(t)return Er(t)}get codeChunk(){return this._rootChunk}computeCodeChunk(){var n,o;const t=[],e=this._editor.getLineChanges(),s=(n=this._editor.getModel())==null?void 0:n.original,i=(o=this._editor.getModel())==null?void 0:o.modified;if(e&&s&&i){for(const a of e){const c=Hn({startLineNumber:a.originalStartLineNumber,startColumn:1,endLineNumber:a.originalEndLineNumber,endColumn:1}),u=Hn({startLineNumber:a.modifiedStartLineNumber,startColumn:1,endLineNumber:a.modifiedEndLineNumber,endColumn:1}),h=Aa(this._editor,c,u);t.push(h)}return{id:crypto.randomUUID(),name:"",title:"",description:"",generationSource:"",supportedActions:[],children:t,childIds:t.map(a=>a.id)}}}getSelectedCodeDetails(t){const e=t.getModel();if(!e)return null;const s=e.getLanguageId(),i=1,n=1,o={lineNumber:e.getLineCount(),column:e.getLineMaxColumn(e.getLineCount())},a=lt(this._selectionLines);if(!a)throw new Error("No selection lines found");const c=Math.min(a.end+1,o.lineNumber),u=new this._monaco.Range(a.start+1,1,c,e.getLineMaxColumn(c));let h=e.getValueInRange(u);c<e.getLineCount()&&(h+=e.getEOL());const f=new this._monaco.Range(i,n,u.startLineNumber,u.startColumn),p=Math.min(u.endLineNumber+1,o.lineNumber),_=new this._monaco.Range(p,1,o.lineNumber,o.column);return{selectedCode:h,prefix:e.getValueInRange(f),suffix:e.getValueInRange(_),path:e.uri.path,language:s,prefixBegin:f.startLineNumber-1,suffixEnd:_.endLineNumber-1}}}function Aa(r,t,e){var n,o;const s=(n=r.getModel())==null?void 0:n.original,i=(o=r.getModel())==null?void 0:o.modified;if(!s||!i)throw new Error("No models found");return function(a,c,u,h){return{id:crypto.randomUUID(),name:"",title:"",description:"",generationSource:"",supportedActions:[],unitOfCodeWork:{repoRoot:"",pathName:"",originalCode:a,modifiedCode:c,lineChanges:{lineChanges:[{originalStart:u.startLineNumber,originalEnd:u.endLineNumber,modifiedStart:h.startLineNumber,modifiedEnd:h.endLineNumber}],lineOffset:0}},children:[],childIds:[]}}(s.getValueInRange(t),i.getValueInRange(e),t,e)}function Hn(r){return r.endLineNumber===0?{startLineNumber:r.startLineNumber+1,startColumn:1,endLineNumber:r.startLineNumber+1,endColumn:1}:{startLineNumber:r.startLineNumber,startColumn:1,endLineNumber:r.endLineNumber+1,endColumn:1}}function zn(r){let t,e;return t=new Me({props:{size:1,variant:"ghost",color:"success",$$slots:{default:[Fa]},$$scope:{ctx:r}}}),t.$on("click",function(){de(r[4])&&r[4].apply(this,arguments)}),{c(){E(t.$$.fragment)},m(s,i){k(t,s,i),e=!0},p(s,i){r=s;const n={};132096&i&&(n.$$scope={dirty:i,ctx:r}),t.$set(n)},i(s){e||($(t.$$.fragment,s),e=!0)},o(s){C(t.$$.fragment,s),e=!1},d(s){T(t,s)}}}function Fa(r){let t,e,s;return t=new We({props:{keybinding:r[10].acceptFocusedChunk}}),{c(){E(t.$$.fragment),e=pt(`
        Accept`)},m(i,n){k(t,i,n),O(i,e,n),s=!0},p(i,n){const o={};1024&n&&(o.keybinding=i[10].acceptFocusedChunk),t.$set(o)},i(i){s||($(t.$$.fragment,i),s=!0)},o(i){C(t.$$.fragment,i),s=!1},d(i){i&&N(e),T(t,i)}}}function Oa(r){let t,e,s;return t=new We({props:{keybinding:r[10].rejectFocusedChunk}}),{c(){E(t.$$.fragment),e=pt(`
      Reject`)},m(i,n){k(t,i,n),O(i,e,n),s=!0},p(i,n){const o={};1024&n&&(o.keybinding=i[10].rejectFocusedChunk),t.$set(o)},i(i){s||($(t.$$.fragment,i),s=!0)},o(i){C(t.$$.fragment,i),s=!1},d(i){i&&N(e),T(t,i)}}}function Na(r){let t,e,s,i,n,o,a,c,u,h,f=!r[3]&&zn(r);return a=new Me({props:{size:1,variant:"ghost",color:"error",$$slots:{default:[Oa]},$$scope:{ctx:r}}}),a.$on("click",function(){de(r[5])&&r[5].apply(this,arguments)}),{c(){t=Y("div"),s=Z(),i=Y("div"),n=Y("div"),f&&f.c(),o=Z(),E(a.$$.fragment),Q(t,"class","svelte-zm1705"),Pt(t,"c-chunk-diff-border--focused",!!r[7]&&r[1]),Q(n,"class","c-button-container svelte-zm1705"),Pt(n,"c-button-container--focused",r[1]),Pt(n,"c-button-container--transparent",r[9]),Q(i,"class","c-chunk-action-panel-anchor svelte-zm1705"),Xe(i,"top",r[8]+"px"),Pt(i,"c-chunk-action-panel-anchor--left",r[0]==="left"),Pt(i,"c-chunk-action-panel-anchor--right",r[0]==="right"),Pt(i,"c-chunk-action-panel-anchor--focused",r[1])},m(p,_){O(p,t,_),O(p,s,_),O(p,i,_),tt(i,n),f&&f.m(n,null),tt(n,o),k(a,n,null),c=!0,u||(h=[pr(e=r[6].renderActionsViewZone(t,{chunk:r[7],heightInPx:r[2],onDomNodeTop:r[12]})),we(i,"mouseenter",r[13]),we(i,"mousemove",r[13]),we(i,"mouseleave",r[13])],u=!0)},p(p,[_]){r=p,e&&de(e.update)&&132&_&&e.update.call(null,{chunk:r[7],heightInPx:r[2],onDomNodeTop:r[12]}),(!c||130&_)&&Pt(t,"c-chunk-diff-border--focused",!!r[7]&&r[1]),r[3]?f&&(vt(),C(f,1,1,()=>{f=null}),$t()):f?(f.p(r,_),8&_&&$(f,1)):(f=zn(r),f.c(),$(f,1),f.m(n,o));const b={};132096&_&&(b.$$scope={dirty:_,ctx:r}),a.$set(b),(!c||2&_)&&Pt(n,"c-button-container--focused",r[1]),(!c||512&_)&&Pt(n,"c-button-container--transparent",r[9]),(!c||256&_)&&Xe(i,"top",r[8]+"px"),(!c||1&_)&&Pt(i,"c-chunk-action-panel-anchor--left",r[0]==="left"),(!c||1&_)&&Pt(i,"c-chunk-action-panel-anchor--right",r[0]==="right"),(!c||2&_)&&Pt(i,"c-chunk-action-panel-anchor--focused",r[1])},i(p){c||($(f),$(a.$$.fragment,p),c=!0)},o(p){C(f),C(a.$$.fragment,p),c=!1},d(p){p&&(N(t),N(s),N(i)),f&&f.d(),T(a),u=!1,Vi(h)}}}function La(r,t,e){let s,{align:i="right"}=t,{isFocused:n}=t,{heightInPx:o=1}=t,{disableApply:a=!1}=t,{onAccept:c}=t,{onReject:u}=t,{diffViewModel:h}=t,{leaf:f}=t;const p=h.keybindings;je(r,p,m=>e(10,s=m));let _=0,b,S=!1;function x(){b&&(clearTimeout(b),b=void 0),e(9,S=!1)}return r.$$set=m=>{"align"in m&&e(0,i=m.align),"isFocused"in m&&e(1,n=m.isFocused),"heightInPx"in m&&e(2,o=m.heightInPx),"disableApply"in m&&e(3,a=m.disableApply),"onAccept"in m&&e(4,c=m.onAccept),"onReject"in m&&e(5,u=m.onReject),"diffViewModel"in m&&e(6,h=m.diffViewModel),"leaf"in m&&e(7,f=m.leaf)},[i,n,o,a,c,u,h,f,_,S,s,p,m=>{e(8,_=m)},function(m){m.target.closest(".c-button-container")?x():m.type==="mouseenter"||m.type==="mousemove"?(x(),b=setTimeout(()=>{e(9,S=!0)},400)):m.type==="mouseleave"&&x()}]}class Da extends Pe{constructor(t){super(),He(this,t,La,Na,ze,{align:0,isFocused:1,heightInPx:2,disableApply:3,onAccept:4,onReject:5,diffViewModel:6,leaf:7})}}function Wn(r){let t,e,s;function i(o){r[18](o)}let n={onOpenChange:r[16],content:r[3],triggerOn:[Vo.Hover],$$slots:{default:[qa]},$$scope:{ctx:r}};return r[4]!==void 0&&(n.requestClose=r[4]),t=new Bo({props:n}),Je.push(()=>yo(t,"requestClose",i)),{c(){E(t.$$.fragment)},m(o,a){k(t,o,a),s=!0},p(o,a){const c={};8&a&&(c.content=o[3]),1048576&a&&(c.$$scope={dirty:a,ctx:o}),!e&&16&a&&(e=!0,c.requestClose=o[4],vo(()=>e=!1)),t.$set(c)},i(o){s||($(t.$$.fragment,o),s=!0)},o(o){C(t.$$.fragment,o),s=!1},d(o){T(t,o)}}}function Ra(r){let t,e;return t=new zo({}),{c(){E(t.$$.fragment)},m(s,i){k(t,s,i),e=!0},i(s){e||($(t.$$.fragment,s),e=!0)},o(s){C(t.$$.fragment,s),e=!1},d(s){T(t,s)}}}function qa(r){let t,e;return t=new wo({props:{variant:"ghost",color:"neutral",size:1,$$slots:{default:[Ra]},$$scope:{ctx:r}}}),t.$on("click",r[17]),{c(){E(t.$$.fragment)},m(s,i){k(t,s,i),e=!0},p(s,i){const n={};1048576&i&&(n.$$scope={dirty:i,ctx:s}),t.$set(n)},i(s){e||($(t.$$.fragment,s),e=!0)},o(s){C(t.$$.fragment,s),e=!1},d(s){T(t,s)}}}function Ua(r){let t;return{c(){t=Y("span"),t.textContent="No changes",Q(t,"class","c-diff-page-counter svelte-4zjwll")},m(e,s){O(e,t,s)},p:J,i:J,o:J,d(e){e&&N(t)}}}function ja(r){var u,h;let t,e,s,i,n,o,a,c=((h=(u=r[1])==null?void 0:u.leaves)==null?void 0:h.length)+"";return o=new gr({props:{size:1,loading:r[10]}}),{c(){t=Y("span"),e=pt(r[2]),s=pt(" of "),i=pt(c),n=Z(),E(o.$$.fragment),Q(t,"class","c-diff-page-counter svelte-4zjwll")},m(f,p){O(f,t,p),tt(t,e),tt(t,s),tt(t,i),tt(t,n),k(o,t,null),a=!0},p(f,p){var b,S;(!a||4&p)&&Yt(e,f[2]),(!a||2&p)&&c!==(c=((S=(b=f[1])==null?void 0:b.leaves)==null?void 0:S.length)+"")&&Yt(i,c);const _={};1024&p&&(_.loading=f[10]),o.$set(_)},i(f){a||($(o.$$.fragment,f),a=!0)},o(f){C(o.$$.fragment,f),a=!1},d(f){f&&N(t),T(o)}}}function Pa(r){let t,e,s,i;return s=new gr({props:{size:1,loading:r[10]}}),{c(){t=Y("span"),e=pt(`Generating changes
        `),E(s.$$.fragment),Q(t,"class","c-diff-page-counter svelte-4zjwll")},m(n,o){O(n,t,o),tt(t,e),k(s,t,null),i=!0},p(n,o){const a={};1024&o&&(a.loading=n[10]),s.$set(a)},i(n){i||($(s.$$.fragment,n),i=!0)},o(n){C(s.$$.fragment,n),i=!1},d(n){n&&N(t),T(s)}}}function Gn(r){let t,e,s,i,n,o;t=new Me({props:{size:1,variant:"ghost",color:"neutral",$$slots:{default:[Ha]},$$scope:{ctx:r}}}),t.$on("click",function(){de(r[0].focusPrevChunk)&&r[0].focusPrevChunk.apply(this,arguments)}),s=new Me({props:{size:1,variant:"ghost",color:"neutral",$$slots:{default:[za]},$$scope:{ctx:r}}}),s.$on("click",function(){de(r[0].focusNextChunk)&&r[0].focusNextChunk.apply(this,arguments)});let a=!r[12]&&Vn(r);return{c(){E(t.$$.fragment),e=Z(),E(s.$$.fragment),i=Z(),a&&a.c(),n=ne()},m(c,u){k(t,c,u),O(c,e,u),k(s,c,u),O(c,i,u),a&&a.m(c,u),O(c,n,u),o=!0},p(c,u){r=c;const h={};1050624&u&&(h.$$scope={dirty:u,ctx:r}),t.$set(h);const f={};1050624&u&&(f.$$scope={dirty:u,ctx:r}),s.$set(f),r[12]?a&&(vt(),C(a,1,1,()=>{a=null}),$t()):a?(a.p(r,u),4096&u&&$(a,1)):(a=Vn(r),a.c(),$(a,1),a.m(n.parentNode,n))},i(c){o||($(t.$$.fragment,c),$(s.$$.fragment,c),$(a),o=!0)},o(c){C(t.$$.fragment,c),C(s.$$.fragment,c),C(a),o=!1},d(c){c&&(N(e),N(i),N(n)),T(t,c),T(s,c),a&&a.d(c)}}}function Ha(r){let t,e,s;return t=new We({props:{keybinding:r[11].focusPrevChunk}}),{c(){E(t.$$.fragment),e=pt(`
        Back`)},m(i,n){k(t,i,n),O(i,e,n),s=!0},p(i,n){const o={};2048&n&&(o.keybinding=i[11].focusPrevChunk),t.$set(o)},i(i){s||($(t.$$.fragment,i),s=!0)},o(i){C(t.$$.fragment,i),s=!1},d(i){i&&N(e),T(t,i)}}}function za(r){let t,e,s;return t=new We({props:{keybinding:r[11].focusNextChunk}}),{c(){E(t.$$.fragment),e=pt(`
        Next`)},m(i,n){k(t,i,n),O(i,e,n),s=!0},p(i,n){const o={};2048&n&&(o.keybinding=i[11].focusNextChunk),t.$set(o)},i(i){s||($(t.$$.fragment,i),s=!0)},o(i){C(t.$$.fragment,i),s=!1},d(i){i&&N(e),T(t,i)}}}function Vn(r){let t,e,s,i=!r[13]&&Bn(r);return e=new Me({props:{size:1,variant:"ghost",color:"error",$$slots:{default:[Ga]},$$scope:{ctx:r}}}),e.$on("click",function(){de(r[0].rejectAllChunks)&&r[0].rejectAllChunks.apply(this,arguments)}),{c(){i&&i.c(),t=Z(),E(e.$$.fragment)},m(n,o){i&&i.m(n,o),O(n,t,o),k(e,n,o),s=!0},p(n,o){(r=n)[13]?i&&(vt(),C(i,1,1,()=>{i=null}),$t()):i?(i.p(r,o),8192&o&&$(i,1)):(i=Bn(r),i.c(),$(i,1),i.m(t.parentNode,t));const a={};1050624&o&&(a.$$scope={dirty:o,ctx:r}),e.$set(a)},i(n){s||($(i),$(e.$$.fragment,n),s=!0)},o(n){C(i),C(e.$$.fragment,n),s=!1},d(n){n&&N(t),i&&i.d(n),T(e,n)}}}function Bn(r){let t,e;return t=new Me({props:{size:1,variant:"ghost",color:"success",$$slots:{default:[Wa]},$$scope:{ctx:r}}}),t.$on("click",function(){de(r[0].acceptAllChunks)&&r[0].acceptAllChunks.apply(this,arguments)}),{c(){E(t.$$.fragment)},m(s,i){k(t,s,i),e=!0},p(s,i){r=s;const n={};1050624&i&&(n.$$scope={dirty:i,ctx:r}),t.$set(n)},i(s){e||($(t.$$.fragment,s),e=!0)},o(s){C(t.$$.fragment,s),e=!1},d(s){T(t,s)}}}function Wa(r){let t,e,s;return t=new We({props:{keybinding:r[11].acceptAllChunks}}),{c(){E(t.$$.fragment),e=pt(`
            Accept All`)},m(i,n){k(t,i,n),O(i,e,n),s=!0},p(i,n){const o={};2048&n&&(o.keybinding=i[11].acceptAllChunks),t.$set(o)},i(i){s||($(t.$$.fragment,i),s=!0)},o(i){C(t.$$.fragment,i),s=!1},d(i){i&&N(e),T(t,i)}}}function Ga(r){let t,e,s;return t=new We({props:{keybinding:r[11].rejectAllChunks}}),{c(){E(t.$$.fragment),e=pt(`
          Reject All`)},m(i,n){k(t,i,n),O(i,e,n),s=!0},p(i,n){const o={};2048&n&&(o.keybinding=i[11].rejectAllChunks),t.$set(o)},i(i){s||($(t.$$.fragment,i),s=!0)},o(i){C(t.$$.fragment,i),s=!1},d(i){i&&N(e),T(t,i)}}}function Va(r){let t,e,s,i,n,o,a,c=r[9]&&Wn(r);const u=[Pa,ja,Ua],h=[];function f(_,b){return!_[5]&&_[10]?0:_[5]?1:2}i=f(r),n=h[i]=u[i](r);let p=r[5]&&Gn(r);return{c(){t=Y("div"),e=Y("div"),c&&c.c(),s=Z(),n.c(),o=Z(),p&&p.c(),Q(e,"class","c-button-container svelte-4zjwll"),Q(t,"class","c-top-action-panel-anchor svelte-4zjwll")},m(_,b){O(_,t,b),tt(t,e),c&&c.m(e,null),tt(e,s),h[i].m(e,null),tt(e,o),p&&p.m(e,null),a=!0},p(_,[b]){_[9]?c?(c.p(_,b),512&b&&$(c,1)):(c=Wn(_),c.c(),$(c,1),c.m(e,s)):c&&(vt(),C(c,1,1,()=>{c=null}),$t());let S=i;i=f(_),i===S?h[i].p(_,b):(vt(),C(h[S],1,1,()=>{h[S]=null}),$t(),n=h[i],n?n.p(_,b):(n=h[i]=u[i](_),n.c()),$(n,1),n.m(e,o)),_[5]?p?(p.p(_,b),32&b&&$(p,1)):(p=Gn(_),p.c(),$(p,1),p.m(e,null)):p&&(vt(),C(p,1,1,()=>{p=null}),$t())},i(_){a||($(c),$(n),$(p),a=!0)},o(_){C(c),C(n),C(p),a=!1},d(_){_&&N(t),c&&c.d(),h[i].d(),p&&p.d()}}}function Ba(r,t,e){let s,i,n,o,a,c,u,h,f,p,_=J,b=()=>(_(),_=ue(y,P=>e(1,c=P)),y),S=J,x=J,m=J;r.$$.on_destroy.push(()=>_()),r.$$.on_destroy.push(()=>S()),r.$$.on_destroy.push(()=>x()),r.$$.on_destroy.push(()=>m());let{diffViewModel:y}=t;b();const M=y.keybindings;je(r,M,P=>e(11,h=P));const F=y.requestId;je(r,F,P=>e(9,a=P));let R,nt="x",H="Copy request ID",G=()=>{};return r.$$set=P=>{"diffViewModel"in P&&b(e(0,y=P.diffViewModel))},r.$$.update=()=>{var P;2&r.$$.dirty&&(e(8,s=c.disableResolution),x(),x=ue(s,bt=>e(12,f=bt))),2&r.$$.dirty&&(e(7,i=c.disableApply),m(),m=ue(i,bt=>e(13,p=bt))),2&r.$$.dirty&&(c.currFocusedChunkIdx!==void 0?e(2,nt=(c.currFocusedChunkIdx+1).toString()):e(2,nt="x")),2&r.$$.dirty&&(e(6,n=c.isLoading),S(),S=ue(n,bt=>e(10,u=bt))),2&r.$$.dirty&&e(5,o=!!((P=c.leaves)!=null&&P.length))},[y,c,nt,H,G,o,n,i,s,a,u,h,f,p,M,F,function(P){P||(clearTimeout(R),R=void 0,e(3,H="Copy request ID"))},async function(){a&&(await navigator.clipboard.writeText(a),e(3,H="Copied!"),clearTimeout(R),R=setTimeout(G,1500))},function(P){G=P,e(4,G)}]}class Ka extends Pe{constructor(t){super(),He(this,t,Ba,Va,ze,{diffViewModel:0})}}var Lr="Expected a function",Kn=NaN,Qa="[object Symbol]",Za=/^\s+|\s+$/g,Xa=/^[-+]0x[0-9a-f]+$/i,Ja=/^0b[01]+$/i,Ya=/^0o[0-7]+$/i,tc=parseInt,ec=typeof zt=="object"&&zt&&zt.Object===Object&&zt,sc=typeof self=="object"&&self&&self.Object===Object&&self,ic=ec||sc||Function("return this")(),nc=Object.prototype.toString,rc=Math.max,oc=Math.min,bi=function(){return ic.Date.now()};function ac(r,t,e){var s,i,n,o,a,c,u=0,h=!1,f=!1,p=!0;if(typeof r!="function")throw new TypeError(Lr);function _(y){var M=s,F=i;return s=i=void 0,u=y,o=r.apply(F,M)}function b(y){var M=y-c;return c===void 0||M>=t||M<0||f&&y-u>=n}function S(){var y=bi();if(b(y))return x(y);a=setTimeout(S,function(M){var F=t-(M-c);return f?oc(F,n-(M-u)):F}(y))}function x(y){return a=void 0,p&&s?_(y):(s=i=void 0,o)}function m(){var y=bi(),M=b(y);if(s=arguments,i=this,c=y,M){if(a===void 0)return function(F){return u=F,a=setTimeout(S,t),h?_(F):o}(c);if(f)return a=setTimeout(S,t),_(c)}return a===void 0&&(a=setTimeout(S,t)),o}return t=Qn(t)||0,Ys(e)&&(h=!!e.leading,n=(f="maxWait"in e)?rc(Qn(e.maxWait)||0,t):n,p="trailing"in e?!!e.trailing:p),m.cancel=function(){a!==void 0&&clearTimeout(a),u=0,s=c=i=a=void 0},m.flush=function(){return a===void 0?o:x(bi())},m}function Ys(r){var t=typeof r;return!!r&&(t=="object"||t=="function")}function Qn(r){if(typeof r=="number")return r;if(function(s){return typeof s=="symbol"||function(i){return!!i&&typeof i=="object"}(s)&&nc.call(s)==Qa}(r))return Kn;if(Ys(r)){var t=typeof r.valueOf=="function"?r.valueOf():r;r=Ys(t)?t+"":t}if(typeof r!="string")return r===0?r:+r;r=r.replace(Za,"");var e=Ja.test(r);return e||Ya.test(r)?tc(r.slice(2),e?2:8):Xa.test(r)?Kn:+r}const cc=Gi(function(r,t,e){var s=!0,i=!0;if(typeof r!="function")throw new TypeError(Lr);return Ys(e)&&(s="leading"in e?!!e.leading:s,i="trailing"in e?!!e.trailing:i),ac(r,t,{leading:s,maxWait:t,trailing:i})});function fe(r){return Array.isArray?Array.isArray(r):qr(r)==="[object Array]"}const lc=1/0;function hc(r){return r==null?"":function(t){if(typeof t=="string")return t;let e=t+"";return e=="0"&&1/t==-lc?"-0":e}(r)}function ie(r){return typeof r=="string"}function Dr(r){return typeof r=="number"}function uc(r){return r===!0||r===!1||function(t){return Rr(t)&&t!==null}(r)&&qr(r)=="[object Boolean]"}function Rr(r){return typeof r=="object"}function qt(r){return r!=null}function Ci(r){return!r.trim().length}function qr(r){return r==null?r===void 0?"[object Undefined]":"[object Null]":Object.prototype.toString.call(r)}const dc=r=>`Missing ${r} property in key`,fc=r=>`Property 'weight' in key '${r}' must be a positive integer`,Zn=Object.prototype.hasOwnProperty;class pc{constructor(t){this._keys=[],this._keyMap={};let e=0;t.forEach(s=>{let i=Ur(s);this._keys.push(i),this._keyMap[i.id]=i,e+=i.weight}),this._keys.forEach(s=>{s.weight/=e})}get(t){return this._keyMap[t]}keys(){return this._keys}toJSON(){return JSON.stringify(this._keys)}}function Ur(r){let t=null,e=null,s=null,i=1,n=null;if(ie(r)||fe(r))s=r,t=Xn(r),e=ji(r);else{if(!Zn.call(r,"name"))throw new Error(dc("name"));const o=r.name;if(s=o,Zn.call(r,"weight")&&(i=r.weight,i<=0))throw new Error(fc(o));t=Xn(o),e=ji(o),n=r.getFn}return{path:t,id:e,weight:i,src:s,getFn:n}}function Xn(r){return fe(r)?r:r.split(".")}function ji(r){return fe(r)?r.join("."):r}var q={isCaseSensitive:!1,includeScore:!1,keys:[],shouldSort:!0,sortFn:(r,t)=>r.score===t.score?r.idx<t.idx?-1:1:r.score<t.score?-1:1,includeMatches:!1,findAllMatches:!1,minMatchCharLength:1,location:0,threshold:.6,distance:100,useExtendedSearch:!1,getFn:function(r,t){let e=[],s=!1;const i=(n,o,a)=>{if(qt(n))if(o[a]){const c=n[o[a]];if(!qt(c))return;if(a===o.length-1&&(ie(c)||Dr(c)||uc(c)))e.push(hc(c));else if(fe(c)){s=!0;for(let u=0,h=c.length;u<h;u+=1)i(c[u],o,a+1)}else o.length&&i(c,o,a+1)}else e.push(n)};return i(r,ie(t)?t.split("."):t,0),s?e:e[0]},ignoreLocation:!1,ignoreFieldNorm:!1,fieldNormWeight:1};const gc=/[^ ]+/g;class Ji{constructor({getFn:t=q.getFn,fieldNormWeight:e=q.fieldNormWeight}={}){this.norm=function(s=1,i=3){const n=new Map,o=Math.pow(10,i);return{get(a){const c=a.match(gc).length;if(n.has(c))return n.get(c);const u=1/Math.pow(c,.5*s),h=parseFloat(Math.round(u*o)/o);return n.set(c,h),h},clear(){n.clear()}}}(e,3),this.getFn=t,this.isCreated=!1,this.setIndexRecords()}setSources(t=[]){this.docs=t}setIndexRecords(t=[]){this.records=t}setKeys(t=[]){this.keys=t,this._keysMap={},t.forEach((e,s)=>{this._keysMap[e.id]=s})}create(){!this.isCreated&&this.docs.length&&(this.isCreated=!0,ie(this.docs[0])?this.docs.forEach((t,e)=>{this._addString(t,e)}):this.docs.forEach((t,e)=>{this._addObject(t,e)}),this.norm.clear())}add(t){const e=this.size();ie(t)?this._addString(t,e):this._addObject(t,e)}removeAt(t){this.records.splice(t,1);for(let e=t,s=this.size();e<s;e+=1)this.records[e].i-=1}getValueForItemAtKeyId(t,e){return t[this._keysMap[e]]}size(){return this.records.length}_addString(t,e){if(!qt(t)||Ci(t))return;let s={v:t,i:e,n:this.norm.get(t)};this.records.push(s)}_addObject(t,e){let s={i:e,$:{}};this.keys.forEach((i,n)=>{let o=i.getFn?i.getFn(t):this.getFn(t,i.path);if(qt(o)){if(fe(o)){let a=[];const c=[{nestedArrIndex:-1,value:o}];for(;c.length;){const{nestedArrIndex:u,value:h}=c.pop();if(qt(h))if(ie(h)&&!Ci(h)){let f={v:h,i:u,n:this.norm.get(h)};a.push(f)}else fe(h)&&h.forEach((f,p)=>{c.push({nestedArrIndex:p,value:f})})}s.$[n]=a}else if(ie(o)&&!Ci(o)){let a={v:o,n:this.norm.get(o)};s.$[n]=a}}}),this.records.push(s)}toJSON(){return{keys:this.keys,records:this.records}}}function jr(r,t,{getFn:e=q.getFn,fieldNormWeight:s=q.fieldNormWeight}={}){const i=new Ji({getFn:e,fieldNormWeight:s});return i.setKeys(r.map(Ur)),i.setSources(t),i.create(),i}function js(r,{errors:t=0,currentLocation:e=0,expectedLocation:s=0,distance:i=q.distance,ignoreLocation:n=q.ignoreLocation}={}){const o=t/r.length;if(n)return o;const a=Math.abs(s-e);return i?o+a/i:a?1:o}const De=32;function mc(r,t,e,{location:s=q.location,distance:i=q.distance,threshold:n=q.threshold,findAllMatches:o=q.findAllMatches,minMatchCharLength:a=q.minMatchCharLength,includeMatches:c=q.includeMatches,ignoreLocation:u=q.ignoreLocation}={}){if(t.length>De)throw new Error(`Pattern length exceeds max of ${De}.`);const h=t.length,f=r.length,p=Math.max(0,Math.min(s,f));let _=n,b=p;const S=a>1||c,x=S?Array(f):[];let m;for(;(m=r.indexOf(t,b))>-1;){let H=js(t,{currentLocation:m,expectedLocation:p,distance:i,ignoreLocation:u});if(_=Math.min(H,_),b=m+h,S){let G=0;for(;G<h;)x[m+G]=1,G+=1}}b=-1;let y=[],M=1,F=h+f;const R=1<<h-1;for(let H=0;H<h;H+=1){let G=0,P=F;for(;G<P;)js(t,{errors:H,currentLocation:p+P,expectedLocation:p,distance:i,ignoreLocation:u})<=_?G=P:F=P,P=Math.floor((F-G)/2+G);F=P;let bt=Math.max(1,p-P+1),ut=o?f:Math.min(p+P,f)+h,Mt=Array(ut+2);Mt[ut+1]=(1<<H)-1;for(let B=ut;B>=bt;B-=1){let z=B-1,Ut=e[r.charAt(z)];if(S&&(x[z]=+!!Ut),Mt[B]=(Mt[B+1]<<1|1)&Ut,H&&(Mt[B]|=(y[B+1]|y[B])<<1|1|y[B+1]),Mt[B]&R&&(M=js(t,{errors:H,currentLocation:z,expectedLocation:p,distance:i,ignoreLocation:u}),M<=_)){if(_=M,b=z,b<=p)break;bt=Math.max(1,2*p-b)}}if(js(t,{errors:H+1,currentLocation:p,expectedLocation:p,distance:i,ignoreLocation:u})>_)break;y=Mt}const nt={isMatch:b>=0,score:Math.max(.001,M)};if(S){const H=function(G=[],P=q.minMatchCharLength){let bt=[],ut=-1,Mt=-1,B=0;for(let z=G.length;B<z;B+=1){let Ut=G[B];Ut&&ut===-1?ut=B:Ut||ut===-1||(Mt=B-1,Mt-ut+1>=P&&bt.push([ut,Mt]),ut=-1)}return G[B-1]&&B-ut>=P&&bt.push([ut,B-1]),bt}(x,a);H.length?c&&(nt.indices=H):nt.isMatch=!1}return nt}function _c(r){let t={};for(let e=0,s=r.length;e<s;e+=1){const i=r.charAt(e);t[i]=(t[i]||0)|1<<s-e-1}return t}class Pr{constructor(t,{location:e=q.location,threshold:s=q.threshold,distance:i=q.distance,includeMatches:n=q.includeMatches,findAllMatches:o=q.findAllMatches,minMatchCharLength:a=q.minMatchCharLength,isCaseSensitive:c=q.isCaseSensitive,ignoreLocation:u=q.ignoreLocation}={}){if(this.options={location:e,threshold:s,distance:i,includeMatches:n,findAllMatches:o,minMatchCharLength:a,isCaseSensitive:c,ignoreLocation:u},this.pattern=c?t:t.toLowerCase(),this.chunks=[],!this.pattern.length)return;const h=(p,_)=>{this.chunks.push({pattern:p,alphabet:_c(p),startIndex:_})},f=this.pattern.length;if(f>De){let p=0;const _=f%De,b=f-_;for(;p<b;)h(this.pattern.substr(p,De),p),p+=De;if(_){const S=f-De;h(this.pattern.substr(S),S)}}else h(this.pattern,0)}searchIn(t){const{isCaseSensitive:e,includeMatches:s}=this.options;if(e||(t=t.toLowerCase()),this.pattern===t){let b={isMatch:!0,score:0};return s&&(b.indices=[[0,t.length-1]]),b}const{location:i,distance:n,threshold:o,findAllMatches:a,minMatchCharLength:c,ignoreLocation:u}=this.options;let h=[],f=0,p=!1;this.chunks.forEach(({pattern:b,alphabet:S,startIndex:x})=>{const{isMatch:m,score:y,indices:M}=mc(t,b,S,{location:i+x,distance:n,threshold:o,findAllMatches:a,minMatchCharLength:c,includeMatches:s,ignoreLocation:u});m&&(p=!0),f+=y,m&&M&&(h=[...h,...M])});let _={isMatch:p,score:p?f/this.chunks.length:1};return p&&s&&(_.indices=h),_}}class Ce{constructor(t){this.pattern=t}static isMultiMatch(t){return Jn(t,this.multiRegex)}static isSingleMatch(t){return Jn(t,this.singleRegex)}search(){}}function Jn(r,t){const e=r.match(t);return e?e[1]:null}class Hr extends Ce{constructor(t,{location:e=q.location,threshold:s=q.threshold,distance:i=q.distance,includeMatches:n=q.includeMatches,findAllMatches:o=q.findAllMatches,minMatchCharLength:a=q.minMatchCharLength,isCaseSensitive:c=q.isCaseSensitive,ignoreLocation:u=q.ignoreLocation}={}){super(t),this._bitapSearch=new Pr(t,{location:e,threshold:s,distance:i,includeMatches:n,findAllMatches:o,minMatchCharLength:a,isCaseSensitive:c,ignoreLocation:u})}static get type(){return"fuzzy"}static get multiRegex(){return/^"(.*)"$/}static get singleRegex(){return/^(.*)$/}search(t){return this._bitapSearch.searchIn(t)}}class zr extends Ce{constructor(t){super(t)}static get type(){return"include"}static get multiRegex(){return/^'"(.*)"$/}static get singleRegex(){return/^'(.*)$/}search(t){let e,s=0;const i=[],n=this.pattern.length;for(;(e=t.indexOf(this.pattern,s))>-1;)s=e+n,i.push([e,s-1]);const o=!!i.length;return{isMatch:o,score:o?0:1,indices:i}}}const Pi=[class extends Ce{constructor(r){super(r)}static get type(){return"exact"}static get multiRegex(){return/^="(.*)"$/}static get singleRegex(){return/^=(.*)$/}search(r){const t=r===this.pattern;return{isMatch:t,score:t?0:1,indices:[0,this.pattern.length-1]}}},zr,class extends Ce{constructor(r){super(r)}static get type(){return"prefix-exact"}static get multiRegex(){return/^\^"(.*)"$/}static get singleRegex(){return/^\^(.*)$/}search(r){const t=r.startsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,this.pattern.length-1]}}},class extends Ce{constructor(r){super(r)}static get type(){return"inverse-prefix-exact"}static get multiRegex(){return/^!\^"(.*)"$/}static get singleRegex(){return/^!\^(.*)$/}search(r){const t=!r.startsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,r.length-1]}}},class extends Ce{constructor(r){super(r)}static get type(){return"inverse-suffix-exact"}static get multiRegex(){return/^!"(.*)"\$$/}static get singleRegex(){return/^!(.*)\$$/}search(r){const t=!r.endsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,r.length-1]}}},class extends Ce{constructor(r){super(r)}static get type(){return"suffix-exact"}static get multiRegex(){return/^"(.*)"\$$/}static get singleRegex(){return/^(.*)\$$/}search(r){const t=r.endsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[r.length-this.pattern.length,r.length-1]}}},class extends Ce{constructor(r){super(r)}static get type(){return"inverse-exact"}static get multiRegex(){return/^!"(.*)"$/}static get singleRegex(){return/^!(.*)$/}search(r){const t=r.indexOf(this.pattern)===-1;return{isMatch:t,score:t?0:1,indices:[0,r.length-1]}}},Hr],Yn=Pi.length,yc=/ +(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/,vc=new Set([Hr.type,zr.type]);class $c{constructor(t,{isCaseSensitive:e=q.isCaseSensitive,includeMatches:s=q.includeMatches,minMatchCharLength:i=q.minMatchCharLength,ignoreLocation:n=q.ignoreLocation,findAllMatches:o=q.findAllMatches,location:a=q.location,threshold:c=q.threshold,distance:u=q.distance}={}){this.query=null,this.options={isCaseSensitive:e,includeMatches:s,minMatchCharLength:i,findAllMatches:o,ignoreLocation:n,location:a,threshold:c,distance:u},this.pattern=e?t:t.toLowerCase(),this.query=function(h,f={}){return h.split("|").map(p=>{let _=p.trim().split(yc).filter(S=>S&&!!S.trim()),b=[];for(let S=0,x=_.length;S<x;S+=1){const m=_[S];let y=!1,M=-1;for(;!y&&++M<Yn;){const F=Pi[M];let R=F.isMultiMatch(m);R&&(b.push(new F(R,f)),y=!0)}if(!y)for(M=-1;++M<Yn;){const F=Pi[M];let R=F.isSingleMatch(m);if(R){b.push(new F(R,f));break}}}return b})}(this.pattern,this.options)}static condition(t,e){return e.useExtendedSearch}searchIn(t){const e=this.query;if(!e)return{isMatch:!1,score:1};const{includeMatches:s,isCaseSensitive:i}=this.options;t=i?t:t.toLowerCase();let n=0,o=[],a=0;for(let c=0,u=e.length;c<u;c+=1){const h=e[c];o.length=0,n=0;for(let f=0,p=h.length;f<p;f+=1){const _=h[f],{isMatch:b,indices:S,score:x}=_.search(t);if(!b){a=0,n=0,o.length=0;break}if(n+=1,a+=x,s){const m=_.constructor.type;vc.has(m)?o=[...o,...S]:o.push(S)}}if(n){let f={isMatch:!0,score:a/n};return s&&(f.indices=o),f}}return{isMatch:!1,score:1}}}const Hi=[];function zi(r,t){for(let e=0,s=Hi.length;e<s;e+=1){let i=Hi[e];if(i.condition(r,t))return new i(r,t)}return new Pr(r,t)}const Yi="$and",bc="$or",tr="$path",Cc="$val",Si=r=>!(!r[Yi]&&!r[bc]),er=r=>({[Yi]:Object.keys(r).map(t=>({[t]:r[t]}))});function Wr(r,t,{auto:e=!0}={}){const s=i=>{let n=Object.keys(i);const o=(c=>!!c[tr])(i);if(!o&&n.length>1&&!Si(i))return s(er(i));if((c=>!fe(c)&&Rr(c)&&!Si(c))(i)){const c=o?i[tr]:n[0],u=o?i[Cc]:i[c];if(!ie(u))throw new Error((f=>`Invalid value for key ${f}`)(c));const h={keyId:ji(c),pattern:u};return e&&(h.searcher=zi(u,t)),h}let a={children:[],operator:n[0]};return n.forEach(c=>{const u=i[c];fe(u)&&u.forEach(h=>{a.children.push(s(h))})}),a};return Si(r)||(r=er(r)),s(r)}function Sc(r,t){const e=r.matches;t.matches=[],qt(e)&&e.forEach(s=>{if(!qt(s.indices)||!s.indices.length)return;const{indices:i,value:n}=s;let o={indices:i,value:n};s.key&&(o.key=s.key.src),s.idx>-1&&(o.refIndex=s.idx),t.matches.push(o)})}function xc(r,t){t.score=r.score}class Ze{constructor(t,e={},s){this.options={...q,...e},this.options.useExtendedSearch,this._keyStore=new pc(this.options.keys),this.setCollection(t,s)}setCollection(t,e){if(this._docs=t,e&&!(e instanceof Ji))throw new Error("Incorrect 'index' type");this._myIndex=e||jr(this.options.keys,this._docs,{getFn:this.options.getFn,fieldNormWeight:this.options.fieldNormWeight})}add(t){qt(t)&&(this._docs.push(t),this._myIndex.add(t))}remove(t=()=>!1){const e=[];for(let s=0,i=this._docs.length;s<i;s+=1){const n=this._docs[s];t(n,s)&&(this.removeAt(s),s-=1,i-=1,e.push(n))}return e}removeAt(t){this._docs.splice(t,1),this._myIndex.removeAt(t)}getIndex(){return this._myIndex}search(t,{limit:e=-1}={}){const{includeMatches:s,includeScore:i,shouldSort:n,sortFn:o,ignoreFieldNorm:a}=this.options;let c=ie(t)?ie(this._docs[0])?this._searchStringList(t):this._searchObjectList(t):this._searchLogical(t);return function(u,{ignoreFieldNorm:h=q.ignoreFieldNorm}){u.forEach(f=>{let p=1;f.matches.forEach(({key:_,norm:b,score:S})=>{const x=_?_.weight:null;p*=Math.pow(S===0&&x?Number.EPSILON:S,(x||1)*(h?1:b))}),f.score=p})}(c,{ignoreFieldNorm:a}),n&&c.sort(o),Dr(e)&&e>-1&&(c=c.slice(0,e)),function(u,h,{includeMatches:f=q.includeMatches,includeScore:p=q.includeScore}={}){const _=[];return f&&_.push(Sc),p&&_.push(xc),u.map(b=>{const{idx:S}=b,x={item:h[S],refIndex:S};return _.length&&_.forEach(m=>{m(b,x)}),x})}(c,this._docs,{includeMatches:s,includeScore:i})}_searchStringList(t){const e=zi(t,this.options),{records:s}=this._myIndex,i=[];return s.forEach(({v:n,i:o,n:a})=>{if(!qt(n))return;const{isMatch:c,score:u,indices:h}=e.searchIn(n);c&&i.push({item:n,idx:o,matches:[{score:u,value:n,norm:a,indices:h}]})}),i}_searchLogical(t){const e=Wr(t,this.options),s=(a,c,u)=>{if(!a.children){const{keyId:f,searcher:p}=a,_=this._findMatches({key:this._keyStore.get(f),value:this._myIndex.getValueForItemAtKeyId(c,f),searcher:p});return _&&_.length?[{idx:u,item:c,matches:_}]:[]}const h=[];for(let f=0,p=a.children.length;f<p;f+=1){const _=a.children[f],b=s(_,c,u);if(b.length)h.push(...b);else if(a.operator===Yi)return[]}return h},i=this._myIndex.records,n={},o=[];return i.forEach(({$:a,i:c})=>{if(qt(a)){let u=s(e,a,c);u.length&&(n[c]||(n[c]={idx:c,item:a,matches:[]},o.push(n[c])),u.forEach(({matches:h})=>{n[c].matches.push(...h)}))}}),o}_searchObjectList(t){const e=zi(t,this.options),{keys:s,records:i}=this._myIndex,n=[];return i.forEach(({$:o,i:a})=>{if(!qt(o))return;let c=[];s.forEach((u,h)=>{c.push(...this._findMatches({key:u,value:o[h],searcher:e}))}),c.length&&n.push({idx:a,item:o,matches:c})}),n}_findMatches({key:t,value:e,searcher:s}){if(!qt(e))return[];let i=[];if(fe(e))e.forEach(({v:n,i:o,n:a})=>{if(!qt(n))return;const{isMatch:c,score:u,indices:h}=s.searchIn(n);c&&i.push({score:u,key:t,value:n,idx:o,norm:a,indices:h})});else{const{v:n,n:o}=e,{isMatch:a,score:c,indices:u}=s.searchIn(n);a&&i.push({score:c,key:t,value:n,norm:o,indices:u})}return i}}Ze.version="7.0.0",Ze.createIndex=jr,Ze.parseIndex=function(r,{getFn:t=q.getFn,fieldNormWeight:e=q.fieldNormWeight}={}){const{keys:s,records:i}=r,n=new Ji({getFn:t,fieldNormWeight:e});return n.setKeys(s),n.setIndexRecords(i),n},Ze.config=q,Ze.parseQuery=Wr,function(...r){Hi.push(...r)}($c);const Se=class Se{constructor(t,e){l(this,"_disposers",[]);l(this,"_allMentionables",ht([]));l(this,"_breadcrumbIds",ht([]));l(this,"_userQuery",ht(""));l(this,"_active",ht(!1));l(this,"_allGroups",fi([this._active,this._allMentionables],([t,e])=>t?Do(e):[]));l(this,"_currentGroup",fi([this._breadcrumbIds,this._allGroups],([t,e])=>{if(t.length===0)return;const s=t[t.length-1];return e.find(i=>_s(i)&&i.id===s)}));l(this,"dispose",()=>{for(const t of this._disposers)t()});l(this,"openDropdown",()=>{this._active.set(!0)});l(this,"closeDropdown",()=>{this._active.set(!1),this._resetState()});l(this,"toggleDropdown",()=>lt(this._active)?(this.closeDropdown(),!1):(this.openDropdown(),!0));l(this,"pushBreadcrumb",t=>{lt(this._active)&&this._breadcrumbIds.update(e=>[...e,t.id])});l(this,"popBreadcrumb",()=>{lt(this._active)&&this._breadcrumbIds.update(t=>t.slice(0,-1))});l(this,"selectMentionable",t=>{var i;const e=this._chatModel.extensionClient,s=this._chatModel.specialContextInputModel;return _s(t)&&t.type==="breadcrumb"?(this.pushBreadcrumb(t),!0):t.type==="breadcrumb-back"?(this.popBreadcrumb(),!0):yr(t)?(s.markAllActive(),this.closeDropdown(),e.reportWebviewClientEvent(Ii.chatRestoreDefaultContext),!0):t.clearContext?(s.markAllInactive(),this.closeDropdown(),e.reportWebviewClientEvent(Ii.chatClearContext),!0):t.userGuidelines?(e.openSettingsPage("guidelines"),this.closeDropdown(),!0):((i=this._insertMentionNode)==null||i.call(this,t),this.closeDropdown(),!0)});l(this,"_displayItems",fi([this._active,this._breadcrumbIds,this._userQuery,this._currentGroup,this.allGroups],([t,e,s,i,n])=>{if(!t)return[];if(e.length>0&&i)return[{...i,type:"breadcrumb-back"},...i.group.items.slice(0,Se.SINGLE_GROUP_MAX_ITEMS).map(o=>({...o,type:"item"}))];if(s.length>0){const o=wc(lt(this._userQuery)).map(a=>({...a,type:"item"}));return n.flatMap(a=>[{...a,type:"breadcrumb"},...a.group.items.slice(0,Se.MULTI_GROUP_MAX_ITEMS).map(c=>({...c,type:"item"}))]).concat(o)}return[{...vr,type:"item"},...n.map(o=>({...o,type:"breadcrumb"})),{...$r,type:"item"},{...br,type:"item"}]}));l(this,"_refreshSeqNum",0);l(this,"_refreshMentionables",cc(async()=>{if(!lt(this._active))return;this._refreshSeqNum++;const t=this._refreshSeqNum,e=this._chatModel.currentConversationModel&&ts(this._chatModel.currentConversationModel),s=lt(this._userQuery),i=await this._chatModel.extensionClient.getSuggestions(s,e);t===this._refreshSeqNum&&this._allMentionables.set(Gr({query:s,mentionables:i}))},Se.REFRESH_THROTTLE_MS,{leading:!0,trailing:!0}));this._chatModel=t,this._insertMentionNode=e,this._disposers.push(this._userQuery.subscribe(this._refreshMentionables)),this._disposers.push(this._active.subscribe(this._refreshMentionables))}get allGroups(){return this._allGroups}get currentGroup(){return this._currentGroup}get breadcrumbIds(){return this._breadcrumbIds}get displayItems(){return this._displayItems}get active(){return this._active}get userQuery(){return this._userQuery}_resetState(){this._breadcrumbIds.set([]),this._userQuery.set("")}};l(Se,"REFRESH_THROTTLE_MS",600),l(Se,"SINGLE_GROUP_MAX_ITEMS",12),l(Se,"MULTI_GROUP_MAX_ITEMS",6);let Wi=Se;const Gr=({query:r,mentionables:t,returnAllIfNoResults:e=!0,threshold:s=1})=>{if(r.length<=1)return t;const i=new Ze(t,{keys:["label"],threshold:s,minMatchCharLength:0,ignoreLocation:!0,includeScore:!0,useExtendedSearch:!1,shouldSort:!0,findAllMatches:!0}).search(r);return i.length===0&&e?t:i.map(n=>n.item)},wc=r=>Gr({query:r,mentionables:[vr,$r,br],returnAllIfNoResults:!1,threshold:.6});function ti(r){switch(r){case he.DEFAULT:return On;case he.PROTOTYPER:return Zo;case he.BRAINSTORM:return Qo;case he.REVIEWER:return Ko;default:return On}}function Mc(r){let t,e,s,i=r[0].label+"";return{c(){t=Y("span"),e=Y("span"),s=pt(i),Q(e,"class","c-mentionable-group-label__text right"),Q(t,"class","c-mentionable-group-label")},m(n,o){O(n,t,o),tt(t,e),tt(e,s)},p(n,o){1&o&&i!==(i=n[0].label+"")&&Yt(s,i)},i:J,o:J,d(n){n&&N(t)}}}function Ic(r){let t,e;return t=new Xo({props:{$$slots:{text:[Rc],leftIcon:[Dc]},$$scope:{ctx:r}}}),{c(){E(t.$$.fragment)},m(s,i){k(t,s,i),e=!0},p(s,i){const n={};17&i&&(n.$$scope={dirty:i,ctx:s}),t.$set(n)},i(s){e||($(t.$$.fragment,s),e=!0)},o(s){C(t.$$.fragment,s),e=!1},d(s){T(t,s)}}}function Ec(r){let t,e=r[0].label+"";return{c(){t=pt(e)},m(s,i){O(s,t,i)},p(s,i){1&i&&e!==(e=s[0].label+"")&&Yt(t,e)},i:J,o:J,d(s){s&&N(t)}}}function kc(r){let t,e;return t=new Tt({props:{filepath:r[0].rule.path,$$slots:{leftIcon:[qc]},$$scope:{ctx:r}}}),{c(){E(t.$$.fragment)},m(s,i){k(t,s,i),e=!0},p(s,i){const n={};1&i&&(n.filepath=s[0].rule.path),16&i&&(n.$$scope={dirty:i,ctx:s}),t.$set(n)},i(s){e||($(t.$$.fragment,s),e=!0)},o(s){C(t.$$.fragment,s),e=!1},d(s){T(t,s)}}}function Tc(r){let t,e;return t=new Tt({props:{filepath:r[0].recentFile.pathName,$$slots:{leftIcon:[Uc]},$$scope:{ctx:r}}}),{c(){E(t.$$.fragment)},m(s,i){k(t,s,i),e=!0},p(s,i){const n={};1&i&&(n.filepath=s[0].recentFile.pathName),16&i&&(n.$$scope={dirty:i,ctx:s}),t.$set(n)},i(s){e||($(t.$$.fragment,s),e=!0)},o(s){C(t.$$.fragment,s),e=!1},d(s){T(t,s)}}}function Ac(r){let t,e;return t=new Tt({props:{filepath:r[0].selection.pathName,$$slots:{leftIcon:[jc]},$$scope:{ctx:r}}}),{c(){E(t.$$.fragment)},m(s,i){k(t,s,i),e=!0},p(s,i){const n={};1&i&&(n.filepath=s[0].selection.pathName),16&i&&(n.$$scope={dirty:i,ctx:s}),t.$set(n)},i(s){e||($(t.$$.fragment,s),e=!0)},o(s){C(t.$$.fragment,s),e=!1},d(s){T(t,s)}}}function Fc(r){let t,e;return t=new Tt({props:{filepath:r[0].sourceFolder.folderRoot,$$slots:{leftIcon:[Pc]},$$scope:{ctx:r}}}),{c(){E(t.$$.fragment)},m(s,i){k(t,s,i),e=!0},p(s,i){const n={};1&i&&(n.filepath=s[0].sourceFolder.folderRoot),16&i&&(n.$$scope={dirty:i,ctx:s}),t.$set(n)},i(s){e||($(t.$$.fragment,s),e=!0)},o(s){C(t.$$.fragment,s),e=!1},d(s){T(t,s)}}}function Oc(r){let t,e;return t=new Tt({props:{filepath:r[0].externalSource.name,$$slots:{leftIcon:[Hc]},$$scope:{ctx:r}}}),{c(){E(t.$$.fragment)},m(s,i){k(t,s,i),e=!0},p(s,i){const n={};1&i&&(n.filepath=s[0].externalSource.name),16&i&&(n.$$scope={dirty:i,ctx:s}),t.$set(n)},i(s){e||($(t.$$.fragment,s),e=!0)},o(s){C(t.$$.fragment,s),e=!1},d(s){T(t,s)}}}function Nc(r){let t,e;return t=new Tt({props:{filepath:r[0].folder.pathName,$$slots:{leftIcon:[zc]},$$scope:{ctx:r}}}),{c(){E(t.$$.fragment)},m(s,i){k(t,s,i),e=!0},p(s,i){const n={};1&i&&(n.filepath=s[0].folder.pathName),16&i&&(n.$$scope={dirty:i,ctx:s}),t.$set(n)},i(s){e||($(t.$$.fragment,s),e=!0)},o(s){C(t.$$.fragment,s),e=!1},d(s){T(t,s)}}}function Lc(r){let t,e;return t=new Tt({props:{filepath:r[0].file.pathName,$$slots:{leftIcon:[Wc]},$$scope:{ctx:r}}}),{c(){E(t.$$.fragment)},m(s,i){k(t,s,i),e=!0},p(s,i){const n={};1&i&&(n.filepath=s[0].file.pathName),16&i&&(n.$$scope={dirty:i,ctx:s}),t.$set(n)},i(s){e||($(t.$$.fragment,s),e=!0)},o(s){C(t.$$.fragment,s),e=!1},d(s){T(t,s)}}}function Dc(r){let t,e,s;var i=ti(r[0].personality.type);return i&&(e=rs(i,{})),{c(){t=Y("span"),e&&E(e.$$.fragment),Q(t,"slot","leftIcon"),Q(t,"class","c-context-menu-item__icon svelte-1a2w9oo")},m(n,o){O(n,t,o),e&&k(e,t,null),s=!0},p(n,o){if(1&o&&i!==(i=ti(n[0].personality.type))){if(e){vt();const a=e;C(a.$$.fragment,1,0,()=>{T(a,1)}),$t()}i?(e=rs(i,{}),E(e.$$.fragment),$(e.$$.fragment,1),k(e,t,null)):e=null}},i(n){s||(e&&$(e.$$.fragment,n),s=!0)},o(n){e&&C(e.$$.fragment,n),s=!1},d(n){n&&N(t),e&&T(e)}}}function Rc(r){let t,e,s=r[0].label+"";return{c(){t=Y("span"),e=pt(s),Q(t,"slot","text")},m(i,n){O(i,t,n),tt(t,e)},p(i,n){1&n&&s!==(s=i[0].label+"")&&Yt(e,s)},d(i){i&&N(t)}}}function qc(r){let t,e;return t=new Mr({props:{slot:"leftIcon",iconName:"rule"}}),{c(){E(t.$$.fragment)},m(s,i){k(t,s,i),e=!0},p:J,i(s){e||($(t.$$.fragment,s),e=!0)},o(s){C(t.$$.fragment,s),e=!1},d(s){T(t,s)}}}function Uc(r){let t,e;return t=new os({props:{slot:"leftIcon",iconName:"description"}}),{c(){E(t.$$.fragment)},m(s,i){k(t,s,i),e=!0},p:J,i(s){e||($(t.$$.fragment,s),e=!0)},o(s){C(t.$$.fragment,s),e=!1},d(s){T(t,s)}}}function jc(r){let t,e;return t=new os({props:{slot:"leftIcon",iconName:"text_select_start"}}),{c(){E(t.$$.fragment)},m(s,i){k(t,s,i),e=!0},p:J,i(s){e||($(t.$$.fragment,s),e=!0)},o(s){C(t.$$.fragment,s),e=!1},d(s){T(t,s)}}}function Pc(r){let t,e;return t=new os({props:{slot:"leftIcon",iconName:"folder_managed"}}),{c(){E(t.$$.fragment)},m(s,i){k(t,s,i),e=!0},p:J,i(s){e||($(t.$$.fragment,s),e=!0)},o(s){C(t.$$.fragment,s),e=!1},d(s){T(t,s)}}}function Hc(r){let t,e;return t=new os({props:{slot:"leftIcon",iconName:"import_contacts"}}),{c(){E(t.$$.fragment)},m(s,i){k(t,s,i),e=!0},p:J,i(s){e||($(t.$$.fragment,s),e=!0)},o(s){C(t.$$.fragment,s),e=!1},d(s){T(t,s)}}}function zc(r){let t,e;return t=new os({props:{slot:"leftIcon",iconName:"folder_open"}}),{c(){E(t.$$.fragment)},m(s,i){k(t,s,i),e=!0},p:J,i(s){e||($(t.$$.fragment,s),e=!0)},o(s){C(t.$$.fragment,s),e=!1},d(s){T(t,s)}}}function Wc(r){let t,e;return t=new os({props:{slot:"leftIcon",iconName:"description"}}),{c(){E(t.$$.fragment)},m(s,i){k(t,s,i),e=!0},p:J,i(s){e||($(t.$$.fragment,s),e=!0)},o(s){C(t.$$.fragment,s),e=!1},d(s){T(t,s)}}}function Gc(r){let t,e,s,i,n,o,a,c,u,h,f,p,_,b;const S=[Lc,Nc,Oc,Fc,Ac,Tc,kc,Ec,Ic,Mc],x=[];function m(y,M){return 1&M&&(t=null),1&M&&(e=null),1&M&&(s=null),1&M&&(i=null),1&M&&(n=null),1&M&&(o=null),1&M&&(a=null),1&M&&(c=null),1&M&&(u=null),1&M&&(h=null),t==null&&(t=!!Ki(y[0])),t?0:(e==null&&(e=!!Qi(y[0])),e?1:(s==null&&(s=!!Zi(y[0])),s?2:(i==null&&(i=!!Qs(y[0])),i?3:(n==null&&(n=!!Ks(y[0])),n?4:(o==null&&(o=!!Bs(y[0])),o?5:(a==null&&(a=!!Xs(y[0])),a?6:(c==null&&(c=!!_s(y[0])),c?7:(u==null&&(u=!!ei(y[0])),u?8:(h==null&&(h=!!(yr(y[0])||Ro(y[0])||Zs(y[0]))),h?9:-1)))))))))}return~(f=m(r,-1))&&(p=x[f]=S[f](r)),{c(){p&&p.c(),_=ne()},m(y,M){~f&&x[f].m(y,M),O(y,_,M),b=!0},p(y,M){let F=f;f=m(y,M),f===F?~f&&x[f].p(y,M):(p&&(vt(),C(x[F],1,1,()=>{x[F]=null}),$t()),~f?(p=x[f],p?p.p(y,M):(p=x[f]=S[f](y),p.c()),$(p,1),p.m(_.parentNode,_)):p=null)},i(y){b||($(p),b=!0)},o(y){C(p),b=!1},d(y){y&&N(_),~f&&x[f].d(y)}}}function Vc(r){let t,e,s;var i=r[3];function n(o,a){return{props:{highlight:o[2],onSelect:o[1],$$slots:{default:[Gc]},$$scope:{ctx:o}}}}return i&&(t=rs(i,n(r))),{c(){t&&E(t.$$.fragment),e=ne()},m(o,a){t&&k(t,o,a),O(o,e,a),s=!0},p(o,[a]){if(8&a&&i!==(i=o[3])){if(t){vt();const c=t;C(c.$$.fragment,1,0,()=>{T(c,1)}),$t()}i?(t=rs(i,n(o)),E(t.$$.fragment),$(t.$$.fragment,1),k(t,e.parentNode,e)):t=null}else if(i){const c={};4&a&&(c.highlight=o[2]),2&a&&(c.onSelect=o[1]),17&a&&(c.$$scope={dirty:a,ctx:o}),t.$set(c)}},i(o){s||(t&&$(t.$$.fragment,o),s=!0)},o(o){t&&C(t.$$.fragment,o),s=!1},d(o){o&&N(e),t&&T(t,o)}}}function Bc(r,t,e){let s,{item:i}=t,{onSelect:n}=t,{highlight:o}=t;return r.$$set=a=>{"item"in a&&e(0,i=a.item),"onSelect"in a&&e(1,n=a.onSelect),"highlight"in a&&e(2,o=a.highlight)},r.$$.update=()=>{1&r.$$.dirty&&(i.type==="breadcrumb-back"?e(3,s=yi.BreadcrumbBackItem):i.type==="breadcrumb"&&_s(i)?e(3,s=yi.BreadcrumbItem):i.type!=="item"||_s(i)||e(3,s=yi.Item))},[i,n,o,s]}class Kc extends Pe{constructor(t){super(),He(this,t,Bc,Vc,ze,{item:0,onSelect:1,highlight:2})}}function Qc(r){let t,e=r[0].label+"";return{c(){t=pt(e)},m(s,i){O(s,t,i)},p(s,i){1&i&&e!==(e=s[0].label+"")&&Yt(t,e)},i:J,o:J,d(s){s&&N(t)}}}function Zc(r){let t,e,s,i;return t=new Mr({}),s=new Tt({props:{filepath:`${An}/${Fn}/${r[0].rule.path}`}}),{c(){E(t.$$.fragment),e=Z(),E(s.$$.fragment)},m(n,o){k(t,n,o),O(n,e,o),k(s,n,o),i=!0},p(n,o){const a={};1&o&&(a.filepath=`${An}/${Fn}/${n[0].rule.path}`),s.$set(a)},i(n){i||($(t.$$.fragment,n),$(s.$$.fragment,n),i=!0)},o(n){C(t.$$.fragment,n),C(s.$$.fragment,n),i=!1},d(n){n&&N(e),T(t,n),T(s,n)}}}function Xc(r){let t,e,s,i,n,o,a,c;return e=new Jo({props:{heightPx:32,floatHeight:4,animationDuration:2.25,$$slots:{default:[rl]},$$scope:{ctx:r}}}),n=new Gs({props:{size:2,weight:"medium",$$slots:{default:[ol]},$$scope:{ctx:r}}}),a=new Gs({props:{size:1,$$slots:{default:[al]},$$scope:{ctx:r}}}),{c(){t=Y("div"),E(e.$$.fragment),s=Z(),i=Y("div"),E(n.$$.fragment),o=Z(),E(a.$$.fragment),Q(t,"class","c-mention-hover-contents__personality-icon svelte-11069rs"),Q(i,"class","c-mention-hover-contents__personality svelte-11069rs")},m(u,h){O(u,t,h),k(e,t,null),O(u,s,h),O(u,i,h),k(n,i,null),tt(i,o),k(a,i,null),c=!0},p(u,h){const f={};3&h&&(f.$$scope={dirty:h,ctx:u}),e.$set(f);const p={};3&h&&(p.$$scope={dirty:h,ctx:u}),n.$set(p);const _={};3&h&&(_.$$scope={dirty:h,ctx:u}),a.$set(_)},i(u){c||($(e.$$.fragment,u),$(n.$$.fragment,u),$(a.$$.fragment,u),c=!0)},o(u){C(e.$$.fragment,u),C(n.$$.fragment,u),C(a.$$.fragment,u),c=!1},d(u){u&&(N(t),N(s),N(i)),T(e),T(n),T(a)}}}function Jc(r){var n,o;let t,e,s,i;return t=new Yo({}),s=new Tt({props:{filepath:`${r[0].selection.pathName}:L${(n=r[0].selection.fullRange)==null?void 0:n.startLineNumber}-${(o=r[0].selection.fullRange)==null?void 0:o.endLineNumber}`}}),{c(){E(t.$$.fragment),e=Z(),E(s.$$.fragment)},m(a,c){k(t,a,c),O(a,e,c),k(s,a,c),i=!0},p(a,c){var h,f;const u={};1&c&&(u.filepath=`${a[0].selection.pathName}:L${(h=a[0].selection.fullRange)==null?void 0:h.startLineNumber}-${(f=a[0].selection.fullRange)==null?void 0:f.endLineNumber}`),s.$set(u)},i(a){i||($(t.$$.fragment,a),$(s.$$.fragment,a),i=!0)},o(a){C(t.$$.fragment,a),C(s.$$.fragment,a),i=!1},d(a){a&&N(e),T(t,a),T(s,a)}}}function Yc(r){var i;let t,e,s=(r[0].userGuidelines.overLimit||((i=r[0].rulesAndGuidelinesState)==null?void 0:i.overLimit))&&sr(r);return{c(){s&&s.c(),t=ne()},m(n,o){s&&s.m(n,o),O(n,t,o),e=!0},p(n,o){var a;n[0].userGuidelines.overLimit||(a=n[0].rulesAndGuidelinesState)!=null&&a.overLimit?s?(s.p(n,o),1&o&&$(s,1)):(s=sr(n),s.c(),$(s,1),s.m(t.parentNode,t)):s&&(vt(),C(s,1,1,()=>{s=null}),$t())},i(n){e||($(s),e=!0)},o(n){C(s),e=!1},d(n){n&&N(t),s&&s.d(n)}}}function tl(r){let t,e,s,i,n,o,a,c;return s=new ta({}),n=new Tt({props:{class:"c-source-folder-item",filepath:r[0].sourceFolder.folderRoot}}),a=new ea({props:{class:"guidelines-filespan",sourceFolder:r[0].sourceFolder}}),{c(){t=Y("div"),e=Y("div"),E(s.$$.fragment),i=Z(),E(n.$$.fragment),o=Z(),E(a.$$.fragment),Q(e,"class","l-source-folder-name svelte-11069rs"),Q(t,"class","l-mention-hover-contents__source-folder")},m(u,h){O(u,t,h),tt(t,e),k(s,e,null),tt(e,i),k(n,e,null),tt(t,o),k(a,t,null),c=!0},p(u,h){const f={};1&h&&(f.filepath=u[0].sourceFolder.folderRoot),n.$set(f);const p={};1&h&&(p.sourceFolder=u[0].sourceFolder),a.$set(p)},i(u){c||($(s.$$.fragment,u),$(n.$$.fragment,u),$(a.$$.fragment,u),c=!0)},o(u){C(s.$$.fragment,u),C(n.$$.fragment,u),C(a.$$.fragment,u),c=!1},d(u){u&&N(t),T(s),T(n),T(a)}}}function el(r){let t,e,s,i;return t=new sa({}),s=new Tt({props:{filepath:r[0].externalSource.name}}),{c(){E(t.$$.fragment),e=Z(),E(s.$$.fragment)},m(n,o){k(t,n,o),O(n,e,o),k(s,n,o),i=!0},p(n,o){const a={};1&o&&(a.filepath=n[0].externalSource.name),s.$set(a)},i(n){i||($(t.$$.fragment,n),$(s.$$.fragment,n),i=!0)},o(n){C(t.$$.fragment,n),C(s.$$.fragment,n),i=!1},d(n){n&&N(e),T(t,n),T(s,n)}}}function sl(r){let t,e,s,i;return t=new Wo({}),s=new Tt({props:{filepath:r[0].folder.pathName}}),{c(){E(t.$$.fragment),e=Z(),E(s.$$.fragment)},m(n,o){k(t,n,o),O(n,e,o),k(s,n,o),i=!0},p(n,o){const a={};1&o&&(a.filepath=n[0].folder.pathName),s.$set(a)},i(n){i||($(t.$$.fragment,n),$(s.$$.fragment,n),i=!0)},o(n){C(t.$$.fragment,n),C(s.$$.fragment,n),i=!1},d(n){n&&N(e),T(t,n),T(s,n)}}}function il(r){let t,e,s,i;return t=new wr({}),s=new Tt({props:{filepath:r[0].recentFile.pathName}}),{c(){E(t.$$.fragment),e=Z(),E(s.$$.fragment)},m(n,o){k(t,n,o),O(n,e,o),k(s,n,o),i=!0},p(n,o){const a={};1&o&&(a.filepath=n[0].recentFile.pathName),s.$set(a)},i(n){i||($(t.$$.fragment,n),$(s.$$.fragment,n),i=!0)},o(n){C(t.$$.fragment,n),C(s.$$.fragment,n),i=!1},d(n){n&&N(e),T(t,n),T(s,n)}}}function nl(r){let t,e,s,i;return t=new wr({}),s=new Tt({props:{filepath:r[0].file.pathName}}),{c(){E(t.$$.fragment),e=Z(),E(s.$$.fragment)},m(n,o){k(t,n,o),O(n,e,o),k(s,n,o),i=!0},p(n,o){const a={};1&o&&(a.filepath=n[0].file.pathName),s.$set(a)},i(n){i||($(t.$$.fragment,n),$(s.$$.fragment,n),i=!0)},o(n){C(t.$$.fragment,n),C(s.$$.fragment,n),i=!1},d(n){n&&N(e),T(t,n),T(s,n)}}}function rl(r){let t,e,s;var i=ti(r[0].personality.type);return i&&(t=rs(i,{})),{c(){t&&E(t.$$.fragment),e=ne()},m(n,o){t&&k(t,n,o),O(n,e,o),s=!0},p(n,o){if(1&o&&i!==(i=ti(n[0].personality.type))){if(t){vt();const a=t;C(a.$$.fragment,1,0,()=>{T(a,1)}),$t()}i?(t=rs(i,{}),E(t.$$.fragment),$(t.$$.fragment,1),k(t,e.parentNode,e)):t=null}},i(n){s||(t&&$(t.$$.fragment,n),s=!0)},o(n){t&&C(t.$$.fragment,n),s=!1},d(n){n&&N(e),t&&T(t,n)}}}function ol(r){let t,e=r[0].label+"";return{c(){t=pt(e)},m(s,i){O(s,t,i)},p(s,i){1&i&&e!==(e=s[0].label+"")&&Yt(t,e)},d(s){s&&N(t)}}}function al(r){let t,e=r[0].personality.description+"";return{c(){t=pt(e)},m(s,i){O(s,t,i)},p(s,i){1&i&&e!==(e=s[0].personality.description+"")&&Yt(t,e)},d(s){s&&N(t)}}}function sr(r){let t,e,s,i;const n=[ll,cl],o=[];function a(c,u){var h;return(h=c[0].rulesAndGuidelinesState)!=null&&h.overLimit?0:c[0].userGuidelines.overLimit?1:-1}return~(t=a(r))&&(e=o[t]=n[t](r)),{c(){e&&e.c(),s=ne()},m(c,u){~t&&o[t].m(c,u),O(c,s,u),i=!0},p(c,u){let h=t;t=a(c),t===h?~t&&o[t].p(c,u):(e&&(vt(),C(o[h],1,1,()=>{o[h]=null}),$t()),~t?(e=o[t],e?e.p(c,u):(e=o[t]=n[t](c),e.c()),$(e,1),e.m(s.parentNode,s)):e=null)},i(c){i||($(e),i=!0)},o(c){C(e),i=!1},d(c){c&&N(s),~t&&o[t].d(c)}}}function cl(r){let t,e;return t=new Gs({props:{size:1,$$slots:{default:[hl]},$$scope:{ctx:r}}}),{c(){E(t.$$.fragment)},m(s,i){k(t,s,i),e=!0},p(s,i){const n={};3&i&&(n.$$scope={dirty:i,ctx:s}),t.$set(n)},i(s){e||($(t.$$.fragment,s),e=!0)},o(s){C(t.$$.fragment,s),e=!1},d(s){T(t,s)}}}function ll(r){let t,e;return t=new Gs({props:{size:1,$$slots:{default:[ul]},$$scope:{ctx:r}}}),{c(){E(t.$$.fragment)},m(s,i){k(t,s,i),e=!0},p(s,i){const n={};3&i&&(n.$$scope={dirty:i,ctx:s}),t.$set(n)},i(s){e||($(t.$$.fragment,s),e=!0)},o(s){C(t.$$.fragment,s),e=!1},d(s){T(t,s)}}}function hl(r){let t,e=`Guidelines exceeded length limit of ${r[0].userGuidelines.lengthLimit} characters`;return{c(){t=pt(e)},m(s,i){O(s,t,i)},p(s,i){1&i&&e!==(e=`Guidelines exceeded length limit of ${s[0].userGuidelines.lengthLimit} characters`)&&Yt(t,e)},d(s){s&&N(t)}}}function ul(r){let t,e=`Rules and workspace guidelines (${r[0].rulesAndGuidelinesState.totalCharacterCount} chars)
          exceeded limit of ${r[0].rulesAndGuidelinesState.lengthLimit} characters, remove some rules
          or reduce the length of your guidelines.`;return{c(){t=pt(e)},m(s,i){O(s,t,i)},p(s,i){1&i&&e!==(e=`Rules and workspace guidelines (${s[0].rulesAndGuidelinesState.totalCharacterCount} chars)
          exceeded limit of ${s[0].rulesAndGuidelinesState.lengthLimit} characters, remove some rules
          or reduce the length of your guidelines.`)&&Yt(t,e)},d(s){s&&N(t)}}}function dl(r){let t,e,s,i,n,o,a,c,u,h,f,p,_;const b=[nl,il,sl,el,tl,Yc,Jc,Xc,Zc,Qc],S=[];function x(m,y){return 1&y&&(e=null),1&y&&(s=null),1&y&&(i=null),1&y&&(n=null),1&y&&(o=null),1&y&&(a=null),1&y&&(c=null),1&y&&(u=null),1&y&&(h=null),e==null&&(e=!(!m[0]||!Ki(m[0]))),e?0:(s==null&&(s=!(!m[0]||!Bs(m[0]))),s?1:(i==null&&(i=!(!m[0]||!Qi(m[0]))),i?2:(n==null&&(n=!(!m[0]||!Zi(m[0]))),n?3:(o==null&&(o=!(!m[0]||!Qs(m[0]))),o?4:(a==null&&(a=!(!m[0]||!Zs(m[0]))),a?5:(c==null&&(c=!(!m[0]||!Ks(m[0]))),c?6:(u==null&&(u=!(!m[0]||!ei(m[0]))),u?7:(h==null&&(h=!(!m[0]||!Xs(m[0]))),h?8:9))))))))}return f=x(r,-1),p=S[f]=b[f](r),{c(){t=Y("div"),p.c(),Q(t,"class","c-mention-hover-contents svelte-11069rs")},m(m,y){O(m,t,y),S[f].m(t,null),_=!0},p(m,[y]){let M=f;f=x(m,y),f===M?S[f].p(m,y):(vt(),C(S[M],1,1,()=>{S[M]=null}),$t(),p=S[f],p?p.p(m,y):(p=S[f]=b[f](m),p.c()),$(p,1),p.m(t,null))},i(m){_||($(p),_=!0)},o(m){C(p),_=!1},d(m){m&&N(t),S[f].d()}}}function fl(r,t,e){let{option:s}=t;return r.$$set=i=>{"option"in i&&e(0,s=i.option)},[s]}class pl extends Pe{constructor(t){super(),He(this,t,fl,dl,ze,{option:0})}}function ir(r,t,e){const s=r.slice();return s[15]=t[e],s}function nr(r){let t,e;function s(){return r[8](r[15])}return t=new Kc({props:{item:r[15],highlight:r[15]===r[14],onSelect:s}}),{c(){E(t.$$.fragment)},m(i,n){k(t,i,n),e=!0},p(i,n){r=i;const o={};4&n&&(o.item=r[15]),16388&n&&(o.highlight=r[15]===r[14]),4&n&&(o.onSelect=s),t.$set(o)},i(i){e||($(t.$$.fragment,i),e=!0)},o(i){C(t.$$.fragment,i),e=!1},d(i){T(t,i)}}}function gl(r){let t,e,s=Vs(r[2]),i=[];for(let o=0;o<s.length;o+=1)i[o]=nr(ir(r,s,o));const n=o=>C(i[o],1,1,()=>{i[o]=null});return{c(){for(let o=0;o<i.length;o+=1)i[o].c();t=ne()},m(o,a){for(let c=0;c<i.length;c+=1)i[c]&&i[c].m(o,a);O(o,t,a),e=!0},p(o,a){if(16420&a){let c;for(s=Vs(o[2]),c=0;c<s.length;c+=1){const u=ir(o,s,c);i[c]?(i[c].p(u,a),$(i[c],1)):(i[c]=nr(u),i[c].c(),$(i[c],1),i[c].m(t.parentNode,t))}for(vt(),c=s.length;c<i.length;c+=1)n(c);$t()}},i(o){if(!e){for(let a=0;a<s.length;a+=1)$(i[a]);e=!0}},o(o){i=i.filter(Boolean);for(let a=0;a<i.length;a+=1)C(i[a]);e=!1},d(o){o&&N(t),mr(i,o)}}}function ml(r){let t,e;return t=new pl({props:{slot:"mentionable",option:r[13]}}),{c(){E(t.$$.fragment)},m(s,i){k(t,s,i),e=!0},p(s,i){const n={};8192&i&&(n.option=s[13]),t.$set(n)},i(s){e||($(t.$$.fragment,s),e=!0)},o(s){C(t.$$.fragment,s),e=!1},d(s){T(t,s)}}}function _l(r){let t,e,s,i;return t=new Ei.Menu.Root({props:{mentionables:r[2],onQueryUpdate:r[4],onSelectMentionable:r[5],$$slots:{default:[gl,({activeItem:n})=>({14:n}),({activeItem:n})=>n?16384:0]},$$scope:{ctx:r}}}),s=new Ei.ChipTooltip({props:{$$slots:{mentionable:[ml,({mentionable:n})=>({13:n}),({mentionable:n})=>n?8192:0]},$$scope:{ctx:r}}}),{c(){E(t.$$.fragment),e=Z(),E(s.$$.fragment)},m(n,o){k(t,n,o),O(n,e,o),k(s,n,o),i=!0},p(n,o){const a={};4&o&&(a.mentionables=n[2]),278532&o&&(a.$$scope={dirty:o,ctx:n}),t.$set(a);const c={};270336&o&&(c.$$scope={dirty:o,ctx:n}),s.$set(c)},i(n){i||($(t.$$.fragment,n),$(s.$$.fragment,n),i=!0)},o(n){C(t.$$.fragment,n),C(s.$$.fragment,n),i=!1},d(n){n&&N(e),T(t,n),T(s,n)}}}function yl(r){let t,e,s={triggerCharacter:"@",onMentionItemsUpdated:r[0],$$slots:{default:[_l]},$$scope:{ctx:r}};return t=new Ei.Root({props:s}),r[9](t),{c(){E(t.$$.fragment)},m(i,n){k(t,i,n),e=!0},p(i,[n]){const o={};1&n&&(o.onMentionItemsUpdated=i[0]),262148&n&&(o.$$scope={dirty:n,ctx:i}),t.$set(o)},i(i){e||($(t.$$.fragment,i),e=!0)},o(i){C(t.$$.fragment,i),e=!1},d(i){r[9](null),T(t,i)}}}function vl(r,t,e){let s,{requestEditorFocus:i}=t,{onMentionItemsUpdated:n}=t;const o=$o("chatModel");if(!o)throw new Error("ChatModel not found in context");const a=new Wi(o,h),c=a.displayItems;let u;function h(p){return!!u&&(u.insertMention(p),a.closeDropdown(),!0)}function f(p){const _=a.selectMentionable(p);return i(),_}return je(r,c,p=>e(2,s=p)),Bi(()=>{a.dispose()}),r.$$set=p=>{"requestEditorFocus"in p&&e(6,i=p.requestEditorFocus),"onMentionItemsUpdated"in p&&e(0,n=p.onMentionItemsUpdated)},[n,u,s,c,function(p){p===void 0?a.closeDropdown():(a.openDropdown(),a.userQuery.set(p))},f,i,p=>h(p),p=>f(p),function(p){Je[p?"unshift":"push"](()=>{u=p,e(1,u)})}]}class $l extends Pe{constructor(t){super(),He(this,t,vl,yl,ze,{requestEditorFocus:6,onMentionItemsUpdated:0,insertMentionNode:7})}get insertMentionNode(){return this.$$.ctx[7]}}function rr(r){let t,e,s,i,n,o,a,c,u,h,f,p,_,b,S={focusOnInit:!0,$$slots:{default:[bl]},$$scope:{ctx:r}};return o=new Ir.Root({props:S}),r[25](o),u=new Me({props:{id:"close",size:1,variant:"soft",color:"neutral",title:"Close",$$slots:{default:[Cl]},$$scope:{ctx:r}}}),u.$on("click",function(){de(r[0].disposeDiffViewPanel)&&r[0].disposeDiffViewPanel.apply(this,arguments)}),f=new Me({props:{id:"send",size:1,variant:"solid",color:"accent",title:r[3]===Ie.instruction?"Instruct Augment":"Edit with Augment",disabled:!r[4].trim()||r[11],$$slots:{iconRight:[xl],default:[Sl]},$$scope:{ctx:r}}}),f.$on("click",r[14]),{c(){t=Y("div"),e=Z(),s=Y("div"),i=Y("div"),n=Y("div"),E(o.$$.fragment),a=Z(),c=Y("div"),E(u.$$.fragment),h=Z(),E(f.$$.fragment),Q(n,"class","l-input-area__input svelte-1cxscce"),Q(c,"class","c-instruction-drawer-panel__btn-container svelte-1cxscce"),Q(i,"class","instruction-drawer-panel__contents svelte-1cxscce"),Q(i,"tabindex","0"),Q(i,"role","button"),Q(s,"class","instruction-drawer-panel svelte-1cxscce"),Xe(s,"top",r[5]+"px"),Xe(s,"height",r[6]+"px")},m(x,m){O(x,t,m),O(x,e,m),O(x,s,m),tt(s,i),tt(i,n),k(o,n,null),r[26](n),tt(i,a),tt(i,c),k(u,c,null),tt(c,h),k(f,c,null),p=!0,_||(b=[pr(r[15].call(null,t)),we(i,"click",r[17]),we(i,"keydown",r[27])],_=!0)},p(x,m){r=x;const y={};1296&m[0]|256&m[1]&&(y.$$scope={dirty:m,ctx:r}),o.$set(y);const M={};256&m[1]&&(M.$$scope={dirty:m,ctx:r}),u.$set(M);const F={};8&m[0]&&(F.title=r[3]===Ie.instruction?"Instruct Augment":"Edit with Augment"),2064&m[0]&&(F.disabled=!r[4].trim()||r[11]),8&m[0]|256&m[1]&&(F.$$scope={dirty:m,ctx:r}),f.$set(F),(!p||32&m[0])&&Xe(s,"top",r[5]+"px"),(!p||64&m[0])&&Xe(s,"height",r[6]+"px")},i(x){p||($(o.$$.fragment,x),$(u.$$.fragment,x),$(f.$$.fragment,x),p=!0)},o(x){C(o.$$.fragment,x),C(u.$$.fragment,x),C(f.$$.fragment,x),p=!1},d(x){x&&(N(t),N(e),N(s)),r[25](null),T(o),r[26](null),T(u),T(f),_=!1,Vi(b)}}}function bl(r){let t,e,s,i,n,o,a,c;t=new ia({props:{shortcuts:{Enter:r[23]}}});let u={requestEditorFocus:r[16],onMentionItemsUpdated:r[18]};return s=new $l({props:u}),r[24](s),n=new Ir.Content({props:{content:r[4],onContentChanged:r[19]}}),a=new na({props:{placeholder:r[10]}}),{c(){E(t.$$.fragment),e=Z(),E(s.$$.fragment),i=Z(),E(n.$$.fragment),o=Z(),E(a.$$.fragment)},m(h,f){k(t,h,f),O(h,e,f),k(s,h,f),O(h,i,f),k(n,h,f),O(h,o,f),k(a,h,f),c=!0},p(h,f){s.$set({});const p={};16&f[0]&&(p.content=h[4]),n.$set(p);const _={};1024&f[0]&&(_.placeholder=h[10]),a.$set(_)},i(h){c||($(t.$$.fragment,h),$(s.$$.fragment,h),$(n.$$.fragment,h),$(a.$$.fragment,h),c=!0)},o(h){C(t.$$.fragment,h),C(s.$$.fragment,h),C(n.$$.fragment,h),C(a.$$.fragment,h),c=!1},d(h){h&&(N(e),N(i),N(o)),T(t,h),r[24](null),T(s,h),T(n,h),T(a,h)}}}function Cl(r){let t,e,s;return e=new We({props:{keybinding:"esc"}}),{c(){t=pt(`Close
          `),E(e.$$.fragment)},m(i,n){O(i,t,n),k(e,i,n),s=!0},p:J,i(i){s||($(e.$$.fragment,i),s=!0)},o(i){C(e.$$.fragment,i),s=!1},d(i){i&&N(t),T(e,i)}}}function Sl(r){let t,e=r[3]===Ie.instruction?"Instruct":"Edit";return{c(){t=pt(e)},m(s,i){O(s,t,i)},p(s,i){8&i[0]&&e!==(e=s[3]===Ie.instruction?"Instruct":"Edit")&&Yt(t,e)},d(s){s&&N(t)}}}function xl(r){let t,e;return t=new Go({props:{slot:"iconRight"}}),{c(){E(t.$$.fragment)},m(s,i){k(t,s,i),e=!0},p:J,i(s){e||($(t.$$.fragment,s),e=!0)},o(s){C(t.$$.fragment,s),e=!1},d(s){T(t,s)}}}function wl(r){let t,e,s=r[2]&&rr(r);return{c(){s&&s.c(),t=ne()},m(i,n){s&&s.m(i,n),O(i,t,n),e=!0},p(i,n){i[2]?s?(s.p(i,n),4&n[0]&&$(s,1)):(s=rr(i),s.c(),$(s,1),s.m(t.parentNode,t)):s&&(vt(),C(s,1,1,()=>{s=null}),$t())},i(i){e||($(s),e=!0)},o(i){C(s),e=!1},d(i){i&&N(t),s&&s.d(i)}}}function Ml(r,t,e){let s,i,n,o,a,c,u=J,h=()=>(u(),u=ue(p,U=>e(22,o=U)),p),f=J;r.$$.on_destroy.push(()=>u()),r.$$.on_destroy.push(()=>f());let{diffViewModel:p}=t;h();let{initialConversation:_}=t,{initialFlags:b}=t;const S=ra.getContext().monaco,x={isWholeLine:!0,marginClassName:"instruction-edit-area-margin"},m=new Sr(gs);let y=new Nr;m.registerConsumer(y);let M=new Xi(m,gs,y,{initialConversation:_,initialFlags:b});const F=M.currentConversationModel;let R,nt;m.registerConsumer(M),function(U){bo("chatModel",U)}(M);let H,G="";const P=p.mode;je(r,P,U=>e(3,a=U));const bt=p.selectionLines;function ut(){const U=p.getModifiedEditor(),ke=lt(S);if(!U||!ke||(H==null||H.clear(),!n))return;const Ge=n.start,as=n.end,$s={range:new ke.Range(Ge+1,1,as+1,1),options:x};H||(H=U.createDecorationsCollection()),H.set([$s])}function Mt(){return!!(G!=null&&G.trim())&&(p.handleInstructionSubmit(G),!0)}je(r,bt,U=>e(2,n=U)),_r(async()=>{await wi(),At(),e(5,Ut=p.editorOffset)}),Bi(()=>{R==null||R.destroy(),H==null||H.clear()});let B,z,Ut=0,Ee=57;const At=()=>B==null?void 0:B.forceFocus();return r.$$set=U=>{"diffViewModel"in U&&h(e(0,p=U.diffViewModel)),"initialConversation"in U&&e(20,_=U.initialConversation),"initialFlags"in U&&e(21,b=U.initialFlags)},r.$$.update=()=>{if(8&r.$$.dirty[0]&&e(10,s=(a===Ie.instruction?"Instruct":"Edit with")+" Augment... @ to focus on files or docs"),4194304&r.$$.dirty[0]&&(e(9,i=o.isLoading),f(),f=ue(i,U=>e(11,c=U))),6&r.$$.dirty[0]&&nt){if(n==null)e(6,Ee=0);else{const U=nt.scrollHeight;e(6,Ee=Math.min(40+U,108))}R==null||R.update({heightInPx:Ee}),ut()}},[p,nt,n,a,G,Ut,Ee,B,z,i,s,c,P,bt,Mt,function(U){if(U){const ke=n?n.start:1;R=p.renderInstructionsDrawerViewZone(U,{line:ke,heightInPx:Ee,onDomNodeTop:Ge=>{e(5,Ut=p.editorOffset+Ge)},autoFocus:!0}),ut()}},()=>B==null?void 0:B.requestFocus(),At,U=>{F.saveDraftMentions(U.current)},function(U){e(4,G=U.rawText)},_,b,o,()=>Mt(),function(U){Je[U?"unshift":"push"](()=>{z=U,e(8,z)})},function(U){Je[U?"unshift":"push"](()=>{B=U,e(7,B)})},function(U){Je[U?"unshift":"push"](()=>{nt=U,e(1,nt)})},U=>{U.key==="Enter"&&(At(),U.stopPropagation(),U.preventDefault())}]}class Il extends Pe{constructor(t){super(),He(this,t,Ml,wl,ze,{diffViewModel:0,initialConversation:20,initialFlags:21},null,[-1,-1])}}const{window:xi}=Mo;function or(r,t,e){const s=r.slice();return s[17]=t[e],s[19]=e,s}function ar(r){let t,e,s,i,n;return e=new Ka({props:{diffViewModel:r[3]}}),i=new Il({props:{diffViewModel:r[3]}}),{c(){t=Y("div"),E(e.$$.fragment),s=Z(),E(i.$$.fragment),Q(t,"class","sticky-top svelte-453n6i")},m(o,a){O(o,t,a),k(e,t,null),O(o,s,a),k(i,o,a),n=!0},p(o,a){const c={};8&a&&(c.diffViewModel=o[3]),e.$set(c);const u={};8&a&&(u.diffViewModel=o[3]),i.$set(u)},i(o){n||($(e.$$.fragment,o),$(i.$$.fragment,o),n=!0)},o(o){C(e.$$.fragment,o),C(i.$$.fragment,o),n=!1},d(o){o&&(N(t),N(s)),T(e),T(i,o)}}}function cr(r){let t,e,s=Vs(r[4]),i=[];for(let o=0;o<s.length;o+=1)i[o]=hr(or(r,s,o));const n=o=>C(i[o],1,1,()=>{i[o]=null});return{c(){for(let o=0;o<i.length;o+=1)i[o].c();t=ne()},m(o,a){for(let c=0;c<i.length;c+=1)i[c]&&i[c].m(o,a);O(o,t,a),e=!0},p(o,a){if(280&a){let c;for(s=Vs(o[4]),c=0;c<s.length;c+=1){const u=or(o,s,c);i[c]?(i[c].p(u,a),$(i[c],1)):(i[c]=hr(u),i[c].c(),$(i[c],1),i[c].m(t.parentNode,t))}for(vt(),c=s.length;c<i.length;c+=1)n(c);$t()}},i(o){if(!e){for(let a=0;a<s.length;a+=1)$(i[a]);e=!0}},o(o){i=i.filter(Boolean);for(let a=0;a<i.length;a+=1)C(i[a]);e=!1},d(o){o&&N(t),mr(i,o)}}}function lr(r){var n;let t,e;function s(){return r[14](r[17])}function i(){return r[15](r[17])}return t=new Da({props:{isFocused:((n=r[3])==null?void 0:n.currFocusedChunkIdx)===r[19],onAccept:s,onReject:i,diffViewModel:r[3],leaf:r[17],align:"right",disableApply:r[8]}}),{c(){E(t.$$.fragment)},m(o,a){k(t,o,a),e=!0},p(o,a){var u;r=o;const c={};8&a&&(c.isFocused=((u=r[3])==null?void 0:u.currFocusedChunkIdx)===r[19]),24&a&&(c.onAccept=s),24&a&&(c.onReject=i),8&a&&(c.diffViewModel=r[3]),16&a&&(c.leaf=r[17]),256&a&&(c.disableApply=r[8]),t.$set(c)},i(o){e||($(t.$$.fragment,o),e=!0)},o(o){C(t.$$.fragment,o),e=!1},d(o){T(t,o)}}}function hr(r){let t,e,s=r[17].unitOfCodeWork.modifiedCode!==r[17].unitOfCodeWork.originalCode&&lr(r);return{c(){s&&s.c(),t=ne()},m(i,n){s&&s.m(i,n),O(i,t,n),e=!0},p(i,n){i[17].unitOfCodeWork.modifiedCode!==i[17].unitOfCodeWork.originalCode?s?(s.p(i,n),16&n&&$(s,1)):(s=lr(i),s.c(),$(s,1),s.m(t.parentNode,t)):s&&(vt(),C(s,1,1,()=>{s=null}),$t())},i(i){e||($(s),e=!0)},o(i){C(s),e=!1},d(i){i&&N(t),s&&s.d(i)}}}function El(r){var u;let t,e,s,i,n,o,a=r[3]&&ar(r),c=r[3]&&((u=r[4])==null?void 0:u.length)&&!r[7]&&cr(r);return{c(){t=Y("div"),a&&a.c(),e=Z(),s=Y("div"),i=Y("div"),n=Z(),c&&c.c(),Q(i,"class","editor svelte-453n6i"),Q(s,"class","editor-container svelte-453n6i"),Q(t,"class","diff-view-container svelte-453n6i")},m(h,f){O(h,t,f),a&&a.m(t,null),tt(t,e),tt(t,s),tt(s,i),r[13](i),tt(s,n),c&&c.m(s,null),o=!0},p(h,f){var p;h[3]?a?(a.p(h,f),8&f&&$(a,1)):(a=ar(h),a.c(),$(a,1),a.m(t,e)):a&&(vt(),C(a,1,1,()=>{a=null}),$t()),h[3]&&((p=h[4])!=null&&p.length)&&!h[7]?c?(c.p(h,f),152&f&&$(c,1)):(c=cr(h),c.c(),$(c,1),c.m(s,null)):c&&(vt(),C(c,1,1,()=>{c=null}),$t())},i(h){o||($(a),$(c),o=!0)},o(h){C(a),C(c),o=!1},d(h){h&&N(t),a&&a.d(),r[13](null),c&&c.d()}}}function kl(r){let t,e,s,i;return t=new oa.Root({props:{$$slots:{default:[El]},$$scope:{ctx:r}}}),{c(){E(t.$$.fragment)},m(n,o){k(t,n,o),e=!0,s||(i=[we(xi,"message",function(){var a,c;de((a=r[0])==null?void 0:a.handleMessageFromExtension)&&((c=r[0])==null||c.handleMessageFromExtension.apply(this,arguments))}),we(xi,"focus",r[11]),we(xi,"blur",r[12])],s=!0)},p(n,[o]){r=n;const a={};1048986&o&&(a.$$scope={dirty:o,ctx:r}),t.$set(a)},i(n){e||($(t.$$.fragment,n),e=!0)},o(n){C(t.$$.fragment,n),e=!1},d(n){T(t,n),s=!1,Vi(i)}}}function Tl(r,t,e){let s,i,n,o,a,c,u,h,f,p,_=J,b=J,S=J;function x(y){const M=So.dark;return aa((y==null?void 0:y.category)||M,y==null?void 0:y.intensity)??ca.get(M)}je(r,Co,y=>e(10,a=y)),r.$$.on_destroy.push(()=>_()),r.$$.on_destroy.push(()=>b()),r.$$.on_destroy.push(()=>S()),_r(async()=>{e(9,p=await window.augmentDeps.monaco),p||console.error("Monaco not loaded. Diff view cannot be initialized.")}),Bi(()=>{h==null||h.dispose()});let m=!1;return r.$$.update=()=>{if(1539&r.$$.dirty&&p&&f&&!h&&(e(0,h=new Ta(f,x(a),p)),_(),_=ue(h,y=>e(3,o=y))),1&r.$$.dirty&&(e(6,s=h==null?void 0:h.disableApply),S(),S=ue(s,y=>e(8,u=y))),1&r.$$.dirty&&(e(5,i=h==null?void 0:h.disableResolution),b(),b=ue(i,y=>e(7,c=y))),1025&r.$$.dirty){const y=a;h&&(h==null||h.updateTheme(x(y)))}8&r.$$.dirty&&e(4,n=o==null?void 0:o.leaves),5&r.$$.dirty&&(h==null||h.updateIsWebviewFocused(m))},[h,f,m,o,n,i,s,c,u,p,a,()=>e(2,m=!0),()=>e(2,m=!1),function(y){Je[y?"unshift":"push"](()=>{f=y,e(1,f)})},y=>o==null?void 0:o.acceptChunk(y),y=>o==null?void 0:o.rejectChunk(y)]}new class extends Pe{constructor(r){super(),He(this,r,Tl,kl,ze,{})}}({target:document.getElementById("app")});
